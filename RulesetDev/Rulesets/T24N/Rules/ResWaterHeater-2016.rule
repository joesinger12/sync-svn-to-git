// Residential Water Heaters
// For Space Types equal to High-Rise Residential and Hotel / Motel
//
// -------------------------------------------------------------------------
//  Copyright (c) 2012-2018, California Energy Commission
//  All rights reserved.
//  Redistribution and use in source and binary forms, with or without
//  modification, are permitted provided that the following conditions are
//  met:
// 
//    * Redistributions of source code must retain the above copyright
//  notice, this list of conditions and the following disclaimer.
//    * Redistributions in binary form must reproduce the above copyright
//  notice, this list of conditions and the following disclaimer in
//  the documentation and/or other materials provided with the
//  distribution.
//    * Neither the name of the California Energy Commission nor the names of its
//  contributors may be used to endorse or promote products
//  derived from this software without specific prior written
//  permission.
//
//  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS
//  IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED
//  TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A
//  PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL CALIFORNIA ENERGY COMMISSION
//  BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
//  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
//  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR
//  BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
//  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR
//  OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
//  ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
// -------------------------------------------------------------------------
//  
//

// -----------------------------------------------------------------------------
// ---------- Baseline Residential DHW System Flag -----------------------------
RULE ResDHWSys:IsBaseSys
  DESCRIPTION
    "An integer value used to identify that this water heating system is a baseline system."
  INPUTCLASS 
    NotInput
  DEFAULT
    0 
ENDRULE

// ---------- Residential DHW System Status -------------------------------
RULE ResDHWSys:Status
  DESCRIPTION
    "The status of the system or component, used for additions and alterations."
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    Required
  DEFAULT
    if( IfValidAnd( SumChildren(ResWtrHtr:IsNewResDHWHtr) > 0 ) .AND.
        IfValidAnd( SumChildren(ResWtrHtr:IsExistingDHWHtr) > 0 ) )
    then 
      "Altered"
    else if( Proj:IsAlt )
    then 
      "Existing"
    else 
      "New"
    endif endif
  CHECKCODE           // Status
    if( CentralSys = 0 .AND. Status = "Altered" ) 
    then
      PostError("Residential DHW system '%s' is specified as non-central, and 
                 has a status of Altered.  This is not allowed.  Individual 
                 dwelling unit DHW systems may be only New or Existing.  Change 
                 the status input.",Name)
    else if( IfValidAnd( SumChildren(ResWtrHtr:IsNewResDHWHtr) > 0 ) .AND.
             IfValidAnd( SumChildren(ResWtrHtr:IsExistingDHWHtr) > 0 ) )
    then
      PostError("Residential DHW system '%s' has a mix of New and Existing 
                 water heaters, so the status must be Altered.  Change 
                 the status input.",Name)
    else UNCHANGED
    endif endif
ENDRULE

// -----------------------------------------------------------------------------
RULE NEW ResDHWSys:IsNewResDHWSys
  DATATYPE
    Integer
  LONGFORM
    IsNewResidentialDomesticHotWaterSystem
  INPUTCLASS
    NotInput
  DEFAULT
    if( Status = "New" ) then 1 else 0 endif
ENDRULE

// -----------------------------------------------------------------------------
RULE NEW ResDHWSys:IsAlteredResDHWSys
  DATATYPE
    Integer
  LONGFORM
    IsAlteredResidentialDomesticHotWaterSystem
  INPUTCLASS
    NotInput
  DEFAULT
    if( Status = "Altered" ) then 1 else 0 endif
ENDRULE

// -----------------------------------------------------------------------------
RULE NEW ResDHWSys:IsExistingResDHWSys
  DATATYPE
    Integer
  LONGFORM
    IsExistingResidentialDomesticHotWaterSystem
  INPUTCLASS
    NotInput
  DEFAULT
    if( Status = "Existing" ) then 1 else 0 endif
ENDRULE

// -----------------------------------------------------------------------------
// ---------- Residential Water Heater Status -------------------------------
RULE ResWtrHtr:Status
  DESCRIPTION
    "The status of the system or component, used for additions and alterations."
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    Required
  DEFAULT
    if( Parent(Status) = "Altered" ) 
    then "New"
    else Parent(Status)
    endif
ENDRULE

// -----------------------------------------------------------------------------
RULE NEW ResWtrHtr:IsNewResDHWHtr
  DATATYPE
    Integer
  LONGFORM
    IsNewResidentialDomesticHotWaterHeater
  INPUTCLASS
    NotInput
  DEFAULT
    if( Status = "New" ) then 1 else 0 endif
ENDRULE

// -----------------------------------------------------------------------------
RULE NEW ResWtrHtr:IsExistingDHWHtr
  DATATYPE
    Integer
  LONGFORM
    IsExistingDHWHeater
  INPUTCLASS
    NotInput
  DEFAULT
    if( Status = "Existing" ) then 1 else 0 endif
ENDRULE

// -----------------------------------------------------------------------------
// ---------- Any DHW Fluid Systems in the Building Are New --------------
RULE NEW Proj:IsNewResDHWSys
  DATATYPE
    Integer
  LONGFORM
    IsNewResidentialDomesticHotWaterSystem
  DESCRIPTION
    "This is the boolean for yes(1) all DHW fluid systems are new
     or no (0), not all of the DHW fluid systems are new."
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    NotInput
  DEFAULT
    if( SumAll(ResDHWSys:IsExistingResDHWSys) + 
//        SumAll(ResDHWSys:IsAlteredResDHWSys) > 0 )
        SumAll(ResDHWSys:IsAlteredResDHWSys) <= 0 )                 
    then 1
    else 0
    endif
ENDRULE

// -----------------------------------------------------------------------------
// ---------- All Water Heaters in the building are New --------------
RULE NEW Proj:IsNewResDHWHtr
  DATATYPE
    Integer
  LONGFORM
    IsNewResidentialDomesticHotWaterHeater
  DESCRIPTION
    "This is the boolean for yes(1) all water heaters on the fluid system are new
     or no (0), not all of the water heaters on the fluid system are new."
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    NotInput
  DEFAULT
//    if( SumAll(ResWtrHtr:IsExistingDHWHtr) > 0 )
    if( SumAll(ResWtrHtr:IsExistingDHWHtr) <= 0 )   
    then 1
    else 0
    endif
ENDRULE

// -----------------------------------------------------------------------------
// ---------- Any DHW Fluid Systems in the Building Are Existing --------------
RULE NEW Proj:IsNewDHWFluidSys
  DATATYPE
    Integer
  LONGFORM
    IsNewDHWFluidSystem
  DESCRIPTION
    "This is the boolean for yes(1) one DHW Fluid Systems in the building is new
     or no (0), none of the SHW Fluid Systems in the building are new."
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    NotInput
  DEFAULT
    if( Proj:IsNewResDHWSys > 0 .OR. Proj:IsNewResDHWHtr > 0 )
    then 1
    else 0
    endif
ENDRULE

// -----------------------------------------------------------------------------
// -------------- Water Heater Count (default exression only) --------------------
// - moved default expression up here to ensure it is valid prior to several references prior to the main ResWtrHtr:Cnt RULE
RULE ResWtrHtr:Cnt
  DEFAULT
    1
ENDRULE

// -----------------------------------------------------------------------------
// ---------- New Residential Water Heater Count in Building --------------
RULE NEW ResWtrHtr:NewResDHWHtr
  DATATYPE
    Integer
  LONGFORM
    NewInBuilding
  DESCRIPTION
    "This is the count of new Residential Water Heaters in the building."
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    NotInput
  DEFAULT
    if( IsNewResDHWHtr .AND. IfValidAnd(Cnt > 0) )
    then Cnt
    else 0
    endif
ENDRULE

// -----------------------------------------------------------------------------
//// ---------- Create baseline Residential Water Heater -------------------------------
//RULE ResDHWSys:BaseResWtrHtrRef
//  DESCRIPTION
//    "This is the baseline water heater."
//  HELP
//    ""
//  REFERENCE 
//    Res ACM-2.10 Domestic Hot Water
//  INPUTCLASS
//    Optional
//  SIZING_PROPOSED
//    UNDEFINED
//  SIZING_BASELINE
//    UNDEFINED
//// SAC 6/4/15 - removed retrieval of BaseResWtrHtr from library, as ResWtrHtr properties are being modified individually
////    if( u:IsNew )
////    then RuleLibrary(ResWtrHtr, "BaseResWtrHtr", 1, Name)
////    else UNDEFINED
////    endif
//  ANNUAL_PROPOSED
//    UNDEFINED
//  ANNUAL_BASELINE 
//    zb:BaseResWtrHtrRef
//ENDRULE


// -----------------------------------------------------------------------------
// ---------- Residential Domestic Hot Water Fluid System Name --------------
RULE ResDHWSys:Name
  DESCRIPTION
    "A unique name for each Residential water heating system."
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    Optional
ENDRULE


// -----------------------------------------------------------------------------
// ----------- Floor area served by an individual residential System -----------------
RULE ResDHWSys:SysFlrArea
  DESCRIPTION
    "This is the total floor area of all living units served by the DHW system."
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    NotInput
  MINIMUM
    0 
  UNITS
    ft2
  REPORTPRECISION
    0
  DEFAULT
    SumRevRef(Spc:ResDHWSysRef, Spc:DwellingUnitSpcTotAreaWithMult)
  SIZING
    SysFlrArea
  ANNUAL
    SysFlrArea
ENDRULE

// -----------------------------------------------------------------------------
// -------------- Residential Distribution System Type --------------------
RULE ResDHWSys:CentralSys
  DESCRIPTION
    "Whether or not this system serves more than 1 dwelling unit."
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    Optional
  DEFAULT
    0
  SIZING_PROPOSED
    if( ExcludeWtrHtg )
    then 0
    else if( Proj:SHWBothBaseline )
    then 0
    else CentralSys
    endif endif
  SIZING_BASELINE
    if (IfValidAnd( IsBaseSys > 0 ))
    then 0
    else if( zp:CentralSys = 1 )
    then 1
    else 0
    endif endif
  ANNUAL
    z:CentralSys
ENDRULE

// -------------------------------------------------------------------
// 
RULE ResDHWSys:Type
  DESCRIPTION
    "Distribution system types for systems serving individual dwelling units"
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    Required
  DEFAULT
    "Standard"
  SIZING_PROPOSED
    if( ExcludeWtrHtg )
    then "Standard"
    else u:Type
    endif
  SIZING_BASELINE
    if( Proj:ResDHWUserAndBaseline .OR. Proj:ResDHWBothBaseline )
    then 
      if( CentralSys )
      then
        "Standard"
      else
        "Standard"                                    // not applicable to individual unit ResDHW
      endif
    else if( Proj:ResDHWPropOnly )
    then 
     zp:Type
    else if( Proj:ResDHWNone )
    then 
      UNDEFINED                                      // no DHW modeled
    else 
      UNDEFINED
    endif endif endif
  ANNUAL
    z:Type
ENDRULE

// -------- Flag for triggering HERS reporting for Residential DHW System with pipe insulation and HERS verified  --------------
RULE NEW ResDHWSys:HERSResDHWSysPipeIns
  DATATYPE
    Integer
  LONGFORM
    HERSResidentialDomesticHotWaterSystemPipeInsulation
  DESCRIPTION
    ""  
  HELP
    ""  
  INPUTCLASS
    NotInput   
  DEFAULT   
    if( IfValidAnd(Type = "(HERS req'd) Pipe Insulation, All Lines") .AND. IfValidAnd( Status = "New" ) )
    then 1
    else 0
    endif
ENDRULE

// -------- Flag for triggering HERS reporting for Residential DHW System with parallel piping and HERS verified  --------------
RULE NEW ResDHWSys:HERSResDHWSysParallelPiping
  DATATYPE
    Integer
  LONGFORM
    HERSResidentialDomesticHotWaterSystemParallelPiping
  DESCRIPTION
    ""  
  HELP
    ""  
  INPUTCLASS
    NotInput   
  DEFAULT   
    if( IfValidAnd(Type = "(HERS req'd) Parallel Piping") .AND. IfValidAnd( Status = "New" ) )
    then 1
    else 0
    endif
ENDRULE

// -------- Flag for triggering HERS reporting for Residential DHW System - Recirc with demand control, push button and HERS verified  --------------
RULE NEW ResDHWSys:HERSResDHWSysRecircDemCtrlPushButton
  DATATYPE
    Integer
  LONGFORM
    HERSResidentialDomesticHotWaterSystemRecirculationDemandControlPushButton
  DESCRIPTION
    ""  
  HELP
    ""  
  INPUTCLASS
    NotInput   
  DEFAULT   
    if( IfValidAnd(Type = "(HERS req'd) Recirculation, Demand Control Push Button") .AND. IfValidAnd( Status = "New" ) )
    then 1
    else 0
    endif
ENDRULE

// -------- Flag for triggering HERS reporting for Residential DHW System - Recirc with demand control, occupancy sensor and HERS verified  --------------
RULE NEW ResDHWSys:HERSResDHWSysRecircDemCtrlOccSensor
  DATATYPE
    Integer
  LONGFORM
    HERSResidentialDomesticHotWaterSystemRecirculationDemandControlOccupancySensor
  DESCRIPTION
    ""  
  HELP
    ""  
  INPUTCLASS
    NotInput   
  DEFAULT   
    if( IfValidAnd(Type = "(HERS req'd) Recirculation, Demand Control Occupancy/Motion") .AND. IfValidAnd( Status = "New" ) )
    then 1
    else 0
    endif
ENDRULE

// -------- Flag for triggering HERS reporting for Residential DHW System - compact distribution system and HERS verified  --------------
RULE NEW ResDHWSys:HERSResDHWSysCompactDistSys
  DATATYPE
    Integer
  LONGFORM
    HERSResidentialDomesticHotWaterSystemCompactDistributionSystem
  DESCRIPTION
    ""  
  HELP
    ""  
  INPUTCLASS
    NotInput   
  DEFAULT   
    if( IfValidAnd(Type = "(HERS req'd) Compact Distribution System") .AND. IfValidAnd( Status = "New" ) )
    then 1
    else 0
    endif
ENDRULE




// -----------------------------------------------------------------------------
// ------ Distribution Type -------
// 
RULE ResDHWSys:DistType
  DESCRIPTION
    "This is the selection of the type of residential system coupled to the
     water heater."
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    CondRequired
// enums must be defined via Enums.txt in order to map to numeric values expected by the T24 DHW simulation engine
//  OPTION
//    No Loops or central system pump
//    No Control
//    Demand Control
//    Temperature modulation
//    Temperature modulation & monitoring
  DEFAULT
    if( ExcludeWtrHtg )
    then 
      UNDEFINED
    else
      "Demand Control (Standard Design for new construction)"
    endif
  CHECKCODE        
    if( IfValidAnd(CentralSys = 1) .AND. IfValidAnd(LivingUnitCnt > 8) .AND. 
        IfValidAnd( DistType = "No loops or central system pump" ) )
    then
      PostError("Residential DHW system '%s' must be set to a central distribution 
                 type other than 'No loops or central system pump' since it serves 
                 more than 8 dwelling units.",Name)
    else
      UNCHANGED
    endif
  SIZING_PROPOSED
    if( ExcludeWtrHtg )
//    then "Demand Control (Standard Design for new construction)"
    then UNDEFINED
    else u:DistType
    endif
  SIZING_BASELINE
    if( Proj:ResDHWUserAndBaseline .OR. Proj:ResDHWBothBaseline )
    then 
      if( CentralSys )
      then
        if ( zp:DistType = "No loops or central system pump" )
        then
          "No loops or central system pump"
        else  
        "Demand Control (Standard Design for new construction)"
        endif
      else
        UNDEFINED                                    // not applicable to individual unit ResDHW
      endif
    else if( Proj:ResDHWPropOnly )
    then 
      if( CentralSys )
      then
        zp:DistType
      else
        UNDEFINED                                    // not applicable to individual unit ResDHW
      endif
    else if( Proj:ResDHWNone )
    then 
      UNDEFINED                                      // no DHW modeled
    else 
      UNDEFINED
    endif endif endif
  ANNUAL
    z:DistType
ENDRULE

// -----------------------------------------------------------------------------
// ------ Residential DHW System Living Unit Count -------
// 
RULE ResDHWSys:LivingUnitCnt
  DESCRIPTION
    "The number of living units served by a central residential DHW System."
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    NotInput  IgnoreUserInput  "Removed prior to release of 2013-3e and 2016.2"
  REPORTPRECISION
    0
  DEFAULT
    SumRevRef( Spc:ResDHWSysRef, Spc:ResLivingUnitCntWithMult ) +
    SumRevRef( Spc:ResDHWSysRef, Spc:HotelMotelGuestRmCntWithMult )
  CHECKCODE           // LivingUnitCnt
    if( IfValidAnd(CentralSys = 1) .AND. IfValidAnd(LivingUnitCnt <= 1) )
    then
      PostError("Residential DHW system '%s' is specified to serve more than 
                 one dwelling unit but the Number of Living Units is less 
                 than or equal to 1.",Name)
    else
      UNCHANGED
    endif
  SIZING_PROPOSED           
    if( ExcludeWtrHtg )
    then 1
    else LivingUnitCnt
    endif
  SIZING_BASELINE
    if (IfValidAnd( IsBaseSys > 0 ))
    then 
	    if ( ExcludeWtrHtg ) 
	    then 1
	    else
	         SumRevRef( Spc:ResDHWSysRef, Spc:ResLivingUnitCntWithMult ) +
	         SumRevRef( Spc:ResDHWSysRef, Spc:HotelMotelGuestRmCntWithMult )
      endif
    else if( CentralSys )
    then
      LivingUnitCnt
    else
      1
    endif endif
  ANNUAL
    z:LivingUnitCnt
ENDRULE

// -----------------------------------------------------------------------------
// ------ Residential DHW System Story Count -------
// 
RULE ResDHWSys:SysStoryCnt
  DESCRIPTION
    "The number stories served by an individual Residential DHW System.
    Typical number of stories assigned to one system is 1 - 10. For projects
    having more than 10 stories it is suggested that the user create a separate 
    Residential DHW System for every 90 feet of vertical plumbing height."
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    CondRequired
  COMMONMAXIMUM
    10
  REPORTPRECISION
    0
  DEFAULT
    0
  CHECKCODE           // SysStoryCnt
    if( CentralSys .AND. IfValidAnd(SysFlrArea > 0) .AND. 
        IfValidAnd(SysStoryCnt = 0) )
    then
      PostError("For Central Systems, more than 0 stories must be assigned 
                 at '%s'.",Name)
    else UNCHANGED
    endif
  SIZING_PROPOSED
    if( ExcludeWtrHtg )
    then 1
    else u:SysStoryCnt
    endif
  SIZING_BASELINE
    if (IfValidAnd( IsBaseSys > 0 ))
    then 1
    else if( CentralSys )
    then
      u:SysStoryCnt
    else
      1
    endif endif
  ANNUAL
    z:SysStoryCnt
ENDRULE

// -----------------------------------------------------------------------------
// -------------- Recirculating Pump Horsepower --------------------
RULE ResDHWSys:PumpBHP
  DESCRIPTION
    "The Brake Horsepower of the recirculating water heater pump."
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    CondRequired
  MINIMUM
    0
  MAXIMUM
    250
  UNITS
    bhp
  REPORTPRECISION
    2
  DEFAULT
    if( ExcludeWtrHtg )
    then UNDEFINED 
    else 0.5
    endif
  SIZING_PROPOSED
    if( ExcludeWtrHtg )
    then UNDEFINED // 0.5
    else u:PumpBHP
    endif
  SIZING_BASELINE
    if( Proj:ResDHWUserAndBaseline .OR. Proj:ResDHWBothBaseline .OR.
        Proj:ResDHWPropOnly )
    then 
      if( CentralSys )  
      then
        u:PumpBHP
      else                                       // individual ResDHW system
        UNDEFINED // 0.6
      endif
    else if( Proj:ResDHWNone )
    then 
      UNDEFINED                                  // no DHW modeled
    else 
      UNDEFINED
    endif endif
  ANNUAL
    PumpBHP
ENDRULE

// -----------------------------------------------------------------------------
// -------------- Recirculating Pump Efficiency --------------------
// 
RULE ResDHWSys:PumpEff
  DESCRIPTION
    "The efficiency of the pump."
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    Optional
  MINIMUM
    0.00
  MAXIMUM
    0.99
  REPORTPRECISION
    2
  DEFAULT
    if( ExcludeWtrHtg )
    then UNDEFINED
    else 0.6
    endif
  SIZING_PROPOSED
    if( ExcludeWtrHtg )
    then UNDEFINED
    else u:PumpEff
    endif
  SIZING_BASELINE
    if( Proj:ResDHWUserAndBaseline .OR. Proj:ResDHWBothBaseline .OR.
        Proj:ResDHWPropOnly )
    then 
      if( CentralSys )  
      then
        u:PumpEff
      else                                       // individual ResDHW system
        UNDEFINED // 0.6
      endif
    else if( Proj:ResDHWNone )
    then 
      UNDEFINED                                  // no DHW modeled
    else 
      UNDEFINED
    endif endif
  ANNUAL
    z:PumpEff
ENDRULE


// -----------------------------------------------------------------------------
// -------------- Recirc Loop count --------------------
// 
RULE ResDHWSys:LpCnt
  DESCRIPTION
    "The number of loops in the residential system."
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    CondRequired
  MINIMUM
    1
  MAXIMUM
    5
  REPORTPRECISION
    0
  DEFAULT
    1
  SIZING_PROPOSED
    if( ExcludeWtrHtg )
    then UNDEFINED // 1
    else u:LpCnt
    endif
  SIZING_BASELINE
    if( Proj:ResDHWUserAndBaseline .OR. Proj:ResDHWBothBaseline )
    then 
      if( CentralSys )  
      then
        if( IfValidAnd( LivingUnitCnt > 8 ) )
        then 1
        else 1
        endif
      else
        UNDEFINED
      endif
    else if( Proj:ResDHWPropOnly )
    then 
      if( CentralSys )  
      then
        if (IfValidAnd( IsBaseSys > 0 ))
        then 1
        else u:LpCnt
        endif
      else
        UNDEFINED
      endif
    else if( Proj:ResDHWNone )
    then 
      UNDEFINED                                  // no DHW modeled
    else 
      UNDEFINED
    endif endif endif
  ANNUAL
    z:LpCnt
ENDRULE


// -----------------------------------------------------------------------------
// -------------- Residential Pipe Location --------------------
//
RULE ResDHWSys:PipeLctn
  DESCRIPTION
    "This is the general location of a recirculation pipe."
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    CondRequired
// enums must be defined via Enums.txt in order to map to numeric values expected by the T24 DHW simulation engine
//  OPTION
//    Conditioned
//    Unconditioned
//    Underground
  DEFAULT
    "Conditioned"
  SIZING_PROPOSED
    if( ExcludeWtrHtg )
    then UNDEFINED // "Conditioned"
    else u:PipeLctn
    endif
  SIZING_BASELINE
    if( Proj:ResDHWUserAndBaseline .OR. Proj:ResDHWBothBaseline )
    then 
      if( CentralSys )  
      then
        "Conditioned"
      else
        UNDEFINED
      endif
    else if( Proj:ResDHWPropOnly )
    then 
      if( CentralSys )  
      then
        if (IfValidAnd( IsBaseSys > 0 ))
        then "Conditioned"
        else u:PipeLctn
        endif
      else UNDEFINED
      endif
    else if( Proj:ResDHWNone )
    then 
      UNDEFINED                                  // no DHW modeled
    else 
      UNDEFINED
    endif endif endif
  ANNUAL
    z:PipeLctn  
ENDRULE


// ---------------------------------------------------------------------
RULE ResDHWSys:LpPipeInsThkns
  DESCRIPTION
    "Thickness of loop pipe insulation"
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    Required
  DEFAULT
    1.5
  SIZING_PROPOSED
    if( ExcludeWtrHtg )
    then UNDEFINED // 1.5
    else u:LpPipeInsThkns
    endif
  SIZING_BASELINE
    if( Proj:ResDHWUserAndBaseline .OR. Proj:ResDHWBothBaseline )
    then 
      if( CentralSys )  
      then
        1.5
      else
        UNDEFINED
      endif
    else if( Proj:ResDHWPropOnly )
    then 
      if( CentralSys )  
      then
        if (IfValidAnd( IsBaseSys > 0 ))
        then 1.5
        else u:LpPipeInsThkns
        endif
      else UNDEFINED
      endif
    else if( Proj:ResDHWNone )
    then 
      UNDEFINED                                  // no DHW modeled
    else 
      UNDEFINED
    endif endif endif
  ANNUAL
    z:LpPipeInsThkns
ENDRULE


// -----------------------------------------------------------------------------
// -------------- Residential DHW Water Heater Count --------------------
//
RULE ResDHWSys:WtrHtrCnt
  DESCRIPTION
    "This determines the number of Residential water heaters in the building."
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    NotInput  IgnoreUserInput  "Removed in transition from 2013 version 3c to 2016.1.0 / 2013 v3d"
  MINIMUM
    0
//  MAXIMUM
//    100
  REPORTPRECISION
    0
  DEFAULT
    SumChildren(ResWtrHtr:Cnt)
  SIZING_PROPOSED
    if( ExcludeWtrHtg )
    then 1
    else SumChildren(ResWtrHtr:Cnt)
    endif
  ANNUAL_PROPOSED
    z:WtrHtrCnt
ENDRULE

// -----------------------------------------------------------------------------
// -------------- Residential DHW Solar Fraction Type --------------------
//
RULE ResDHWSys:SolFracType
  DESCRIPTION
    "This is the type of solar fraction data used."
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    NotInput
  DEFAULT
    1      // Annual, not monthly
  SIZING
    1
  ANNUAL
    1
ENDRULE

// -----------------------------------------------------------------------------
// -------------- Residential DHW Annual Solar Fraction --------------------
//
RULE ResDHWSys:AnnualSolFrac
  DESCRIPTION
    "This is the Annual Solar Fraction."
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    Optional
  MINIMUM
    0 
  MAXIMUM
    1.0
  REPORTPRECISION
    2
  DEFAULT
    0
  SIZING_PROPOSED
    if( ExcludeWtrHtg )
    then 
      if( Proj:GasType = "None" )
      then 
        0.50
      else 
        0
      endif  
    else u:AnnualSolFrac
    endif
  SIZING_BASELINE
    if( Proj:ResDHWUserAndBaseline .OR. Proj:ResDHWBothBaseline )
    then 
      if( CentralSys )  
      then
        if( Proj:CliZnNum < 10 )
        then 0.20
        else 0.35
        endif 
      else if( Proj:GasType = "None" )
      then 
        0.50
      else 
        0
      endif endif
    else if( Proj:ResDHWPropOnly )
    then 
      if (IfValidAnd( IsBaseSys > 0 ))
      then
        if( Proj:CliZnNum < 10 )
        then 0.20
        else 0.35
        endif 
      else u:AnnualSolFrac
      endif
    else if( Proj:ResDHWNone )
    then 
      UNDEFINED                                  // no DHW modeled
    else 
      UNDEFINED
    endif endif endif
  ANNUAL
    z:AnnualSolFrac
ENDRULE

// -----------------------------------------------------------------------------
RULE ResDHWSys:SolCollectorCnt
  DESCRIPTION
    ""
  PREVIOUSNAMES
    Number
  INPUTCLASS
    Optional
ENDRULE

// -----------------------------------------------------------------------------
// -------------- Conversion Water Heater Capacity Rated --------------------
//
RULE NEW ResDHWSys:SysHotWtrHtgRtSizing
  LONGFORM
    BaselineResidentialWaterHeatingTotal
  DATATYPE
    Float
  DESCRIPTION
    "Total gal/hr baseline requirements for one Residential DHW System."
  INPUTCLASS
    NotInput
  UNITS
    gal per h
  DEFAULT
    SumRevRef(Spc:ResDHWSysRef, Spc:HotWtrHtgRtSizing)
ENDRULE

// -----------------------------------------------------------------------------
// -------------- Conversion Water Heater Capacity Rated --------------------
//
RULE NEW Proj:ProjHotWtrHtgRtSizing
  LONGFORM
    BaselineResidentialWaterHeatingTotal
  DATATYPE
    Float
  DESCRIPTION
    "Total gal/hr baseline requirements for all Residential DHW Systems in a project."
  INPUTCLASS
    NotInput
  UNITS
    gal per h
  DEFAULT
    SumChildren(ResDHWSys:SysHotWtrHtgRtSizing)
ENDRULE

// -----------------------------------------------------------------------------
// -------------- Conversion Water Heater Capacity Rated --------------------
//
RULE NEW ResWtrHtr:BasePropResWtrHtgTot
  LONGFORM
    BaselineProposedResidentialWaterHeatingTotal
  DATATYPE
    Float
  DESCRIPTION
    "Total gal/hr of one Residential DHW System that takes the Input Rating and
     converts it to gal/hr then add it to the tank volume."
  INPUTCLASS
    NotInput
  UNITS
    gal per h
  DEFAULT
    if( IfValidAnd(TankVol > 0) .AND. IfValidAnd(InpRating > 0) )
    then( (TankVol + (InpRating / (8.4 * (135 - 55)))) * Cnt )
    else UNDEFINED
    endif
ENDRULE

// -----------------------------------------------------------------------------
// -------------- Conversion Water Heater Capacity Rated --------------------
//
RULE NEW ResDHWSys:BasePropResWtrHtgTot
  LONGFORM
    BaselineProposedResidentialWaterHeatingTotal
  DATATYPE
    Float
  DESCRIPTION
    "Total gal/hr of one Residential DHW System that takes the Input Rating and
     converts it to gal/hr then add it to the tank volume."
  INPUTCLASS
    NotInput
  UNITS
    gal per h
  DEFAULT
    SumChildren(ResWtrHtr:BasePropResWtrHtgTot)
ENDRULE

// -----------------------------------------------------------------------------
// -------------- Conversion Water Heater Capacity Rated --------------------
//
RULE NEW Proj:BasePropResWtrHtgTot
  LONGFORM
    BaselineProposedResidentialWaterHeatingTotal
  DATATYPE
    Float
  DESCRIPTION
    "Total gal/hr of all Residential DHW Systems in the building that takes
     the Input Rating and converts it to gal/hr then add it to the tank volume."
  INPUTCLASS
    NotInput
  UNITS
    gal per h
  DEFAULT
    SumChildren(ResDHWSys:BasePropResWtrHtgTot)
ENDRULE

// -----------------------------------------------------------------------------
// -------------- Residential Water Heater Name --------------------
// 
RULE ResWtrHtr:Name
  DESCRIPTION
    "A unique name for each Residential water heater."
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    Optional
ENDRULE

// -----------------------------------------------------------------------------
// -------------- Duplicate Water Heater Count --------------------
//
RULE ResWtrHtr:Cnt
  DESCRIPTION
    "This is the number of identical water heaters."
  HELP
    "For Individual ResDHW Sytems: This is the number of duplicate water heaters 
     in a dwelling unit that are identical in every way.     


     For Central ResDHW Systems: This is the number of duplicate water heaters in 
     the parent Central System that are identical in every way."
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    Required
  MINIMUM
    1
  MAXIMUM
    1000 
  REPORTPRECISION
    0
;  DEFAULT   - SAC 6/22/16 - expression moved up above to ensure valid when referenced by other rules
;    1
  CHECKCODE           // Cnt
    if( IfValidAnd(Cnt = 0) )
    then
      PostError("Residential water heater '%s' must have a count greater than zero.",Name)
    else UNCHANGED
    endif
  SIZING_PROPOSED
    if( ExcludeWtrHtg )
    then 1
    else u:Cnt
    endif
  SIZING_BASELINE
    if( Proj:ResDHWUserAndBaseline )
    then 
      if( CentralSys )  
      then
        if (IfValidAnd( IsBaseSys > 0 ))
        then 1
        else u:Cnt
        endif
      else                                           // individual ResDHW system
        1
      endif
    else if( Proj:ResDHWPropOnly )
    then 
      if (IfValidAnd( IsBaseSys > 0 ))
      then 1
      else u:Cnt
      endif
    else if( Proj:ResDHWBothBaseline )
    then 
      if( CentralSys )  
      then
        UNDEFINED                                    // won't have central system
      else
        1                                            // individual ResDHW system
      endif
    else if( Proj:ResDHWNone )
    then 
      UNDEFINED                                      // no DHW modeled
    else 
      UNDEFINED
    endif endif endif endif
//    endif
  ANNUAL
    z:Cnt
ENDRULE

// -----------------------------------------------------------------------------
// -------------- Residential Water Heater Fuel Source --------------------
//
RULE ResWtrHtr:ElementType
  DESCRIPTION
    "This is the selection of the Residential Water Heater Fuel Source."
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    Required
// enums must be defined via Enums.txt in order to map to numeric values expected by the T24 DHW simulation engine
//  OPTION
//    Electric Resistance
//    Gas
//    Heat Pump
  DEFAULT
    "Gas"
  CHECKCODE           // ElementType
    if( ElementType = "Heat Pump" .AND. Parent( CentralSys ) )
    then
      PostError("Residential water heater '%s' is a Heat Pump, which is not 
                 allowed for use on a central system.  Change the Element Type.",
                 Name)
    else if( Proj:GasType = "None" .AND. ElementType = "Gas" )
    then
      PostError("Residential water heater '%s' is gas fired but the project 
                 gas type is specified as none.  Change the Element Type 
                 for the water heater or the project gas type.", Name)
    else UNCHANGED
    endif endif
  SIZING_PROPOSED
    if( ExcludeWtrHtg )
    then
      if( Proj:GasType = "None" )
      then
        "Electric Resistance"
      else
        "Gas"
      endif
    else u:ElementType
    endif
  SIZING_BASELINE
    if( Proj:ResDHWUserAndBaseline .OR. Proj:ResDHWBothBaseline )
    then 
      if( Proj:GasType = "None" )
      then
        "Electric Resistance"
      else
        "Gas"
      endif
    else if( Proj:ResDHWPropOnly )
    then 
      if (IfValidAnd( IsBaseSys > 0 ))
      then "Gas"
      else u:ElementType
      endif
    else if( Proj:ResDHWNone )
    then 
      UNDEFINED                                  // no DHW modeled
    else 
      UNDEFINED
    endif endif endif
  ANNUAL
    z:ElementType
ENDRULE

// -----------------------------------------------------------------------------
// -------------- Residential Water Heater Fuel Source Report --------------
//
RULE ResWtrHtr:ElementTypeRpt
  RULESETS
    T24N
  DESCRIPTION
    "Translates ElementType to ElementTypeRpt."
  INPUTCLASS
    NotInput
  ANNUAL_PROPOSED
    if ( ExcludeWtrHtg )
    then UNDEFINED
    else
	    if( Proj:NatGasAvail = 1 )
	    then
	      switch( ElementType ) 
	        case "Electric Resistance" : "Electric Resistance"
	        case "Gas"                 : "Natural Gas"
	        case "Heat Pump"           : "Heat Pump"
	        case "Oil"                 : "Oil"
	        default : UNDEFINED
	      endswitch
	    else
	      switch( ElementType ) 
	        case "Electric Resistance" : "Electric Resistance"
	        case "Gas"                 : "Propane"
	        case "Heat Pump"           : "Heat Pump"
	        case "Oil"                 : "Oil"
	        default : UNDEFINED
	      endswitch
	    endif
    endif
  ANNUAL_BASELINE
    UNDEFINED
ENDRULE

// -------------- Residential HPWH NEEA Certification --------------
//
RULE ResWtrHtr:HtPumpWtrHtrNEEARtd
  RULESETS
    T24N
  DESCRIPTION
    "Whether the HPWH is NEEA certified."
  INPUTCLASS
    CondRequired
  PREVIOUSNAMES  HtPumpWtrHtrNEEA  HeatPumpWaterHeaterNEEA
  DEFAULT
    0
  SIZING_PROPOSED
    if( ElementType = "Heat Pump" )
    	then UNCHANGED
    else UNDEFINED
    endif
  SIZING_BASELINE
   if( Proj:ResDHWUserAndBaseline .OR. Proj:ResDHWBothBaseline )
    then 
      if (IfValidAnd( IsBaseSys > 0 ))
      then UNDEFINED
      else 
		    if( ElementType = "Heat Pump" )
		    then u:HtPumpWtrHtrNEEARtd
		    else UNDEFINED
		    endif      
      endif
    else if( Proj:ResDHWPropOnly )
    then 
      if (IfValidAnd( IsBaseSys > 0 ))
      then UNDEFINED 
      else u:HtPumpWtrHtrNEEARtd
      endif
    else if( Proj:ResDHWNone )
    then 
      UNDEFINED                                  // no DHW modeled
    else 
      UNDEFINED
    endif endif endif
  ANNUAL
    z:HtPumpWtrHtrNEEARtd
ENDRULE

// -----------------------------------------------------------------------------
RULE ResWtrHtr:HPWHBrand
  RULESETS
    T24N
  DESCRIPTION
    "NEEA-rated HPWH brand name."
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    CondRequired
// enums defined in Enums.txt to enable numeric-based logic/defaulting consistent w/ Res rules
//  OPTION
// defaulting implemented via enumeration definitions
//  DEFAULT
ENDRULE

// -----------------------------------------------------------------------------
RULE ResWtrHtr:HPWHModel
  RULESETS
    T24N
  DESCRIPTION
    "NEEA-rated HPWH model name/ID."
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    CondRequired
// enums defined in Enums.txt to enable numeric-based logic/defaulting consistent w/ Res rules
//  OPTION
// defaulting implemented via enumeration definitions
//  DEFAULT
  RESETS
    ResetThisWhenTheFollowingIsModified
      ResWtrHtr:HPWHBrand
ENDRULE

// -----------------------------------------------------------------------------
RULE ResWtrHtr:AirSrcHtPumpType
  RULESETS
    T24N
  DESCRIPTION
    "CSE simulation air source HPWH type."
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    Prescribed
// enums defined in Enums.txt to enable numeric-based logic/defaulting consistent w/ Res rules
//  OPTION
  DEFAULT
    if (LocalStatus( HPWHBrand ) < 1 .OR. LocalStatus( HPWHModel ) < 1)
    then  UNCHANGED
    else  HPWHData_NEEA:ASHPType( "Brand", HPWHBrand, "Model", HPWHModel )
    endif
ENDRULE

// -----------------------------------------------------------------------------
RULE ResWtrHtr:MakeAndModel
  RULESETS
    T24N
  DESCRIPTION
    "Make and model of residential water heater."
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    NotInput
  DEFAULT
    if( ElementType = "Heat Pump" .AND. IfValidAnd( HtPumpWtrHtrNEEARtd > 0 ))
    then  if (LocalStatus( HPWHBrand ) > 0 .AND. LocalStatus( HPWHModel ) > 0)
          then  HPWHBrand + " / " + HPWHModel
          else if (LocalStatus( AirSrcHtPumpType ) > 0)
          then  AirSrcHtPumpType
          else  "NA"
          endif endif
    else  "NA"
    endif
ENDRULE

// -----------------------------------------------------------------------------
//RULE NEW ResWtrHtr:HtPumpDisp
//  DATATYPE
//    Integer
//  LONGFORM
//    HeatPumpDisplay
//  DESCRIPTION
//    "flag indicating whether or not to display HPWH inputs in UI"
//  REFERENCE 
//    Res ACM-2.10 Domestic Hot Water
//  INPUTCLASS
//    NotInput
//  DEFAULT
//    1
//ENDRULE


// -----------------------------------------------------------------------------
// -------------- Total Water Heater Input Rating --------------------
// 
RULE ResWtrHtr:InpRating
  DESCRIPTION
    "The heating capacity of a water heater at the rated conditions specified
     in DOE 10 CFR Part 430 or ANSI Z21.10."
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    Required
  UNITS
    Btu/hr
  REPORTPRECISION
    -2
  DEFAULT
    if ( ExcludeWtrHtg )
    then 
      200000
    else
	    if( LocalStatus( InpRatingElec ) >= 7 ) then  // if there is a user input value
	      InpRatingElec * 3.412
	    else if( Proj:AutoHardSize = 1 .AND. TankCat != "Indirect" .AND. TankCat != "Instantaneous")
	    then
	      MAX( 0, ( Parent(SysHotWtrHtgRtSizing) * 0.6 * 8.4 * (135 - 55) ) / 0.80 )    // Convert Output to Input -> divide by ThrmlEff 0.80. 60% of the capacity is for the burner and conversion from gal/hr to btu/h
	    else
	      if( Proj:AutoHardSize = 1 .AND. TankCat = "Instantaneous" )
	      then
	        MAX( 0, ( (Parent(SysHotWtrHtgRtSizing) - 1) * 8.4 * (135 - 55) ) / 0.80 )  // Convert Output to Input -> divide by ThrmlEff 0.80. 100% of the capacity minus 1 gallon is for the burner and conversion from gal/hr to btu/h when instant.
	      else 0
	      endif
	    endif endif
	  endif
  SIZING_PROPOSED
    if( ExcludeWtrHtg )
    then 200000
    else if( ElementType = "Electric Resistance" .OR.
             ElementType = "Heat Pump" )
    then u:InpRatingElec * 3.412
    else u:InpRating
    endif endif
  SIZING_BASELINE
    if( Proj:ResDHWUserAndBaseline .OR. Proj:ResDHWBothBaseline )
    then 
//      if (IfValidAnd( Parent( IsBaseSys ) > 0 ))
//      then
        if( CentralSys )  
        then zp:InpRating
        else 200000                 // individual ResDHW system
        endif
//      else                         
//        UNDEFINED
//      endif
    else if( Proj:ResDHWPropOnly )
    then 
      if (IfValidAnd( IsBaseSys > 0 ))
      then 200000
      else zp:InpRating                            // individual unit ResDHW or no DHW modeled
      endif
    else if( Proj:ResDHWNone )
    then 
      UNDEFINED                                    // no DHW modeled
    else 
      UNDEFINED
    endif endif endif
  ANNUAL
    z:InpRating
ENDRULE


// -------------- Total Water Heater Input Rating - Electric --------------------
// 
RULE ResWtrHtr:InpRatingElec
  DESCRIPTION
    "The heating capacity of a water heater at the rated conditions specified
     in DOE 10 CFR Part 430 or ANSI Z21.10."
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    CondRequired
  UNITS
    Watts
  REPORTPRECISION
    -1
  DEFAULT
    Int( InpRating / 3.412 )
ENDRULE


// -----------------------------------------------------------------------------
// 
RULE ResWtrHtr:TankVol
  DESCRIPTION
    "The residential water heater tank volume."
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    CondRequired
  UNITS
    gal
  REPORTPRECISION
    2
  DEFAULT
    if( ExcludeWtrHtg )
    then
      0
    else
	    if( Proj:AutoHardSize = 1 )
	    then 
	      if( TankCat = "Instantaneous" )
	      then 0
	      else Int( (Parent(SysHotWtrHtgRtSizing) * 0.4) * 1.30 )  // 40% of the capacity is for the tank volume plus 30% oversizing
	      endif
	    else
	      if( TankCat = "Instantaneous" )
	      then 0
	      else if( ElementType = "Heat Pump" .AND. IfValidAnd( HtPumpWtrHtrNEEARtd > 0 ) .AND.
	               LocalStatus( HPWHBrand ) > 0 .AND. LocalStatus( HPWHModel ) > 0 )
	      then HPWHData_NEEA:TankVolume( "Brand", HPWHBrand, "Model", HPWHModel )
	      else UNDEFINED
	      endif endif
	    endif
	  endif
  SIZING_PROPOSED
    if( ExcludeWtrHtg )
    then 0
    else 
     if( IfValidAnd(ElementType = "Heat Pump") .AND. IfValidAnd(HtPumpWtrHtrNEEARtd = 1) )
     then  if (LocalStatus( HPWHBrand ) > 0 .AND. LocalStatus( HPWHModel ) > 0)
           then HPWHData_NEEA:TankVolume( "Brand", HPWHBrand, "Model", HPWHModel )
           else UNDEFINED
           endif
     else u:TankVol
    endif endif
  SIZING_BASELINE
    if( Proj:ResDHWUserAndBaseline )
    then 
      if( CentralSys )  
      then
        if (IfValidAnd( IsBaseSys > 0 ))
        then 0
        else zp:TankVol
        endif
      else 
        0
      endif
    else if( Proj:ResDHWPropOnly )
    then 
      if (IfValidAnd( IsBaseSys > 0 ))
      then 0
      else zp:TankVol
      endif
    else if( Proj:ResDHWBothBaseline )
    then 
      0
    else if( Proj:ResDHWNone )
    then 
      UNDEFINED                                  // no DHW modeled
    else 
      UNDEFINED
    endif endif endif endif
  ANNUAL
    z:TankVol
ENDRULE


// -----------------------------------------------------------------------------
//
RULE ResWtrHtr:IsUEFRtd
  DESCRIPTION
    "A flag to indicate whether UEF is used to describe the water heater 
     efficiency."
  HELP
    "The water heater has a UEF efficiency rating.  The UEF input box only appears 
      if the input rating and volume fit into a standards classification that uses UEF."  
  INPUTCLASS
    Required
  DEFAULT
    0
  CHECKCODE           // IsUEFRtd
    if( ExcludeWtrHtg )
    then UNCHANGED
    else
	    if( IsUEFRtd <> IsUEFRtdSim )
	    then
	      if( ElementType = "Heat Pump" .AND. HtPumpWtrHtrNEEARtd = 1 )
	      then UNCHANGED
	      else
	        PostWarning("Residential water heater '%s' has the flag set to 
	                     indicate that it is UEF rated, but the volume and input 
	                     ratings do not fall into a classification which uses UEF 
	                     ratings.  The flag should be unchecked, or the inputs 
	                     should be verified to ensure accuracy.",Name)
	      endif
	    else UNCHANGED
	    endif
   endif
ENDRULE

// -----------------------------------------------------------------------------
//
RULE NEW ResWtrHtr:InputPerVol
  LONGFORM
    InputPerVolume
  DATATYPE
    Float
  DESCRIPTION
    "The rated input per gallon."
  INPUTCLASS
    NotInput
  UNITS
    Btu/h per gal
  DEFAULT
    if( LocalStatus( InpRating ) > 0 .AND. LocalStatus( TankVol ) > 0 )
    then
      if( TankVol > 0 )
      then
        InpRating / TankVol
      else
        1000000               //  a big number, since we can't use infinity
      endif
    else 0
    endif
ENDRULE

// -----------------------------------------------------------------------------
//
RULE ResWtrHtr:IsUEFRtdSim
  DESCRIPTION
    "A flag to indicated whether UEF is used to describe the water heater 
     efficiency."
  INPUTCLASS
    NotInput
  DEFAULT
    if (IfValidAnd( IsUEFRtd > 0 )==0)
    then 0
    else
      if( ElementType = "Gas" .AND. (TankCat = "Boiler"        .OR.
                                     TankCat = "Indirect"      .OR.
                                     TankCat = "Instantaneous" .OR.
                                     TankCat = "Storage"  ) )
      then
        if( ( IfValidAnd( InpRating > 50000 ) .AND. IfValidAnd( InpRating <= 200000 ) .AND. 
              IfValidAnd( TankVol < 2 ) ) .OR.
            ( IfValidAnd( InpRating <= 75000 ) .AND. 
              IfValidAnd( TankVol >= 20 ) .AND. IfValidAnd( TankVol <= 100 ) ) .OR.
            ( IfValidAnd( InpRating > 75000 ) .AND. IfValidAnd( InpRating <= 105000 ) .AND. 
              IfValidAnd( TankVol >= 20 ) .AND. IfValidAnd( TankVol <= 120 ) .AND. 
              IfValidAnd( InputPerVol < 4000 ) ) )
        then 1
        else 0
        endif
      else if( ElementType = "Electric Resistance" .AND. (TankCat = "Instantaneous" .OR.
                                                          TankCat = "Storage"  ) )
      then
        if( ( IfValidAnd( InpRatingElec <= 12000 ) .AND. 
              IfValidAnd( TankVol < 2 ) ) .OR.
            ( IfValidAnd( InpRatingElec <= 12000 ) .AND. 
              IfValidAnd( TankVol >= 20 ) .AND. IfValidAnd( TankVol <= 120 ) ) .OR.
            ( IfValidAnd( InpRatingElec > 12000 ) .AND. IfValidAnd( InpRatingElec <= 59000 ) .AND. 
              IfValidAnd( TankVol < 2 ) ) )
        then 1
        else 0
        endif
      else if( ElementType = "Heat Pump" )
      then
        if( HtPumpWtrHtrNEEARtd = 1 )
        then
          UNCHANGED
        else if( ( IfValidAnd( InpRatingElec <= 12000 ) .AND. 
                   IfValidAnd( TankVol >= 20 ) .AND. IfValidAnd( TankVol <= 120 ) ) )
        then 1
        else 0
        endif endif
      else 0
      endif endif endif
    endif
  SIZING_BASELINE
    if( Proj:ResDHWUserAndBaseline )
    then 
      if ( IfValidAnd( IsUEFRtd > 0 ) .AND. ( ElementType = "Gas" .OR. ElementType = "Electric Resistance" ) )  // 7-5-18 NK Added to pass UEF Water Heater on Central Systems - Revise later once Res rules are updated
      then 
        if ( CentralSys .AND. ( IfValidAnd( TankType = "Consumer Storage (UEF)" ) .OR. IfValidAnd( TankType = "Consumer Instantaneous (UEF)" ) ) )
        then 1
        else 0
        endif
      else 0
      endif
    else if( Proj:ResDHWPropOnly )
    then 
      if (IfValidAnd( IsBaseSys > 0 ))
      then 0
      else u:IsUEFRtdSim
      endif
    else if( Proj:ResDHWBothBaseline )
    then 
      UNDEFINED // 0
    else if( Proj:ResDHWNone )
    then 
      UNDEFINED                                  // no DHW modeled
    else 
      UNDEFINED
    endif endif endif endif
ENDRULE


// -----------------------------------------------------------------------------
// -------------- Residential Water Heater Tank Category --------------------
//
RULE ResWtrHtr:TankCat
  DESCRIPTION
    "This is the selection of the Residential Water Heater Tank Category.
     This parameter is used to determine the Tank Type.  If the selection is
     instantaneous or storage, the selection will be verified against other 
     inputs."
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    Required
// enums must be defined via Enums.txt in order to map to numeric values expected by the T24 DHW simulation engine
//  OPTION
//    Boiler
//    Indirect
//    Instantaneous
//    Storage
//    Commercial Instantaneous (TE)
//    Commercial Storage (TE & SBL)
  DEFAULT
    if( ElementType = "Electric Resistance" .OR. ElementType = "Gas" )
    then
      if( ( LocalStatus( InpRating ) >= 0 .OR. LocalStatus( InpRatingElec ) >= 0 ) .AND.
            LocalStatus( TankVol ) >= 0 )
      then
        if( TankVol = 0 )
        then
          "Instantaneous"
        else if( InpRating > 0 .AND. TankVol > 0 )
        then
          if( InpRating / TankVol < 4000 )
          then "Storage"
          else "Instantaneous"
          endif
        else "Storage"
        endif endif
      else "Instantaneous"
      endif
    else if( ElementType = "Heat Pump" )
    then "Storage"
    else "Storage"
    endif endif
  CHECKCODE           // TankCat
    if ( ExcludeWtrHtg )
    then UNCHANGED
    else
	    if( IsUEFRtdSim = 0 )
	    then 
	      if( ElementType = "Electric Resistance" .OR. ElementType = "Gas" )
	      then
	        if( LocalStatus( InpRating ) >= 7 .AND. LocalStatus( TankVol ) >= 7 )
	        then
	          if( TankVol = 0 .AND. TankCat = "Storage" )
	          then
	            PostError("Residential water heater '%s' has a storage volume of 0 but
	                       the Tank Type is set to Storage.  These inputs are 
	                       incompatible. Please correct the inputs.",Name)
	          else if( InpRating > 0 .AND. TankVol > 0 )
	          then
	            if( InpRating / TankVol < 4000 .AND. TankCat = "Instantaneous" )
	            then
	              PostError("Residential water heater '%s' has an input rating less 
	                         than 4,000 Btu/hr/gal but the Tank Type is set to 
	                         Instantaneous.  These inputs are incompatible. Please 
	                         correct the inputs.",Name)
	            else if( InpRating / TankVol >= 4000 .AND. TankCat = "Storage" )
	            then
	              PostError("Residential water heater '%s' has an input rating of 
	                         4,000 Btu/hr/gal or more, but the Tank Type is set to 
	                         Storage.  These inputs are incompatible. Please 
	                         correct the inputs.",Name)
	            else UNCHANGED
	            endif endif
	          else UNCHANGED
	          endif endif
	        else UNCHANGED
	        endif
	      else UNCHANGED
	      endif
	    else 
	      UNCHANGED
	    endif
	  endif
  SIZING_PROPOSED
    if( ExcludeWtrHtg )
    then "Storage"
    else if( zp:ElementType = "Heat Pump" )
    then "Storage"
    else u:TankCat
    endif endif
  SIZING_BASELINE
    if( Proj:ResDHWUserAndBaseline )
    then 
      if( CentralSys )  
      then
        if (IfValidAnd( IsBaseSys > 0 ))
        then "Instantaneous"
        else zp:TankCat
        endif
      else 
        "Storage"
      endif
    else if( Proj:ResDHWPropOnly )
    then 
      if (IfValidAnd( IsBaseSys > 0 ))
      then "Instantaneous"
      else zp:TankCat                                  // existing ResDHW
      endif
    else if( Proj:ResDHWBothBaseline )
    then 
      "Storage"                                 // existing ResDHW
    else if( Proj:ResDHWNone )
    then 
      UNDEFINED                                   // no DHW modeled
    else 
      UNDEFINED
    endif endif endif endif
  ANNUAL
    z:TankCat
ENDRULE


// -----------------------------------------------------------------------------
//
RULE ResWtrHtr:AmbCond
  DESCRIPTION
    "This is the surrounding condition of the residential water heater."
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    CondRequired
// enums must be defined via Enums.txt in order to map to numeric values expected by the T24 DHW simulation engine
//  OPTION
//    Unconditioned
//    Conditioned
  DEFAULT
    "Unconditioned"
  SIZING_PROPOSED
    if( ExcludeWtrHtg )
    then "Conditioned"
    else u:AmbCond
    endif
  SIZING_BASELINE
    if( Proj:ResDHWUserAndBaseline )
    then 
      if( CentralSys )  
      then
        if (IfValidAnd( IsBaseSys > 0 ))
        then "Conditioned"
        else u:AmbCond
        endif
      else
        "Conditioned"
      endif
    else if( Proj:ResDHWPropOnly )
    then 
      if (IfValidAnd( IsBaseSys > 0 ))
      then "Conditioned"
      else u:AmbCond
      endif
    else if( Proj:ResDHWBothBaseline )
    then 
      "Conditioned"
    else if( Proj:ResDHWNone )
    then 
      UNDEFINED                                  // individual unit ResDHW or no DHW modeled
    else 
      UNDEFINED
    endif endif endif endif
  ANNUAL
    z:AmbCond
ENDRULE


// -----------------------------------------------------------------------------
// -------------- Residential Water Heater Tank Type --------------------
//
RULE ResWtrHtr:TankType
  DESCRIPTION
    "This is the selection of the Residential Water Heater Tank Type."
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    NotInput  IgnoreUserInput  "ResWtrHtr:TankType removed in transition from 2013 version 3c to 3e and 2016.2.0 to 2016.2.1"
//  OPTION
//    "Boiler"
//    "Indirect" 
//    "Large Instantaneous"
//    "Large Storage" 
//    "Small Instantaneous"
//    "Small Storage"
//    "Consumer Instantaneous (UEF)"
//    "Commercial Instantaneous (TE)"
//    "Consumer Storage (UEF)"
//    "Commercial Storage (TE & SBL)"
//    "Residential-Duty Commercial Storage (UEF)"
//    "Residential-Duty Commercial Instantaneous (UEF)"
//    "Heat Pump"
  DEFAULT
//    if( IncludeWtrHtg )
//    then 
	    if( TankCat = "Boiler" )
	    then 
	      "Boiler"
	    else if( TankCat = "Indirect" )
	    then 
	      "Indirect"
	    else if( TankCat = "Commercial Instantaneous (TE)" )
	    then 
	      "Commercial Instantaneous (TE)"
	    else if( TankCat = "Commercial Storage (TE & SBL)" )
	    then 
	      "Commercial Storage (TE & SBL)"            
	    else if( IsUEFRtdSim = 1 )
	    then
	      if( ElementType = "Heat Pump" )
	      then 
	        UNDEFINED
	      else if( ElementType = "Gas" )
	      then
	        if( InpRating > 50000 .AND. InpRating <= 200000 .AND. 
	            TankVol < 2 )
	        then "Consumer Instantaneous (UEF)"
	        else if( InpRating <= 75000 .AND. 
	                 TankVol >= 20 .AND. TankVol <= 100 )
	        then "Consumer Storage (UEF)"
	        else if( InpRating > 75000 .AND. InpRating <= 105000 .AND. 
	                 TankVol >= 20 .AND. TankVol <= 120 .AND. 
	                 InputPerVol < 4000 )
	        then "Residential-Duty Commercial Storage (UEF)"
	        else UNDEFINED
	        endif endif endif
	      else if( ElementType = "Electric Resistance" )
	      then
	        if( InpRatingElec <= 12000 .AND. 
	            TankVol < 2 )
	        then "Consumer Instantaneous (UEF)"
	        else if( InpRatingElec <= 12000 .AND. 
	                 TankVol >= 20 .AND. TankVol <= 120 )
	        then "Consumer Storage (UEF)"
	        else if( InpRatingElec > 12000 .AND. InpRatingElec <= 59000 .AND. 
	                 TankVol < 2 )
	        then "Residential-Duty Commercial Instantaneous (UEF)"
	        else UNDEFINED
	        endif endif endif
	      else 
	        UNDEFINED
	      endif endif endif
	    else if( IsUEFRtdSim = 0 )
	    then
	      if( TankCat = "Instantaneous" )
	      then 
	        if( ( ElementType = "Gas" .AND. InpRating > 200000 ) .OR.
	            ( ElementType = "Oil" .AND. InpRating > 210000 ) .OR.
	            ( ElementType = "Electric Resistance" .AND. InpRatingElec > 12000 ) )
	        then 
	          "Large Instantaneous"
	        else if( TankCat = "Instantaneous" .AND. ( ElementType = "Gas" .AND. InpRating <= 200000 ) .OR.
	                 ( ElementType = "Oil" .AND. InpRating <= 210000 ) .OR.
	                 ( ElementType = "Electric Resistance" .AND. InpRatingElec <= 12000 ) )
	        then 
	          "Small Instantaneous"
	        else UNDEFINED
	        endif endif
	      else if( TankCat = "Storage" )
	      then 
	        if( ( ElementType = "Gas" .AND. InpRating > 75000 ) .OR.
	            ( ElementType = "Oil" .AND. InpRating > 105000 ) .OR.
	            ( ElementType = "Electric Resistance" .AND. InpRatingElec > 12000 ) )
	        then 
	          "Large Storage"
	        else if( ( ElementType = "Gas" .AND. InpRating <= 75000 ) .OR.
	                 ( ElementType = "Oil" .AND. InpRating <= 105000 ) .OR.
	                 ( ElementType = "Electric Resistance" .AND. InpRatingElec <= 12000 ) .OR.
	                 ( ElementType = "Heat Pump" ) )
	        then 
	          "Small Storage"
	        else UNDEFINED
	        endif endif
	      else UNDEFINED
	      endif endif
	    else UNDEFINED
	    endif endif endif endif endif endif
//    else UNCHANGED // "Small Instantaneous"
//    endif 
  SIZING_PROPOSED
    if( Proj:ResDHWBothBaseline )
    then 
      if( CentralSys )  
      then
        if (IfValidAnd( IsBaseSys > 0 ))
        then
          "Small Instantaneous"
        else zp:TankType
        endif
      else 
        "Small Instantaneous"
      endif
    else if( Proj:ResDHWUserAndBaseline .OR. Proj:ResDHWPropOnly )
    then 
      if (IfValidAnd( IsBaseSys > 0 ))
      then
        "Small Instantaneous"
      else 
        if( IfValidAnd( IsUEFRtdSim = 1) .AND. IfValidAnd( ElementType = "Heat Pump") )
        then UNDEFINED
        else if( IfValidAnd( TankType = "Boiler" ) .OR. IfValidAnd( TankType = "Indirect" ) )
        then 
          "Large Instantaneous"
        else 
          TankType
        endif endif
      endif
    else if( Proj:ResDHWNone )
    then 
      UNDEFINED                                  // no DHW modeled
    else 
      UNDEFINED
    endif endif endif
  SIZING_BASELINE
    if( Proj:ResDHWUserAndBaseline .OR. Proj:ResDHWBothBaseline )
    then 
      if( CentralSys )  
      then
        if (IfValidAnd( IsBaseSys > 0 ))
        then
          "Small Instantaneous"
        else 
          if ( IfValidAnd( TankType = "Commercial Storage (TE & SBL)" ) .OR.
               IfValidAnd( TankType = "Residential-Duty Commercial Storage (UEF)" ) .OR. IfValidAnd( TankType = "Residential-Duty Commercial Instantaneous (UEF)" ) )                                  
          then
            "Large Storage"
          else
            zp:TankType    
          endif
        endif
      else 
        "Small Instantaneous"
      endif
    else if( Proj:ResDHWPropOnly )
    then 
      if (IfValidAnd( IsBaseSys > 0 ) )
      then
        "Small Instantaneous"
      else zp:TankType
      endif
    else if( Proj:ResDHWNone )
    then 
      UNDEFINED                                  // no DHW modeled
    else 
      UNDEFINED
    endif endif endif
  ANNUAL_PROPOSED
   zp:TankType
  ANNUAL_BASELINE
   zb:TankType
ENDRULE

; SAC 6/21/18 - updated small storage elec heater default input ratings from 8,00 -> 4,500 W
RULE NEW ResWtrHtr:InpRatingSim
  DATATYPE
    Float
  INPUTCLASS
    NotInput
  DEFAULT
    if ( ExcludeWtrHtg )
    then 
      200000
    else 
	    switch ( ElementTypeNum )
	      case 1:   ;Gas
	          switch ( TankType )
			     			case  "Large Instantaneous" :         210000		; "Large Instantaneous"       
			     			case  "Large Storage" :    u:InpRating		; "Large Storage"             
			     			case  "Small Instantaneous" :         195000		; "Small Instantaneous"       
			     			case  "Small Storage" :          40000		; "Small Storage"            
			     			case  "Consumer Instantaneous (UEF)" :         190000		; "Consumer Instantaneous (UEF)"             
			     			case  "Commercial Instantaneous (TE)" :         210000		; "Commercial Instantaneous (TE)"            
			     			case  "Consumer Storage (UEF)" :          40000		; "Consumer Storage (UEF)"                   
			     			case  "Commercial Storage (TE & SBL)" :    u:InpRating		; "Commercial Storage (TE & SBL)"            
			          case  "Residential-Duty Commercial Storage (UEF)" :          76000    ; "Residential-Duty Commercial Storage (UEF)"
								default :	  40000
	         endswitch
	      default: InpRating
	    endswitch
    endif
  SIZING_PROPOSED
    if( ExcludeWtrHtg )
    then 200000
    else u:InpRatingSim
    endif
  SIZING_BASELINE
    if( Proj:ResDHWUserAndBaseline .OR. Proj:ResDHWBothBaseline )
    then 
//      if (IfValidAnd( IsBaseSys > 0 ))
//      then
        if( CentralSys )  
        then 
          if ( IfValidAnd( IsUEFRtdSim = 1) .AND. IfValidAnd( IsUEFRtd = 1) )    // 7-5-18 NK Added to pass UEF Water Heater on Central Systems - Revise later once Res rules are updated
          then
            if ( TankType = "Consumer Storage (UEF)" )
            then 40000
            else if ( TankType = "Consumer Instantaneous (UEF)" )
            then 195000
            else
            UNDEFINED
            endif endif
          else
           zp:InpRatingSim 
          endif
        else 200000                 // individual ResDHW system
        endif
//      else                         
//        UNDEFINED
//      endif
    else if( Proj:ResDHWPropOnly )
    then 
      if (IfValidAnd( IsBaseSys > 0 ))
      then 200000
      else zp:InpRatingSim                            // individual unit ResDHW or no DHW modeled
      endif
    else if( Proj:ResDHWNone )
    then 
      UNDEFINED                                    // no DHW modeled
    else 
      UNDEFINED
    endif endif endif
  ANNUAL
    z:InpRatingSim
ENDRULE

RULE NEW ResWtrHtr:InpRatingElecSim
  DATATYPE
    Float
  INPUTCLASS
    NotInput
  DEFAULT
    if ( ExcludeWtrHtg )
    then 
      200000
    else 
	    switch ( ElementTypeNum )
	      case 0:   ;Electric Resistance
	          switch ( TankType )
			     			case  "Large Instantaneous" :    	36000		; "Large Instantaneous"       
			     			case  "Large Storage" :    u:InpRatingElec		; "Large Storage"             
			     			case  "Small Instantaneous" :     8000		; "Small Instantaneous"       
			     			case  "Small Storage" :     4500		; "Small Storage"            
			     			case  "Consumer Instantaneous (UEF)" :     8000		; "Consumer Instantaneous (UEF)"             
			     			case  "Commercial Instantaneous (TE)" :    36000		; "Commercial Instantaneous (TE)"            
			     			case  "Consumer Storage (UEF)" :     4500		; "Consumer Storage (UEF)"                   
			     			case  "Commercial Storage (TE & SBL)" :    u:InpRatingElec		; "Commercial Storage (TE & SBL)"            
			          case  "Residential-Duty Commercial Instantaneous (UEF)" :    36000    ; "Residential-Duty Commercial Instantaneous (UEF)"
								default :	  4500
	         endswitch
	      case 5:   8000      ;Heat Pump
	      default: InpRatingElec
	    endswitch
    endif
  SIZING_PROPOSED
    if( ExcludeWtrHtg )
    then 200000
    else u:InpRatingElecSim
    endif
  SIZING_BASELINE
    if( Proj:ResDHWUserAndBaseline .OR. Proj:ResDHWBothBaseline )
    then 
      UNDEFINED                  // BaseSys always Gas
    else if( Proj:ResDHWPropOnly )
    then 
      if (IfValidAnd( IsBaseSys > 0 ))
      then 200000
      else zp:InpRatingElecSim                            // individual unit ResDHW or no DHW modeled
      endif
    else if( Proj:ResDHWNone )
    then 
      UNDEFINED                                    // no DHW modeled
    else 
      UNDEFINED
    endif endif endif
  ANNUAL
    z:InpRatingElecSim
ENDRULE

// -----------------------------------------------------------------------------
// 
RULE NEW ResWtrHtr:ScreenVal
  LONGFORM
    ScreenValue
  DATATYPE
    Integer
  INPUTCLASS
    NotInput
  DESCRIPTION
    "A value used to determine the input screen configuration."
  INPUTCLASS
    NotInput
  DEFAULT
    switch ( TankType )
      case  "Boiler"                          :  1
      case  "Indirect"                        :  2
      case  "Large Instantaneous"             :  if( ElementType = "Gas" ) 
                                                 then 3
                                                 else 4
                                                 endif
      case  "Large Storage"                   :  if( ElementType = "Gas" ) 
                                                 then 5
                                                 else 6
                                                 endif
      case  "Small Instantaneous"             :  if( ElementType = "Gas" ) 
                                                 then 7
                                                 else 8
                                                 endif
      case  "Small Storage"                   :  if (ElementType = "Heat Pump")
                                                 then
                                                   if( HtPumpWtrHtrNEEARtd = 0 )
                                                   then
                                                     if( IsUEFRtdSim = 0 )
                                                     then 9
                                                     else 10
                                                     endif
                                                   else 11
                                                   endif
                                                 else if( ElementType = "Gas" )
                                                 then 12
                                                 else 13
                                                 endif endif
      case  "Consumer Instantaneous (UEF)"    :  if( ElementType = "Gas" )
                                                 then 14
                                                 else 15
                                                 endif
      case  "Commercial Instantaneous (TE)"   :  if( ElementType = "Gas" ) 
                                                 then 16
                                                 else 17
                                                 endif
      case  "Consumer Storage (UEF)"          :  if( ElementType = "Gas" ) 
                                                 then 18
                                                 else 19
                                                 endif
      case  "Commercial Storage (TE & SBL)"   :  if( ElementType = "Gas" ) 
                                                 then 20
                                                 else 21
                                                 endif
      case  "Residential-Duty Commercial Storage (UEF)"        :  22
      case  "Residential-Duty Commercial Instantaneous (UEF)"  :  23
      default :  12 // 8
    endswitch
ENDRULE


// -----------------------------------------------------------------------------
RULE NEW ResWtrHtr:TEDisp
  DESCRIPTION
    "Flag to indicate on the ResWtrHtr input screen that the input for
     thermal energy is to be displayed and editable."
  DATATYPE
    Integer
  INPUTCLASS
    NotInput
  DEFAULT
    if( ScreenVal =  1 .OR. ScreenVal =  2 .OR. 
        ScreenVal =  3 .OR. ScreenVal =  4 .OR.
        ScreenVal =  5 .OR. ScreenVal =  6 .OR. 
        ScreenVal = 16 .OR. ScreenVal = 17 .OR. ScreenVal = 20 .OR. ScreenVal =  21 .OR. ScreenVal =  22 )
      then 1
    else 0
    endif
ENDRULE


// -----------------------------------------------------------------------------
RULE NEW ResWtrHtr:EFDisp
  DESCRIPTION
    "Flag to indicate on the ResWtrHtr input screen that the input for
     energy factor is to be displayed and editable."
  DATATYPE
    Integer
  INPUTCLASS
    NotInput
  DEFAULT
//    if( ScreenVal =  3 .OR. ScreenVal =  4 .OR. ScreenVal =  7 .OR.   
    if( ScreenVal =  7 .OR. ScreenVal =  8 .OR. 
         ScreenVal = 9 .OR. ScreenVal = 12 .OR. ScreenVal = 13 )
      then 1
    else 0
    endif
ENDRULE


// -----------------------------------------------------------------------------
RULE NEW ResWtrHtr:MiniTankDisp
  DESCRIPTION
    "Flag to indicate on the ResWtrHtr input screen that the input checkbox for
     an electric mini tank is to be displayed and editable."
  DATATYPE
    Integer
  INPUTCLASS
    NotInput
  DEFAULT
    if( ScreenVal =  3 .OR. ScreenVal =  7 .OR.  
        ScreenVal = 14 .OR. ScreenVal = 16 )
      then 1
    else 0
    endif
ENDRULE


// -----------------------------------------------------------------------------
RULE NEW ResWtrHtr:UEFDisp
  DESCRIPTION
    "Flag to indicate on the ResWtrHtr input screen that the input for
     uniform energy factor is to be displayed and editable."
  DATATYPE
    Integer
  INPUTCLASS
    NotInput
  DEFAULT
    if( ScreenVal =  10 .OR. ScreenVal =  14 .OR. ScreenVal = 15 .OR. 
        ScreenVal = 18 .OR. ScreenVal = 19 .OR. ScreenVal = 22 .OR. 
        ScreenVal = 23 )
      then 1
    else 0
    endif
ENDRULE


// -----------------------------------------------------------------------------
RULE NEW ResWtrHtr:SBLFDisp
  DESCRIPTION
    "Flag to indicate on the ResWtrHtr input screen that the input for
     standby loss fraction is to be displayed and editable."
  DATATYPE
    Integer
  INPUTCLASS
    NotInput
  DEFAULT
    if( ScreenVal =  5 .OR. ScreenVal =  6 .OR. 
        ScreenVal =  20 .OR. ScreenVal =  21 )
      then 1
    else 0
    endif
ENDRULE


// -----------------------------------------------------------------------------
RULE NEW ResWtrHtr:PilotDisp
  DESCRIPTION
    "Flag to indicate on the ResWtrHtr input screen that the input for
     pilot energy is to be displayed and editable."
  DATATYPE
    Integer
  INPUTCLASS
    NotInput
  DEFAULT
    if( ScreenVal =  1 .OR. ScreenVal =  2 .OR. ScreenVal =  3 )
      then 1
    else 0
    endif
ENDRULE


// -----------------------------------------------------------------------------
RULE NEW ResWtrHtr:TankInsDisp
  DESCRIPTION
    "Flag to indicate on the ResWtrHtr input screen that the input for
     tank insulation is to be displayed and editable."
  DATATYPE
    Integer
  INPUTCLASS
    NotInput
  DEFAULT
    if( ScreenVal =  1 .OR. ScreenVal =  2 )
      then 1
    else 0
    endif
ENDRULE

// -----------------------------------------------------------------------------
RULE NEW ResWtrHtr:FlowRtDisp
  DESCRIPTION
    "Flag to indicate on the ResWtrHtr input screen that the input for
     flow rate is to be displayed and editable."
  DATATYPE
    Integer
  INPUTCLASS
    NotInput
  DEFAULT
    if( ScreenVal =  14 .OR. ScreenVal =  15 .OR. ScreenVal = 23 )
      then 1
    else 0
    endif
ENDRULE

// -----------------------------------------------------------------------------
RULE NEW ResWtrHtr:FirstHrDisp
  DESCRIPTION
    "Flag to indicate on the ResWtrHtr input screen that the input for
     first hour rating is to be displayed and editable."
  DATATYPE
    Integer
  INPUTCLASS
    NotInput
  DEFAULT
    if( ScreenVal = 10 .OR. ScreenVal = 18 .OR. ScreenVal = 19 .OR. 
        ScreenVal = 22 )
      then 1
    else 0
    endif
ENDRULE


// -----------------------------------------------------------------------------
RULE NEW ResWtrHtr:REDisp
  DESCRIPTION
    "Flag to indicate on the ResWtrHtr input screen that the input for
     recovery efficiency is to be displayed and editable."
  DATATYPE
    Integer
  INPUTCLASS
    NotInput
  DEFAULT
    if( ScreenVal =  14 .OR. ScreenVal =  15 .OR. ScreenVal = 18 .OR. 
        ScreenVal = 19 )
      then 1
    else 0
    endif
ENDRULE


// -----------------------------------------------------------------------------
RULE NEW ResWtrHtr:LocDisp
  DESCRIPTION
    "Flag to indicate on the ResWtrHtr input screen that the checkbox input for
     ambient location is to be displayed and editable."
  DATATYPE
    Integer
  INPUTCLASS
    NotInput
  DEFAULT
    if( ScreenVal =  2 ) //.OR. ScreenVal = 16 .OR. ScreenVal = 17 .OR. ScreenVal = 18 )
      then 1
    else 0
    endif
ENDRULE


// -----------------------------------------------------------------------------
RULE NEW ResWtrHtr:HtPumpDisp
  DESCRIPTION
    "Screens condition to not display Heat Pump Options"
  DATATYPE
    Integer
  INPUTCLASS
    NotInput
  DEFAULT
    if( ElementType = "Heat Pump" )
      then 1
    else 0
    endif
ENDRULE


// -----------------------------------------------------------------------------
RULE NEW ResWtrHtr:TankZnDisp
  DESCRIPTION
    "Flag to indicate on the ResWtrHtr input screen that the input for
     zone location is to be displayed and editable."
  DATATYPE
    Integer
  INPUTCLASS
    NotInput
  DEFAULT
//    if( LocDisp = 1 .AND. ( ScreenVal = 16 .OR. ScreenVal = 17 .OR. 
//        ScreenVal = 18 ) )
    if( ScreenVal = 13 .OR. ScreenVal = 9 .OR. ScreenVal = 10 .OR. ScreenVal = 11 .OR. ScreenVal = 19 )
      then 1
    else 0
    endif
ENDRULE


// -----------------------------------------------------------------------------
RULE NEW ResWtrHtr:BrandDisp
  DESCRIPTION
    "Flag to indicate on the ResWtrHtr input screen that the inputs for
     brand and model are to be displayed and editable."
  DATATYPE
    Integer
  INPUTCLASS
    NotInput
  DEFAULT
    if( HtPumpWtrHtrNEEARtd = 1 .AND. ElementType = "Heat Pump" )
      then 1
    else 0
    endif
ENDRULE


// -----------------------------------------------------------------------------
// -------- Baseline Residential Water Heater Tank Volume ---------------
// 
RULE NEW ResDHWSys:TankVolTotBase
  LONGFORM
    TankVolumeTotalBaseline
  DATATYPE
    Float
  DESCRIPTION
    ""
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    NotInput
  DEFAULT
    Int((SysHotWtrHtgRtSizing * 0.40) * 1.30)
ENDRULE

// -----------------------------------------------------------------------------
// -------- Baseline Residential Water Heater Input Rating ---------------
// 
RULE NEW ResDHWSys:InpRatingTotBase
  LONGFORM
    InputRatingTotalBaseline
  DATATYPE
    Float
  DESCRIPTION
    ""
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    NotInput
  DEFAULT
    Int( ((SysHotWtrHtgRtSizing * 0.60) * (8.4 * (135 - 55))) / 0.80 ) // Convert required burner capacity to input capacity -> divide by thrml eff 0.80
ENDRULE


// -----------------------------------------------------------------------------
// 
RULE ResWtrHtr:ThrmlEff
  DESCRIPTION
    "Thermal Efficiency of the Residential Water Heater."
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    CondRequired
  MINIMUM
    0.0 
  MAXIMUM
    1.00
  REPORTPRECISION
    2
  DEFAULT
    if( Proj:AutoEffInput = 1)
    then
	    if( ElementType = "Electric Resistance" )
	    then 0.93
	    else 0.80
	    endif
	  else
	    UNDEFINED
	  endif
  CHECKCODE           // ThrmlEff
    if ( ExcludeWtrHtg )
    then UNCHANGED
    else
	    if ( IfValidAnd( IsUEFRtdSim = 1 ) .AND. IfValidAnd( TankType = "Residential-Duty Commercial Storage (UEF)" ) .AND.
           ( LocalStatus ( ThrmlEff ) < 1 ) .AND. IfValidAnd( TEDisp = 1 ) )
      then
	      PostError("Residential water heater '%s' requires a 
	                 Thermal Efficiency input.",Name)        
      else if ( IsUEFRtdSim = 0 .AND. ( LocalStatus ( ThrmlEff ) < 1 ) .AND. IfValidAnd( TEDisp = 1 ) )
	    then
	      PostError("Residential water heater '%s' requires a 
	                 Thermal Efficiency input.",Name)
	    else
		    if( ElementType = "Gas" )
		    then
			      if( IfValidAnd( TankType = "Commercial Instantaneous (TE)" ) .AND.
			          ( IfValidAnd( ThrmlEff < 0.80 ) .OR. IfValidAnd( ThrmlEff >= 1 ) ) )
			      then
			        PostError("Thermal Efficiency for residential water heater '%s' 
			                   must be at least 0.80 and less than 1.00.",Name)
			      else if( IfValidAnd( TankType = "Commercial Storage (TE & SBL)" ) .AND.
			               ( IfValidAnd( ThrmlEff < 0.80 ) .OR. IfValidAnd( ThrmlEff >= 1 ) ) )
			      then
			        PostError("Thermal Efficiency for residential water heater '%s' 
			                   must be at least 0.80 and less than 1.00.",Name)
			      else if( IfValidAnd( TankType = "Residential-Duty Commercial Storage (UEF)" ) .AND.
			               ( IfValidAnd( ThrmlEff < 0.80 ) .OR. IfValidAnd( ThrmlEff >= 1 ) ) )
			      then
			        PostError("Thermal Efficiency for residential water heater '%s' 
			                   must be at least 0.80 and less than 1.00.",Name)
			      else UNCHANGED
			      endif endif endif
			    else if( ElementType = "Electric Resistance" )
			    then
			      if( IfValidAnd( TankType = "Commercial Instantaneous (TE)" ) .AND.
			          ( IfValidAnd( ThrmlEff < 0.80 ) .OR. IfValidAnd( ThrmlEff >= 1 ) ) )
			      then
			        PostError("Thermal Efficiency for residential water heater '%s' 
			                   must be at least 0.80 and less than 1.00.",Name)
			      else if( IfValidAnd( TankType = "Commercial Storage (TE & SBL)" ) .AND.
			               ( IfValidAnd( ThrmlEff < 0.80 ) .OR. IfValidAnd( ThrmlEff >= 1 ) ) )
			      then
			        PostError("Thermal Efficiency for residential water heater '%s' 
			                   must be at least 0.80 and less than 1.00.",Name)
			      else UNCHANGED
			      endif endif
			    else UNCHANGED
			    endif endif
	    endif endif
	  endif
  SIZING_PROPOSED
    if( ExcludeWtrHtg )
    then UNDEFINED
    else u:ThrmlEff
    endif
  SIZING_BASELINE   //FIX THIS FOR NEW BASELINE
    if( Proj:ResDHWUserAndBaseline .OR. Proj:ResDHWBothBaseline )
    then 
      if( IfValidAnd( TankType = "Large Storage" ) .OR. IfValidAnd( TankType = "Large Instantaneous" ) .OR.
          IfValidAnd( TankType = "Boiler" ) .OR. IfValidAnd( TankType = "Indirect" ) .OR. 
          IfValidAnd( TankType = "Consumer Instantaneous (UEF)" ) .OR. IfValidAnd( TankType = "Commercial Instantaneous (TE)" ) .OR.
          IfValidAnd( TankType = "Commercial Storage (TE & SBL)" ) .OR.                                                                   // IfValidAnd( TankType = "Consumer Storage (UEF)" ) .OR. 
          IfValidAnd( TankType = "Residential-Duty Commercial Storage (UEF)" ) .OR. IfValidAnd( TankType = "Residential-Duty Commercial Instantaneous (UEF)" ) ) 
      then 0.80
      else UNDEFINED
      endif
    else if( Proj:ResDHWPropOnly )
    then 
      if (IfValidAnd( IsBaseSys > 0 ))
      then 
      if( IfValidAnd( TankType = "Large Storage" ) .OR. IfValidAnd( TankType = "Large Instantaneous" ) .OR.
          IfValidAnd( TankType = "Boiler" ) .OR. IfValidAnd( TankType = "Indirect" ) .OR. 
          IfValidAnd( TankType = "Consumer Instantaneous (UEF)" ) .OR. IfValidAnd( TankType = "Commercial Instantaneous (TE)" ) .OR.
          IfValidAnd( TankType = "Commercial Storage (TE & SBL)" ) .OR.                                                                        // IfValidAnd( TankType = "Consumer Storage (UEF)" ) .OR. 
          IfValidAnd( TankType = "Residential-Duty Commercial Storage (UEF)" ) .OR. IfValidAnd( TankType = "Residential-Duty Commercial Instantaneous (UEF)" ) )            
        then 0.80
        else UNDEFINED
        endif
      else u:ThrmlEff
      endif
    else if( Proj:ResDHWNone )
    then 
      UNDEFINED                                  // no DHW modeled
    else 
      UNDEFINED
    endif endif endif
  ANNUAL
    z:ThrmlEff
ENDRULE


// -----------------------------------------------------------------------------
// 
RULE ResWtrHtr:RcvryEff
  DESCRIPTION
    "Recovery Efficiency of the Residential Water Heater."
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    CondRequired
  PREVIOUSNAMES  RecovEff
  MINIMUM
    0.0 
  MAXIMUM
    100.00
  REPORTPRECISION
    1
  DEFAULT
    if( Proj:AutoEffInput = 1)
    then
      if( ElementType = "Electric Resistance" )
      then
        99
      else if( ElementType = "Gas" )
      then
        if( IfValidAnd( TankType = "Consumer Instantaneous (UEF)" ) )
        then
          83
        else if( IfValidAnd( TankType = "Consumer Storage (UEF)" ) )
        then
          78
        else if( IfValidAnd( TankType = "Residential-Duty Commercial Storage (UEF)" ) )
        then
          80
        else
          UNDEFINED
        endif endif endif
      else
        UNDEFINED
      endif endif
    else
	      if ( IfValidAnd( IsUEFRtdSim = 1 ) .AND. IfValidAnd( UEF > 0 ) .AND. 
	           IfValidAnd( TankType = "Residential-Duty Commercial Storage (UEF)" ) .AND.
	           IfValidAnd ( ThrmlEff > 0 ) )
	      then
	        u:ThrmlEff * 100
	      else
	       UNDEFINED
	      endif      
     endif
  CHECKCODE           // RcvryEff
    if ( ExcludeWtrHtg )
    then UNCHANGED
    else
	    if ( IsUEFRtdSim = 1 .AND. ( LocalStatus ( RcvryEff ) < 1 ) .AND. IfValidAnd( REDisp = 1 ) )
	    then
	      PostError("Residential water heater '%s' requires a 
	                Recovery Efficiency input.",Name)
	    else
		    if( ElementType = "Gas" )
		    then
		      if( IfValidAnd( TankType = "Consumer Instantaneous (UEF)" ) .AND.
		          ( IfValidAnd( RcvryEff < 80 ) .OR. IfValidAnd( RcvryEff > 99 ) ) )
		      then
		        PostError("Recovery Efficiency for residential water heater '%s' 
		                   must be at least 80 and no more than 99.",Name)
		      else if( IfValidAnd( TankType = "Consumer Storage (UEF)" ) .AND.
		               ( IfValidAnd( RcvryEff < 70 ) .OR. IfValidAnd( RcvryEff > 99 ) ) )
		      then
		        PostError("Recovery Efficiency for residential water heater '%s' 
		                   must be at least 70 and no more than 99.",Name)
	//	      else if( IfValidAnd( TankType = "Residential-Duty Commercial Storage (UEF)" ) .AND.
	//	               ( RcvryEff < 80 .OR. RcvryEff > 99 ) )
	//	      then
	//	        PostError("Recovery efficiency for residential water heater '%s' 
	//	                   must be at least 80 and no more than 99.",Name)
		      else UNCHANGED
		      endif endif  // endif
		    else if( ElementType = "Electric Resistance" )
		    then
		      if( IfValidAnd( TankType = "Consumer Instantaneous (UEF)" ) .AND.
		          ( IfValidAnd( RcvryEff < 90 ) .OR. IfValidAnd( RcvryEff > 99 ) ) )
		      then
		        PostError("Recovery Efficiency for residential water heater '%s' 
		                   must be at least 90 and no more than 99.",Name)
		      else if( IfValidAnd( TankType = "Consumer Storage (UEF)" ) .AND.
		               ( IfValidAnd( RcvryEff < 90 ) .OR. IfValidAnd( RcvryEff > 99 ) ) )
		      then
		        PostError("Recovery Efficiency for residential water heater '%s' 
		                   must be at least 90 and no more than 99.",Name)
		      else UNCHANGED
		      endif endif
		    else UNCHANGED
		    endif endif
      endif
    endif
  SIZING_PROPOSED
    if( ExcludeWtrHtg )
    then UNDEFINED
    else 
      if ( IfValidAnd( IsUEFRtdSim = 1 ) .AND. IfValidAnd( UEF > 0 ) .AND. 
           IfValidAnd( TankType = "Residential-Duty Commercial Storage (UEF)" ) .AND.
            IfValidAnd ( ThrmlEff > 0 ) )
      then
        u:ThrmlEff * 100
      else
       u:RcvryEff
      endif     
    endif
  SIZING_BASELINE
    if( Proj:ResDHWUserAndBaseline )
    then 
      if ( CentralSys .AND. IfValidAnd( IsUEFRtdSim = 1 ) ) // 7-5-18 NK Added to pass UEF Water Heater on Central Systems - Revise later once Res rules are updated
	    then
	      zp:RcvryEff
	    else
	      UNDEFINED
	    endif    
	  else if ( Proj:ResDHWBothBaseline )
	  then  
      UNDEFINED
    else if( Proj:ResDHWPropOnly )
    then 
      if (IfValidAnd( IsBaseSys > 0 ))
      then 
        UNDEFINED
      else 
	      if ( IfValidAnd( IsUEFRtdSim = 1 ) .AND. IfValidAnd( UEF > 0 ) .AND. IfValidAnd( TankType = "Residential-Duty Commercial Storage (UEF)" ) )
	      then
	        u:ThrmlEff * 100
	      else
	       u:RcvryEff
	      endif     
	    endif      
    else if( Proj:ResDHWNone )
    then 
      UNDEFINED                                  // no DHW modeled
    else 
      UNDEFINED
    endif endif endif endif
  ANNUAL
    z:RcvryEff
ENDRULE


// -----------------------------------------------------------------------------
// -----------------------------------------------------------------------------
RULE ResWtrHtr:EF
  DESCRIPTION
    "The residential water heater Energy Factor."
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    CondRequired
  PREVIOUSNAMES  EngyFac
  MINIMUM
    0.0 
  MAXIMUM
    4.00
  REPORTPRECISION
    2
  DEFAULT
    if( ExcludeWtrHtg )
    then 
      0.82 - (0.0019 * TankVol)
    else
	    if( Proj:AutoEffInput = 1)
	    then
	      if( Parent(CentralSys) = 1 )
	      then 0.60
	      else 0.82
	      endif
	    else 
	      if ( IfValidAnd( IsUEFRtdSim = 1 ) .AND. IfValidAnd( UEF > 0 ) )
	      then
	        u:UEF
	      else
	       UNDEFINED
	      endif 
	    endif
	  endif
  CHECKCODE           // EF
    if( ExcludeWtrHtg )
    then UNCHANGED
    else
	    if( IsUEFRtdSim = 0 .AND. EFDisp = 1 .AND. ( LocalStatus( u:EF ) < 1 ) .AND.
	        IfValidAnd( InpRating > 0 ) .AND. IfValidAnd( HtPumpWtrHtrNEEARtd = 0 ) )
	    then
	      PostError("Residential water heater '%s' requires an 
	                 Energy Factor input.",Name)
	    else  if( IsUEFRtdSim = 0 .AND. EFDisp = 1 .AND. IfValidAnd(ElementType <> "Heat Pump") .AND. 
	              IfValidAnd( EF > 1) )
	    then
	      PostError("The Energy Factor for water heater '%s' is greater than 
             1 and it is not a heat pump.  Enter a valid Energy Factor.", 
             Name)
	    else 
	      UNCHANGED
	    endif endif
   endif  
  SIZING_PROPOSED
    if( ExcludeWtrHtg )
    then 0.82 - (0.0019 * TankVol)              
    else 
     if( IfValidAnd(ElementType = "Heat Pump") .AND. IfValidAnd(HtPumpWtrHtrNEEARtd = 1) )
     then UNDEFINED
     else if ( IfValidAnd( IsUEFRtdSim = 1 ) .AND. IfValidAnd( UEF > 0 ) ) 
	   then u:UEF   // New variable to be TBD later to pass to CSE because EF is not necessarily EF
	   else u:EF
     endif endif
    endif
  SIZING_BASELINE              // Efficiency for Consumer Storage (UEF) and Consumer Instantaneous UEF needs to be determmined.
    if( LocalStatus(TankVol) > 0 ) 
    then
      if( StdsVersionYr >=2015 ) // "Compliance2015" or "Compliance2016" or "Compliance2019" or "Compliance2022"
      then
        if( Proj:ResDHWUserAndBaseline .OR. Proj:ResDHWBothBaseline )
        then
          if( ElementType = "Gas" .AND. IfValidAnd( TankType = "Small Storage" )  )
          then
            if( TankVol <= 55 ) 
	          then
	            0.675 - (0.0015 * TankVol)
	          else
	            0.8012 - (0.00078 * TankVol)
	          endif
          else if( ElementType = "Gas" .AND. ( IfValidAnd( TankType = "Consumer Storage (UEF)" ) .OR. 
                   IfValidAnd( TankType = "Consumer Instantaneous (UEF)" ) ) ) 
          then
            if( CentralSys .AND. IfValidAnd( IsUEFRtdSim = 1 ) .AND. IfValidAnd( UEF > 0 ) )  // 7-5-18 NK Added to pass UEF Water Heater on Central Systems - Revise later once Res rules are updated
	          then
              0.80
	          else
	            UNDEFINED
	          endif
          else if( ElementType = "Electric Resistance" .AND. IfValidAnd( TankType = "Small Storage" ) )
          then
            if( TankVol <= 55 ) 
            then
              0.960 - (0.0003 * TankVol)
            else
              2.057 - (0.00113 * TankVol)
            endif
          else if( ElementType = "Gas" .AND. IfValidAnd( TankType = "Small Instantaneous" ) ) 
          then
            0.82 - (0.0019 * TankVol)
          else if( ElementType = "Electric Resistance" .AND. IfValidAnd( TankType = "Small Instantaneous" ) )
          then
            0.93 - (0.00132 * TankVol)
          else if( ElementType = "Heat Pump" .AND. IfValidAnd( HtPumpWtrHtrNEEARtd = 0 ) )
          then
            0.97 - (0.00132 * TankVol)
          else
            UNDEFINED
          endif endif endif endif endif endif
        else if( Proj:ResDHWPropOnly )
        then 
          if (IfValidAnd( IsBaseSys > 0 ))
          then 0.3
          else if ( IfValidAnd( IsUEFRtdSim = 1 ) .AND. IfValidAnd( UEF > 0 ) ) 
	        then u:UEF  
	        else zp:EF
          endif endif
        else if( Proj:ResDHWNone )
        then 
          UNDEFINED                                  // no DHW modeled
        else 
          UNDEFINED
        endif endif endif
      else
        0
      endif
    else
      0
    endif
  ANNUAL
    z:EF
ENDRULE


// -----------------------------------------------------------------------------
RULE ResWtrHtr:UEF
  DESCRIPTION
    "The residential water heater Uniform Energy Factor."
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    CondRequired
  MINIMUM
    0.0 
  MAXIMUM
    4.00
  REPORTPRECISION
    2
  DEFAULT
    if( Proj:AutoEffInput = 1)
    then
      if( Parent(CentralSys) = 1 )
      then 0.60
      else 0.82
      endif
    else UNDEFINED
    endif
  CHECKCODE           // UEF
    if ( ExcludeWtrHtg )
    then UNCHANGED
    else
	    if ( IsUEFRtdSim = 1 .AND. ( LocalStatus ( UEF ) < 1 ) .AND. IfValidAnd( UEFDisp = 1 ) )
	    then
	      PostError("Residential water heater '%s' requires an 
	                Uniform Energy Factor input.",Name)
	    else
		    if( ElementType = "Gas" )
		    then
		      if( IfValidAnd( TankType = "Consumer Instantaneous (UEF)" ) .AND.
		          ( IfValidAnd( UEF <= 0.80 ) .OR. IfValidAnd( UEF >= 1 ) ) )
		      then
		        PostError("Uniform Energy Factor for residential water heater '%s' 
		                   must be more than 0.80 and less than 1.00.",Name)
		      else if( IfValidAnd( TankType = "Consumer Storage (UEF)" ) .AND.
		               ( IfValidAnd( UEF < 0.24 ) .OR. IfValidAnd( UEF >= 1 ) ) )
		      then
		        PostError("Uniform Energy Factor for residential water heater '%s' 
		                   must be at least 0.24 and less than 1.00.",Name)
		      else if( IfValidAnd( TankType = "Residential-Duty Commercial Storage (UEF)" ) .AND.
		               ( IfValidAnd( UEF < 0.24 ) .OR. IfValidAnd( UEF >= 1 ) ) )
		      then
		        PostError("Uniform Energy Factor for residential water heater '%s' 
		                   must be at least 0.24 and less than 1.00.",Name)
		      else UNCHANGED
		      endif endif endif
		    else if( ElementType = "Electric Resistance" )
		    then
		      if( IfValidAnd( TankType = "Consumer Instantaneous (UEF)" ) .AND.
		          ( IfValidAnd( UEF < 0.92 ) .OR. IfValidAnd( UEF >= 1 ) ) )
		      then
		        PostError("Uniform Energy Factor for residential water heater '%s' 
		                   must be at least 0.92 and less than 1.00.",Name)
		      else if( IfValidAnd( TankType = "Consumer Storage (UEF)" ) .AND.
		               ( IfValidAnd( UEF < 0.92 ) .OR. IfValidAnd( UEF >= 1 ) ) )
		      then
		        PostError("Uniform Energy Factor for residential water heater '%s' 
		                   must be at least 0.92 and less than 1.00.",Name)
		      else if( IfValidAnd( TankType = "Residential-Duty Commercial Instantaneous (UEF)" ) .AND.
		               ( IfValidAnd( UEF < 0.80 ) .OR. IfValidAnd( UEF >= 1 ) ) )
		      then
		        PostError("Uniform Energy Factor for residential water heater '%s' 
		                   must be at least 0.80 and less than 1.00.",Name)
		      else UNCHANGED
		      endif endif endif
		    else if( ElementType = "Heat Pump" .AND. IsUEFRtdSim = 1 )
		    then
		      if( IfValidAnd( UEF < 2 ) .OR. IfValidAnd( UEF > 4 ) )
		      then
		        PostError("Uniform Energy Factor for residential water heater '%s' 
		                   must be between 2.00 and 4.00.",Name)
		      else UNCHANGED
		      endif
		    else UNCHANGED
		    endif endif endif
      endif
    endif
  SIZING_PROPOSED
    if( Proj:ResDHWBothBaseline )
    then 
      UNDEFINED
    else if( Proj:ResDHWUserAndBaseline .OR. Proj:ResDHWPropOnly )
    then 
      if ( IfValidAnd( IsUEFRtdSim = 1 ) )
      then
        u:UEF
      else
        UNDEFINED
      endif
    else if( Proj:ResDHWNone )
    then 
      UNDEFINED                                  // no DHW modeled
    else 
      UNDEFINED
    endif endif endif
  SIZING_BASELINE
    if( LocalStatus(TankVol) > 0 ) 
    then
      if( Proj:ResDHWUserAndBaseline )
      then
	      if ( CentralSys .AND. IfValidAnd( IsUEFRtdSim = 1 )  )  // 7-5-18 NK Added to pass UEF Water Heater on Central Systems - Revise later once Res rules are updated
	      then
	        0.80              
	      else
	        UNDEFINED
	      endif         
      else if ( Proj:ResDHWBothBaseline )
      then
        UNDEFINED
      else if( Proj:ResDHWPropOnly )
      then 
        if (IfValidAnd( IsBaseSys > 0 ))
        then UNDEFINED
        else zp:UEF
        endif        
      else if( Proj:ResDHWNone )
      then 
        UNDEFINED
      else 
        UNDEFINED
      endif endif endif endif
    else
      UNDEFINED
    endif
  ANNUAL
    z:UEF
ENDRULE


// -----------------------------------------------------------------------------
RULE ResWtrHtr:FirstHrRating
  DESCRIPTION
    "The first hour rating of the residential water heater."
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    CondRequired
  MINIMUM
    0 
  MAXIMUM
    250
  REPORTPRECISION
    0
  DEFAULT
    if( Proj:AutoEffInput = 1)
    then
      if( ElementType = "Gas" .AND. 
          IfValidAnd( TankType = "Consumer Storage (UEF)" ) )
      then 80
      else if( ElementType = "Gas" .AND. 
               IfValidAnd( TankType = "Residential-Duty Commercial Storage (UEF)" ) )
      then 120
      else if( ElementType = "Electric Resistance" .AND. 
               IfValidAnd( TankType = "Consumer Storage (UEF)" ) )
      then 60
      else 0
      endif endif endif
    else UNDEFINED
    endif
  CHECKCODE           // FirstHrRating
    if ( ExcludeWtrHtg )
    then UNCHANGED
    else
	    if ( IsUEFRtdSim = 1 .AND. ( LocalStatus ( FirstHrRating ) < 1 ) .AND. IfValidAnd( FirstHrDisp = 1 ) )
	    then
	      PostError("Residential water heater '%s' requires a 
	                First Hour Rating input.",Name)
	    else
		    if( ElementType = "Gas" )
		    then
		      if(  IfValidAnd( TankType = "Consumer Storage (UEF)" ) .AND.
		          (  IfValidAnd( FirstHrRating < 0 ) .OR.  IfValidAnd( FirstHrRating > 150 ) ) )
		      then
		        PostError("The First Hour Rating for residential water heater '%s' 
		                   must be 150 or less.",Name)
		      else if(  IfValidAnd( TankType = "Residential-Duty Commercial Storage (UEF)" ) .AND.
		               (  IfValidAnd( FirstHrRating < 0 ) .OR.  IfValidAnd( FirstHrRating > 250 ) ) )
		      then
		        PostError("The First Hour Rating for residential water heater '%s' 
		                   must be 250 or less.",Name)
		      else UNCHANGED
		      endif endif
		    else if( ElementType = "Electric Resistance" )
		    then
		      if(  IfValidAnd( TankType = "Consumer Storage (UEF)" ) .AND.
		          (  IfValidAnd( FirstHrRating < 0 ) .OR.  IfValidAnd( FirstHrRating > 100 ) ) )
		      then
		        PostError("The First Hour Rating for residential water heater '%s' 
		                   must be 100 or less.",Name)
		      else UNCHANGED
		      endif
		    else if( ElementType = "Heat Pump" .AND. IsUEFRtdSim = 1 )
		    then
		      if(  IfValidAnd( FirstHrRating < 0 ) .OR.  IfValidAnd( FirstHrRating > 100 ) )
		      then
		        PostError("The First Hour Rating for residential water heater '%s' 
		                   must be 100 or less.",Name)
		      else UNCHANGED
		      endif
		    else UNCHANGED
		    endif endif endif
	    endif
	  endif
  SIZING_PROPOSED
    if( Proj:ResDHWBothBaseline )
    then 
      UNDEFINED
    else if( Proj:ResDHWUserAndBaseline .OR. Proj:ResDHWPropOnly )
    then 
      if ( IfValidAnd( IsUEFRtdSim = 1 ) )
      then
        u:FirstHrRating
      else
        UNDEFINED
      endif
    else if( Proj:ResDHWNone )
    then 
      UNDEFINED                                  // no DHW modeled
    else 
      UNDEFINED
    endif endif endif  
  SIZING_BASELINE
    if( LocalStatus(TankVol) > 0 ) 
    then
      if( Proj:ResDHWUserAndBaseline )
      then
	      if ( CentralSys .AND. IfValidAnd( IsUEFRtdSim = 1 )  ) // 7-5-18 NK Added to pass UEF Water Heater on Central Systems - Revise later once Res rules are updated
	      then
	        u:FirstHrRating
	      else
	        UNDEFINED   
	      endif   
      else if ( Proj:ResDHWBothBaseline )
      then
        UNDEFINED
      else if( Proj:ResDHWPropOnly )
      then 
        if (IfValidAnd( IsBaseSys > 0 ))
        then UNDEFINED
        else zp:FirstHrRating
        endif        
       else if( Proj:ResDHWNone )
      then 
        UNDEFINED
      else 
        UNDEFINED
      endif endif endif endif
    else
      UNDEFINED
    endif
  ANNUAL
    z:FirstHrRating
ENDRULE


// -----------------------------------------------------------------------------
RULE ResWtrHtr:FlowRate
  DESCRIPTION
    "The residential water heater Uniform Energy Factor."
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    CondRequired
  MINIMUM
    0 
  MAXIMUM
    20
  REPORTPRECISION
    2
  DEFAULT
    if( Proj:AutoEffInput = 1)
    then
      if( ElementType = "Gas" .AND. 
          IfValidAnd( TankType = "Consumer Instantaneous (UEF)" ) )
      then 8
      else if( ElementType = "Electric Resistance" .AND. 
               IfValidAnd( TankType = "Consumer Instantaneous (UEF)" ) )
      then 2
      else if( ElementType = "Electric Resistance" .AND. 
               IfValidAnd( TankType = "Residential-Duty Commercial Instantaneous (UEF)" ) )
      then 5
      else 0
      endif endif endif
    else UNDEFINED
    endif
  CHECKCODE           // FlowRate
    if ( ExcludeWtrHtg )
    then UNCHANGED
    else
	    if ( IsUEFRtdSim = 1 .AND. ( LocalStatus ( FlowRate ) < 1 ) .AND. IfValidAnd( FlowRtDisp = 1 ) )
	    then
	      PostError("Residential water heater '%s' requires a 
	                Flow Rate input.",Name)
	    else
		    if( ElementType = "Gas" )
		    then
		      if( IfValidAnd( TankType = "Consumer Instantaneous (UEF)" ) .AND.
		          ( IfValidAnd( FlowRate < 0 ) .OR. IfValidAnd( FlowRate > 20 ) ) )
		      then
		        PostError("The Flow Rate for residential water heater '%s' 
		                   must be 20 or less.",Name)
		      else UNCHANGED
		      endif
		    else if( ElementType = "Electric Resistance" )
		    then
		      if( IfValidAnd( TankType = "Consumer Instantaneous (UEF)" ) .AND.
		          ( IfValidAnd( FlowRate < 0 ) .OR. IfValidAnd( FlowRate > 20 ) ) )
		      then
		        PostError("The Flow Rate for residential water heater '%s' 
		                   must be 20 or less.",Name)
		      else if( IfValidAnd( TankType = "Residential-Duty Commercial Instantaneous (UEF)" ) .AND.
		               ( IfValidAnd( FlowRate < 0 ) .OR. IfValidAnd( FlowRate > 20 ) ) )
		      then
		        PostError("The Flow Rate for residential water heater '%s' 
		                   must be 20 or less.",Name)
		      else UNCHANGED
		      endif endif
		    else UNCHANGED
		    endif endif
	    endif
	  endif
  SIZING_PROPOSED
    if( Proj:ResDHWBothBaseline )
    then 
      UNDEFINED
    else if( Proj:ResDHWUserAndBaseline .OR. Proj:ResDHWPropOnly )
    then 
      if ( IfValidAnd( IsUEFRtdSim = 1 ) )
      then
        u:FlowRate
      else
        UNDEFINED
      endif
    else if( Proj:ResDHWNone )
    then 
      UNDEFINED                                  // no DHW modeled
    else 
      UNDEFINED
    endif endif endif    
  SIZING_BASELINE
    if( LocalStatus(TankVol) > 0 ) 
    then
      if( Proj:ResDHWUserAndBaseline )
      then
	      if ( CentralSys .AND. IfValidAnd( IsUEFRtdSim = 1 ) ) // 7-5-18 NK Added to pass UEF Water Heater on Central Systems - Revise later once Res rules are updated
	      then
	        u:FlowRate
	      else
	        UNDEFINED
	      endif
      else if ( Proj:ResDHWBothBaseline )
      then
        UNDEFINED
      else if( Proj:ResDHWPropOnly )
      then 
        if (IfValidAnd( IsBaseSys > 0 ))
        then UNDEFINED
        else zp:FlowRate
        endif                
      else if( Proj:ResDHWNone )
      then 
        UNDEFINED
      else 
        UNDEFINED
      endif endif endif endif
    else
      UNDEFINED
    endif
  ANNUAL
    z:FlowRate
ENDRULE


// -----------------------------------------------------------------------------
// -------------- Residential Water Heater Exterior Tank Insulation --------------------
// 
RULE ResWtrHtr:TankExtInsR
  DESCRIPTION
    "The residential water heater's exterior insulation."
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    Optional
  REPORTPRECISION
    1
  DEFAULT
    if( (TankCat = "Boiler" .OR. TankCat = "Indirect") .AND. ElementType = "Gas" )
    then 
      12
    else
     UNDEFINED  
    endif
  SIZING_PROPOSED
    if( ExcludeWtrHtg )
    then 12
    else 
     if( IfValidAnd(ElementType = "Heat Pump") .AND. IfValidAnd(HtPumpWtrHtrNEEARtd = 1) )
     then UNDEFINED
     else 
       if( (TankCat = "Boiler" .OR. TankCat = "Indirect") .AND. ElementType = "Gas" ) 
       then 
         u:TankExtInsR
       else
         UNDEFINED
       endif
    endif endif
  SIZING_BASELINE
    if( Proj:ResDHWUserAndBaseline .OR. Proj:ResDHWBothBaseline )
    then 
      if ( IfValidAnd( TankIntInsR > 0 ) )
      then zp:TankExtInsR
      else 0
      endif
    else if( Proj:ResDHWPropOnly )
    then 
      if (IfValidAnd( IsBaseSys > 0 ))
      then 12
      else zp:TankExtInsR
      endif
    else if( Proj:ResDHWNone )
    then 
      UNDEFINED                                  // no DHW modeled
    else 
      UNDEFINED
    endif endif endif
  ANNUAL
    z:TankExtInsR
ENDRULE


// -----------------------------------------------------------------------------
// -------------- Residential Water Heater Interior Tank Insulation --------------------
// 
RULE ResWtrHtr:TankIntInsR
  DESCRIPTION
    "The residential water heater's interior insulation."
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    Optional
  REPORTPRECISION
    1
  DEFAULT
    if( (TankCat = "Boiler" .OR. TankCat = "Indirect") .AND. ElementType = "Gas" )
    then 
      0
    else
     UNDEFINED  
    endif
  SIZING_PROPOSED
    if( ExcludeWtrHtg )
    then 0
        else 
     if( IfValidAnd(ElementType = "Heat Pump") .AND. IfValidAnd(HtPumpWtrHtrNEEARtd = 1) )
     then UNDEFINED
     else 
      if( (TankCat = "Boiler" .OR. TankCat = "Indirect") .AND. ElementType = "Gas" ) 
      then 
        u:TankIntInsR
      else
        UNDEFINED
      endif
    endif endif
  SIZING_BASELINE
    if( Proj:ResDHWUserAndBaseline .OR. Proj:ResDHWBothBaseline )
    then 
      if ( IfValidAnd( TankIntInsR > 0 ) )
      then zp:TankIntInsR
      else 0
      endif
    else if( Proj:ResDHWPropOnly )
    then 
      if (IfValidAnd( IsBaseSys > 0 ))
      then 0
      else zp:TankIntInsR
      endif
    else if( Proj:ResDHWNone )
    then 
      UNDEFINED                                  // no DHW modeled
    else 
      UNDEFINED
    endif endif endif
  ANNUAL
    z:TankIntInsR
ENDRULE


// -------------- Tank Insulation Report --------------------
// 
RULE ResWtrHtr:TankInsRpt
  RULESETS
    T24N
  DESCRIPTION
    "Reporting variable for Tank Insulation"
  INPUTCLASS
    NotInput
  ANNUAL_PROPOSED
    if ( ExcludeWtrHtg )
    then UNDEFINED
    else
	    if( (TankCat = "Boiler" .OR. TankCat = "Indirect") .AND. ElementType = "Gas" )
	    then
		      Format ( FltToStr( TankExtInsR , 1 ) ) + "/" + 
		      Format ( FltToStr( TankIntInsR , 1 ) )
	    else
	      "NA"
	    endif
	  endif
  ANNUAL_BASELINE
    UNDEFINED
ENDRULE





// -----------------------------------------------------------------------------
// -------------- Residential Water Heater Standby Loss Fraction --------------------
// 
RULE ResWtrHtr:StdbyLossFrac
  DESCRIPTION
    "The residential water heater's standby loss fraction or pilot energy
     depending on Tank Category and Rated Capacity."
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    Optional
  MINIMUM
    0.0
  MAXIMUM
    10000
  REPORTPRECISION
    0
  DEFAULT
    if( IfValidAnd( TankType = "Boiler" ) .OR. IfValidAnd( TankType = "Indirect" ) )
    then 750
    else if( ElementType = "Gas" )
    then
      if( IfValidAnd( TankType = "Large Storage" ) .OR.
        ( IfValidAnd( TankType = "Large Instantaneous" ) .AND. TankVol >= 10 ) )
      then
        round ( (InpRating/800 + 110*SQRT( TankVol )) / (8.25 * 70 * TankVol), 5 )
      else UNDEFINED
      endif
    else if( ElementType = "Electric Resistance" )
    then
      if( IfValidAnd( TankType = "Large Storage" ) )
      then
       round ( ( 0.3 + 27/TankVol ) / 100, 5 )
      else UNDEFINED
      endif
    else UNDEFINED
    endif endif endif
  CHECKCODE           // Standby Loss Fraction
    if( ExcludeWtrHtg )
    then UNCHANGED
    else
	    if(      PilotDisp = 0 
	       .AND. SBLFDisp = 1
	       .AND. StdbyLossFrac = 0 
	       .AND. InpRating > 0 )
	    then
	      PostError("The standby loss fraction for residential water heater '%s' 
	                 must be greater than 0.",Name)
	    else UNCHANGED
	    endif
	  endif
  SIZING_PROPOSED
    if( Proj:ResDHWBothBaseline )
    then 
      if( CentralSys )  
      then
        if (IfValidAnd( IsBaseSys > 0 ))
        then
          0
        else if( ElementType = "Gas" )
        then
          if( IfValidAnd( TankType = "Large Storage" ) .OR.
            ( IfValidAnd( TankType = "Large Instantaneous" ) .AND. TankVol >= 10 ) )
          then
            round ( (InpRatingSim/800 + 110*SQRT( TankVol )) / (8.25 * 70 * TankVol), 5 )
          else UNDEFINED
          endif
        else if( ElementType = "Electric Resistance" )
        then
          if( IfValidAnd( TankType = "Large Storage" ) )
          then
            round ( ( 0.3 + 27/TankVol ) / 100, 5 )
          else UNDEFINED
          endif
        else UNDEFINED
        endif endif endif
      else
        0
      endif
    else if( Proj:ResDHWUserAndBaseline .OR. Proj:ResDHWPropOnly )
    then 
      if (IfValidAnd( IsBaseSys > 0 ))
      then
        0
      else zp:StdbyLossFrac
      endif
    else if( Proj:ResDHWNone )
    then 
      UNDEFINED                                  // individual unit ResDHW or no DHW modeled
    else 
      UNDEFINED
    endif endif endif
  SIZING_BASELINE      
    if( Proj:ResDHWUserAndBaseline .OR. Proj:ResDHWBothBaseline )
    then 
      if( CentralSys )  
      then
        if (IfValidAnd( IsBaseSys > 0 ))
        then
          0
        else if( ElementType = "Gas" )
        then
          if( ( IfValidAnd( TankType = "Large Storage" ) .AND. 
              ( TankCat = "Storage" .OR. TankCat = "Commercial Storage (TE & SBL)" ) ) ) // .OR. 
//              ( IfValidAnd( TankType = "Large Instantaneous" ) .AND. TankVol >= 10 ) ) .OR. 
//              ( TankCat = "Commercial Instantaneous (TE)" .AND. TankVol >= 10 ) )
          then
            round ( (InpRatingSim/800 + 110*SQRT( TankVol )) / (8.25 * 70 * TankVol), 5 )
          else
             if( IfValidAnd( TankType = "Large Instantaneous" ) .AND. TankVol >= 0 .AND. TankVol < 10 )
             then
               StdbyLossFrac
             else if( IfValidAnd( TankType = "Large Instantaneous" ) .AND. TankVol >= 10 )
             then
               round ( InpRatingSim/800 + 110*SQRT( TankVol ), 5 )
             else
               UNDEFINED  
             endif endif
          endif
        else if( ElementType = "Electric Resistance" )
        then
          if( IfValidAnd( TankType = "Large Storage" ) .AND. 
            ( ( TankCat = "Commercial Instantaneous (TE)" .AND. TankVol >= 10 ) .OR. 
              ( TankCat = "Storage" .OR. TankCat = "Commercial Storage (TE & SBL)" )  )  )
          then
            round ( ( 0.3 + 27/TankVol ) / 100, 5 )
          else UNDEFINED
          endif
        else UNDEFINED
        endif endif endif
      else
        0
      endif
    else if( Proj:ResDHWPropOnly )
    then 
      if (IfValidAnd( IsBaseSys > 0 ))
      then
        0
      else zp:StdbyLossFrac
      endif
    else if( Proj:ResDHWNone )
    then 
      UNDEFINED                                  // individual unit ResDHW or no DHW modeled
    else 
      UNDEFINED
    endif endif endif
  ANNUAL
     z:StdbyLossFrac
ENDRULE

//  ANNUAL_PROPOSED
//    if( ElementType = "Gas" .AND. IfValidAnd( TankType = "Large Instantaneous" ) .AND. 
//        IfValidAnd( TankVol >= 10 ) )
//    then
//      if( CentralSys )  
//      then
//        zp:StdbyLossFrac
//      else
//        zp:StdbyLossFrac * (8.25 * 70 * TankVol)  // Based on CBECC-Res using StandbyLossFrac for Standby Loss in this case      
//      endif
//    else
//      zp:StdbyLossFrac
//    endif   
//  ANNUAL_BASELINE
//    if( ElementType = "Gas" .AND. IfValidAnd( TankType = "Large Instantaneous" ) .AND. 
//        IfValidAnd( TankVol >= 10 ) )
//    then
//      zb:StdbyLossFrac * (8.25 * 70 * TankVol)  // Based on CBECC-Res using StandbyLossFrac for Standby Loss in this case      
//    else
//      zb:StdbyLossFrac
//    endif   


// -----------------------------------------------------------------------------
RULE ResDHWSys:SolFracFluidSysName
  DESCRIPTION
    "Name of the service hot water fluid system with a solar hot water collector."
  REFERENCE 
    ACM Section 5.2.1-General Information
  INPUTCLASS 
    Optional
  DEFAULT
    if( IfValidAnd(AnnualSolFrac > 0) )
    then Name
    else UNDEFINED
    endif
ENDRULE

// -----------------------------------------------------------------------------
RULE ResDHWSys:SolFracRpt
  DESCRIPTION
    "Solar Fraction value from Fluid System Data Tab."
  REFERENCE 
    ACM Section 5.2.1-General Information
  INPUTCLASS 
    Optional
  REPORTPRECISION
    2
  DEFAULT
    AnnualSolFrac
ENDRULE

// -----------------------------------------------------------------------------
// -------------- Residential Water Heater Pilot Energy --------------------
// 
RULE ResWtrHtr:PilotEngy
  DESCRIPTION
    "The residential water heater's pilot energy."
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    NotInput
  PREVIOUSNAMES  PilotEnergy
  MINIMUM
    0
  MAXIMUM
    10000
  REPORTPRECISION
    0
  DEFAULT
    if( PilotDisp = 1 )
    then 750
    else 0
    endif
  SIZING_PROPOSED
    if( Proj:ResDHWBothBaseline )
    then 
      0
    else if( Proj:ResDHWUserAndBaseline .OR. Proj:ResDHWPropOnly )
    then 
      if (IfValidAnd( IsBaseSys > 0 ))
      then
        0
      else
        PilotEngy
      endif
    else if( Proj:ResDHWNone )
    then 
      UNDEFINED                                  // individual unit ResDHW or no DHW modeled
    else 
      UNDEFINED
    endif endif endif
  SIZING_BASELINE
    if( Proj:ResDHWUserAndBaseline .OR. Proj:ResDHWBothBaseline )
    then 
      0
    else if( Proj:ResDHWPropOnly )
    then 
      if (IfValidAnd( IsBaseSys > 0 ))
      then
        0
      else
        zp:PilotEngy
      endif
    else if( Proj:ResDHWNone )
    then 
      UNDEFINED                                  // individual unit ResDHW or no DHW modeled
    else 
      UNDEFINED
    endif endif endif
  ANNUAL
    z:PilotEngy
ENDRULE



// -----------------------------------------------------------------------------
// ----------------- Efficiency for Report -------------------------------------
RULE ResWtrHtr:EffRpt
  RULESETS
    T24N
  INPUTCLASS
    NotInput
  ANNUAL_PROPOSED
    if ( ExcludeWtrHtg )
    then UNDEFINED
    else
	    if( IfValidAnd( IsUEFRtdSim = 1 ) ) then
	      Format("UEF: %s", FltToStr( UEF, 3 ) )
	    else if ( ElementType = "Heat Pump" .AND. IfValidAnd( HtPumpWtrHtrNEEARtd = 1 ) ) then
	      "NEEA Rated"    
	    else if( TEDisp = 1 ) then
	      Format("Thrml. Eff.: %s", FltToStr( ThrmlEff, 3 ) )
	    else
	      Format("EF: %s", FltToStr( EF, 3 ) )
	    endif endif endif
    endif
  ANNUAL_BASELINE
    UNDEFINED
ENDRULE

// -----------------------------------------------------------------------------
// ----------------- Standby Loss for Report -----------------------------------
RULE ResWtrHtr:StdbyLossRpt
  RULESETS
    T24N
  INPUTCLASS
    NotInput
  ANNUAL_PROPOSED
    if ( ExcludeWtrHtg )
    then UNDEFINED
    else
	    if( SBLFDisp = 1 )
	    then
		    if( ElementType = "Gas" .AND. IfValidAnd( TankType = "Large Instantaneous" ) .AND. 
		        IfValidAnd( TankVol >= 10 ) )
		    then
		      FltToStr( ( StdbyLossFrac / (8.25 * 70 * TankVol) ), 4 )
		    else
	        FltToStr( StdbyLossFrac, 4 )
		    endif   
	    else
	      "NA"
	    endif
	  endif
  ANNUAL_BASELINE
    UNDEFINED
ENDRULE

// -----------------------------------------------------------------------------
// -------------- Total Water Heater Input Rating --------------------
// 
RULE ResWtrHtr:InpRatingRpt
  DESCRIPTION
    "The heating capacity of a water heater at the rated conditions specified
     in DOE 10 CFR Part 430 or ANSI Z21.10."
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    NotInput
  UNITS
    kBtu/hr
  REPORTPRECISION
    0
  DEFAULT
    UNDEFINED
  SIZING_PROPOSED
    UNDEFINED
  SIZING_BASELINE
    UNDEFINED
  ANNUAL_PROPOSED
    if( ExcludeWtrHtg )
    then UNDEFINED
    else 
      if ( ElementType = "Gas" )
      then 
        InpRating / 1000     //this div by 1000 is a conversion for reporting from Btu/h to kBtu/h
      else if ( ElementType = "Electric Resistance" )
      then 
        InpRatingElec / 1000
      else if ( ElementType = "Heat Pump")
      then 
        InpRatingElec / 1000
      else 
        UNDEFINED
      endif endif endif
    endif
  ANNUAL_BASELINE
    UNDEFINED
ENDRULE

// -----------------------------------------------------------------------------
RULE ResWtrHtr:ElecMiniTank
  DESCRIPTION
    ""
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    Optional
  MINIMUM
    0 
  MAXIMUM
    1 
  DEFAULT
    if( Proj:AutoHardSize = 1 .AND. TankCat = "Instantaneous")
    then 0
    else UNDEFINED
    endif
ENDRULE

// -----------------------------------------------------------------------------
RULE ResWtrHtr:ElecMiniTankPwr
  DESCRIPTION
    ""
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    Optional
  UNITS
    Watts  
  DEFAULT
    if ( ElecMiniTank = 1 )
    then 100
    else UNDEFINED
    endif
  SIZING_PROPOSED
    if( ExcludeWtrHtg )
    then 0
    else u:ElecMiniTankPwr
    endif
  SIZING_BASELINE
    if( Proj:ResDHWUserAndBaseline )
    then 
      if( CentralSys )  
      then
        if (IfValidAnd( IsBaseSys > 0 ))
        then 0
        else UNDEFINED // zp:ElecMiniTankPwr
        endif
      else 0
      endif
    else if( Proj:ResDHWPropOnly )
    then 
      if (IfValidAnd( IsBaseSys > 0 ))
      then 0
      else
        zp:ElecMiniTankPwr
      endif
    else if( Proj:ResDHWBothBaseline )
    then 0
    else if( Proj:ResDHWNone )
    then 
      UNDEFINED                                  // individual unit ResDHW or no DHW modeled
    else 
      UNDEFINED
    endif endif endif endif
  ANNUAL
    z:ElecMiniTankPwr
ENDRULE

// -----------------------------------------------------------------------------
RULE ResWtrHtr:TankZn
  DESCRIPTION
    ""
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    Optional
  DEFAULT
    "Conditioned"
ENDRULE


// -------------- Tank Location Report --------------------
// 
RULE ResWtrHtr:TankZnRpt
  RULESETS
    T24N
  DESCRIPTION
    "Reporting variable for Tank Location or Ambient Condition"
  INPUTCLASS
    NotInput
  ANNUAL_PROPOSED
    if( ExcludeWtrHtg )
    then UNDEFINED
    else 
      if( ElementType = "Gas" .AND. TankCat = "Indirect") 
      then AmbCond
      else if( ElementType = "Heat Pump" )
      then TankZn
      else "NA"
      endif endif
    endif 
  ANNUAL_BASELINE
    UNDEFINED
ENDRULE


// -----------------------------------------------------------------------------
RULE ResWtrHtr:CprsrZn
  DESCRIPTION
    ""
  REFERENCE 
    Res ACM-2.10 Domestic Hot Water
  INPUTCLASS
    CondRequired
  DEFAULT
    if( ElementType = "Heat Pump" )
    then
      if ( IfValidAnd( HtPumpWtrHtrNEEARtd = 1 ) .AND. IfValidAnd( HPWHBrand = "Sanden" ) )
      then "Conditioned"
      else UNDEFINED
      endif
    else UNDEFINED
    endif 
  SIZING_PROPOSED
    if( Proj:ResDHWBothBaseline )
    then 
      UNDEFINED
    else if( Proj:ResDHWUserAndBaseline .OR. Proj:ResDHWPropOnly )
    then 
	    if( ElementType = "Heat Pump" )
	    then
	      if ( IfValidAnd( HtPumpWtrHtrNEEARtd = 1 ) .AND. IfValidAnd( HPWHBrand = "Sanden" ) )
	      then u:CprsrZn
	      else UNDEFINED
	      endif
	    else UNDEFINED
	    endif 
    else if( Proj:ResDHWNone )
    then 
      UNDEFINED                                  // no DHW modeled
    else 
      UNDEFINED
    endif endif endif    
  SIZING_BASELINE
    if( Proj:ResDHWUserAndBaseline .OR. Proj:ResDHWBothBaseline )
    then
      UNDEFINED
    else if( Proj:ResDHWPropOnly )
    then 
      if (IfValidAnd( IsBaseSys > 0 ))
      then UNDEFINED
      else 
		    if( ElementType = "Heat Pump" )
		    then
		      if ( IfValidAnd( HtPumpWtrHtrNEEARtd = 1 ) .AND. IfValidAnd( HPWHBrand = "Sanden" ) )
		      then zp:CprsrZn
		      else UNDEFINED
		      endif
		    else UNDEFINED
		    endif 
      endif                
    else if( Proj:ResDHWNone )
    then 
      UNDEFINED
    else 
      UNDEFINED
    endif endif endif
ENDRULE


// -----------------------------------------------------------------------------
RULE NEW ResWtrHtr:CprsrZnDisp
  DESCRIPTION
    "Flag to indicate on the ResWtrHtr input screen that the input for
     compressor zone location is to be displayed and editable."
  DATATYPE
    Integer
  INPUTCLASS
    NotInput
  DEFAULT
    if( ScreenVal = 11 .AND. IfValidAnd( HPWHBrand = "Sanden" ) )
    then 1
    else 0
    endif
ENDRULE



// +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
// +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
// -------- Added to facilitate CSE DHW system inputs -----------
//  SAC 5/26/16
RULE NEW Spc:ResDHWFlrHgtArea
  DATATYPE
    Float
  LONGFORM
    ResDHWFlrHgtArea
  DESCRIPTION
    "Flr area used to calculate average floor height for ResDHWSys."
  INPUTCLASS
    NotInput
  DEFAULT
    if (IfValidAnd( HaveResDHW > 0.5 ))
    then  DwellingUnitSpcTotAreaWithMult
    else  0
    endif
ENDRULE

RULE NEW Spc:ResDHWFlrHgtAreaXHgt
  DATATYPE
    Float
  LONGFORM
    ResDHWFlrHgtAreaXHgt
  DESCRIPTION
    "Flr area x ceiling height used to calculate average floor height for ResDHWSys."
  INPUTCLASS
    NotInput
  DEFAULT
    if (IfValidAnd( HaveResDHW > 0.5 ))
    then  DwellingUnitSpcTotAreaWithMult * FlrToCeilingHgt
    else  0
    endif
ENDRULE

RULE NEW ResDHWSys:AvgFlrHgt
  DATATYPE
    Float
  LONGFORM
    AverageFloorHeight
  DESCRIPTION
    "Average (flr area-weighted) floor height for across all served spaces."
  INPUTCLASS
    NotInput
  DEFAULT
    if (SumRevRef( Spc:ResDHWSysRef, Spc:ResDHWFlrHgtArea ) > 1)
    then  SumRevRef( Spc:ResDHWSysRef, Spc:ResDHWFlrHgtAreaXHgt ) /
          SumRevRef( Spc:ResDHWSysRef, Spc:ResDHWFlrHgtArea )
    else  0
    endif
ENDRULE

RULE NEW ResDHWSys:HWSupplyTemp
  DATATYPE
    Float
  LONGFORM
    HotWaterSupplyTemperature
  DESCRIPTION
    "Temperature of water supplied to the fixture."
  INPUTCLASS
    NotInput
  UNITS
    F
ENDRULE

RULE NEW ResDHWSys:HWDeltaTemp
  DATATYPE
    Float
  LONGFORM
    HotWaterDeltaTemperature
  DESCRIPTION
    "Temperature drop from heater to fixture."
  INPUTCLASS
    NotInput
  UNITS
    F
ENDRULE

RULE NEW ResDHWSys:DistribSysMult
  DATATYPE
    Float
  LONGFORM
    DistributionSystemMultiplier
  DESCRIPTION
    "Multiplier used to adjust HW distribution losses."
  INPUTCLASS
    NotInput
ENDRULE

RULE NEW ResDHWSys:NumDUsServed
  DATATYPE
    Float
  LONGFORM
    NumberOfDwellingUnitsServed
  DESCRIPTION
    "Number of dwelling units served by this DHW system (used for central systems)."
  INPUTCLASS
    NotInput
  DEFAULT
    SumRevRef( Spc:ResDHWSysRef, Spc:ResLivingUnitCntWithMult ) +
    SumRevRef( Spc:ResDHWSysRef, Spc:HotelMotelGuestRmCntWithMult )
ENDRULE

RULE NEW ResWtrHtr:ElementTypeNum
  DATATYPE
    Integer
  LONGFORM
    ElementTypeNumber
  DESCRIPTION
    "Map back to CBECC-Res HeaterElementType."
  INPUTCLASS
    NotInput
  DEFAULT
    switch ( ElementType )
      case  "Electric Resistance" :	 0
      case  "Gas"                 :  1
      case  "Heat Pump"           :  if (Proj:CSE_DHWUseMthd == "New (via wsDayUse)")
                                     then  5
                                     else  3
                                     endif
      default :  -1
    endswitch
  SIZING
    switch ( ElementType )
      case  "Electric Resistance" :	 0
      case  "Gas"                 :  1
      case  "Heat Pump"           :  if (Proj:CSE_DHWUseMthd == "New (via wsDayUse)")
                                     then  5
                                     else  3
                                     endif
      default :  -1
    endswitch
  ANNUAL
    switch ( ElementType )
      case  "Electric Resistance" :	 0
      case  "Gas"                 :  1
      case  "Heat Pump"           :  if (Proj:CSE_DHWUseMthd == "New (via wsDayUse)")
                                     then  5
                                     else  3
                                     endif
      default :  -1
    endswitch
ENDRULE

RULE NEW ResWtrHtr:CSE_SimulateTank
  DATATYPE
    Integer
  LONGFORM
    CSE_SimulateTank
  DESCRIPTION
    "Flag indicating that heater tank is of a type that requires simulation."
  INPUTCLASS
    NotInput
  DEFAULT
    if (IfValidAnd( TankType = "Large Storage" ) .OR.
        IfValidAnd( TankType = "Small Storage" ) .OR.
        IfValidAnd( TankType = "Small Instantaneous"           ) .OR.
        IfValidAnd( TankType = "Consumer Instantaneous (UEF)"  ) .OR.
        IfValidAnd( TankType = "Consumer Storage (UEF)"        ) .OR.
        IfValidAnd( TankType = "Commercial Storage (TE & SBL)" ) .OR.
        IfValidAnd( TankType = "Residential-Duty Commercial Storage (UEF)" ) .OR.
        IfValidAnd( TankType = "Residential-Duty Commercial Instantaneous (UEF)" ) .OR.
        ( IfValidAnd( TankVolume > 0.001 )==0 .AND.
          IfValidAnd( TankType = "Indirect" )==0 ))
    then  0
    else  1
    endif
  SIZING
    if (IfValidAnd( TankType = "Large Storage" ) .OR.
        IfValidAnd( TankType = "Small Storage" ) .OR.
        IfValidAnd( TankType = "Small Instantaneous"           ) .OR.
        IfValidAnd( TankType = "Consumer Instantaneous (UEF)"  ) .OR.
        IfValidAnd( TankType = "Consumer Storage (UEF)"        ) .OR.
        IfValidAnd( TankType = "Commercial Storage (TE & SBL)" ) .OR.
        IfValidAnd( TankType = "Residential-Duty Commercial Storage (UEF)" ) .OR.
        IfValidAnd( TankType = "Residential-Duty Commercial Instantaneous (UEF)" ) .OR.
        ( IfValidAnd( TankVolume > 0.001 )==0 .AND.
          IfValidAnd( TankType = "Indirect" )==0 ))
    then  0
    else  1
    endif
  ANNUAL
    if (IfValidAnd( TankType = "Large Storage" ) .OR.
        IfValidAnd( TankType = "Small Storage" ) .OR.
        IfValidAnd( TankType = "Small Instantaneous"           ) .OR.
        IfValidAnd( TankType = "Consumer Instantaneous (UEF)"  ) .OR.
        IfValidAnd( TankType = "Consumer Storage (UEF)"        ) .OR.
        IfValidAnd( TankType = "Commercial Storage (TE & SBL)" ) .OR.
        IfValidAnd( TankType = "Residential-Duty Commercial Storage (UEF)" ) .OR.
        IfValidAnd( TankType = "Residential-Duty Commercial Instantaneous (UEF)" ) .OR.
        ( IfValidAnd( TankVolume > 0.001 )==0 .AND.
          IfValidAnd( TankType = "Indirect" )==0 ))
    then  0
    else  1
    endif
ENDRULE



// ----------------------------------------------------------------------------- - SAC 8/9/18
// ---------- Added to enable port of Baseline DHW Rules from Res ruleset ------

; SAC 1/24/19 - added to facilitate small central HPWH std design sizing (HPWHSIZE)
RULE NEW ResDHWSys:NumGasHtrs
  DATATYPE
    Integer
  DESCRIPTION
    "Flag indicating whether any child ResWtrHtrs are Fuel powered."
  INPUTCLASS
    NotInput
  DEFAULT
    SumChildrenIf( ResWtrHtr:Cnt, ResWtrHtr:ElementType = "Gas" )
  SIZING
    SumChildrenIf( ResWtrHtr:Cnt, ResWtrHtr:ElementType = "Gas" )
ENDRULE

RULE NEW ResWtrHtr:HtrTypeNum
  DATATYPE
    Integer
  LONGFORM
    HeaterTypeNumber
  DESCRIPTION
    "# consistent w/ TankType enum value - incl. differentiate original Elec/Gas ConsInst from new CSE model"
  INPUTCLASS
    NotInput
  DEFAULT
    if (ElementType == "Gas" .AND.
        TankType == "Consumer Instantaneous (UEF)" .AND.
        IfValidAnd( Proj:EngyCodeYearNum >= 2019 ))   ; no use of InstantaneousUEF CSE type in <=2016 analysis
    then  9
    else  switch (TankType)
            case "Boiler"                                          :  0
            case "Indirect"                                        :  1
            case "Large Instantaneous"                             :  2
            case "Large Storage"                                   :  3
            case "Small Instantaneous"                             :  5
            case "Small Storage"                                   :  6
            case "Consumer Instantaneous (UEF)"                    : 10
            case "Commercial Instantaneous (TE)"                   : 11
            case "Consumer Storage (UEF)"                          : 12
            case "Commercial Storage (TE & SBL)"                   : 13
            case "Residential-Duty Commercial Storage (UEF)"       : 14
            case "Residential-Duty Commercial Instantaneous (UEF)" : 15
            default : -1
          endswitch endif
  SIZING
    if (ElementType == "Gas" .AND.
        TankType == "Consumer Instantaneous (UEF)" .AND.
        IfValidAnd( Proj:EngyCodeYearNum >= 2019 ))   ; no use of InstantaneousUEF CSE type in <=2016 analysis
    then  9
    else  switch (TankType)
            case "Boiler"                                          :  0
            case "Indirect"                                        :  1
            case "Large Instantaneous"                             :  2
            case "Large Storage"                                   :  3
            case "Small Instantaneous"                             :  5
            case "Small Storage"                                   :  6
            case "Consumer Instantaneous (UEF)"                    : 10
            case "Commercial Instantaneous (TE)"                   : 11
            case "Consumer Storage (UEF)"                          : 12
            case "Commercial Storage (TE & SBL)"                   : 13
            case "Residential-Duty Commercial Storage (UEF)"       : 14
            case "Residential-Duty Commercial Instantaneous (UEF)" : 15
            default : -1
          endswitch endif
  ANNUAL
    if (ElementType == "Gas" .AND.
        TankType == "Consumer Instantaneous (UEF)" .AND.
        IfValidAnd( Proj:EngyCodeYearNum >= 2019 ))   ; no use of InstantaneousUEF CSE type in <=2016 analysis
    then  9
    else  switch (TankType)
            case "Boiler"                                          :  0
            case "Indirect"                                        :  1
            case "Large Instantaneous"                             :  2
            case "Large Storage"                                   :  3
            case "Small Instantaneous"                             :  5
            case "Small Storage"                                   :  6
            case "Consumer Instantaneous (UEF)"                    : 10
            case "Commercial Instantaneous (TE)"                   : 11
            case "Consumer Storage (UEF)"                          : 12
            case "Commercial Storage (TE & SBL)"                   : 13
            case "Residential-Duty Commercial Storage (UEF)"       : 14
            case "Residential-Duty Commercial Instantaneous (UEF)" : 15
            default : -1
          endswitch endif
ENDRULE


