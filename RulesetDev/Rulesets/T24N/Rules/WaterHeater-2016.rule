// Water Heating
// For all Space Types with Hot Water Heating Rates
//
// -------------------------------------------------------------------------
//  Copyright (c) 2012-2017, California Energy Commission
//  All rights reserved.
//  Redistribution and use in source and binary forms, with or without
//  modification, are permitted provided that the following conditions are
//  met:
// 
//    * Redistributions of source code must retain the above copyright
//  notice, this list of conditions and the following disclaimer.
//    * Redistributions in binary form must reproduce the above copyright
//  notice, this list of conditions and the following disclaimer in
//  the documentation and/or other materials provided with the
//  distribution.
//    * Neither the name of the California Energy Commission nor the names of its
//  contributors may be used to endorse or promote products
//  derived from this software without specific prior written
//  permission.
//
//  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS
//  IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED
//  TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A
//  PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL CALIFORNIA ENERGY COMMISSION
//  BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
//  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
//  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR
//  BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
//  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR
//  OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
//  ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
// -------------------------------------------------------------------------
//



// -------------- SHW Fluid System Status --------------------
RULE NEW FluidSys:IsNewSHW
  DATATYPE
    Integer
  LONGFORM
    IsNewServiceHotWater
  INPUTCLASS
    NotInput
  DEFAULT
    if( Type = "ServiceHotWater" .AND. ( Status = "New" .OR. Status = "Altered") ) then 1 else 0 endif
ENDRULE

// -----------------------------------------------------------------------------
RULE NEW FluidSys:IsExistingSHW
  DATATYPE
    Integer
  LONGFORM
    IsExistingServiceHotWater
  INPUTCLASS
    NotInput
  DEFAULT
    if( Type = "ServiceHotWater" .AND. Status = "Existing" ) then 1 else 0 endif
ENDRULE

// -----------------------------------------------------------------------------
RULE NEW FluidSys:InBldgSHW
  DATATYPE
    Integer
  LONGFORM
    InBuildingServiceHotWater
  DESCRIPTION
    "This is used to count the number of SHW Fluid Systems in the building."
  INPUTCLASS
    NotInput
  DEFAULT
    if( IsNewSHW .OR. IsExistingSHW ) then 1 else 0 endif
ENDRULE


// -------------- Water Heater Status --------------------
RULE WtrHtr:Status
  DESCRIPTION
    "The status of the system or component, used for additions and alterations."
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    Required
  DEFAULT              
    if( Parent( IsNewSHW ) ) 
    then 
      "New" 
    else 
      "Existing" 
    endif             
//    if( Proj:IsAlt )
//    then "Existing"
//    else "New"
//    endif
  CHECKCODE
    if( ( Parent( IsNewSHW ) = 1 .AND. Status != "New" ) .OR.
        ( Parent( IsExistingSHW ) = 1 .AND. Status = "New" ) )
    then
      PostError("Water Heater '%s' has a Status of '%s', but the fluid system has a status of '%s'.
                   Please change the status of the fluid system or the water heater to be similar
                   for compliance analysis.", Name, Status, Parent (Status) )
    else UNCHANGED
    endif
ENDRULE

// -----------------------------------------------------------------------------
RULE NEW WtrHtr:IsNewSHW
  DATATYPE
    Integer
  LONGFORM
    IsNewServiceHotWater
  INPUTCLASS
    NotInput
  DEFAULT
    if( Status = "New" ) then 1 else 0 endif
ENDRULE

// -----------------------------------------------------------------------------
RULE NEW WtrHtr:IsExistingSHW
  DATATYPE
    Integer
  LONGFORM
    IsExistingServiceHotWater
  INPUTCLASS
    NotInput
  DEFAULT
    if( Status = "Existing" ) then 1 else 0 endif
ENDRULE

// -----------------------------------------------------------------------------
RULE NEW WtrHtr:InBldgSHW
  DATATYPE
    Integer
  LONGFORM
    InBuildingServiceHotWater
  DESCRIPTION
    "This is used to count the number of Water Heaters in the building."
  INPUTCLASS
    NotInput
  DEFAULT
    if( IsNewSHW .OR. IsExistingSHW ) then 1 else 0 endif
ENDRULE


// ---------- Any SHW Fluid Systems in the Building Are New --------------
RULE NEW Proj:IsNewSHW
  DATATYPE
    Integer
  LONGFORM
    IsNewServiceHotWater
  DESCRIPTION
    "This is the boolean for yes(1) all SHW fluid systems are new
     or no (0), not all of the SHW fluid systems are new."
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    NotInput
  DEFAULT
    if( SumAll(FluidSys:IsNewSHW) = SumAll(FluidSys:InBldgSHW) )
    then 1
    else 0
    endif
ENDRULE

// ---------- Any SHW Fluid Systems in the Building Are Existing --------------
RULE NEW Proj:IsExistingSHW
  DATATYPE
    Integer
  LONGFORM
    IsExistingServiceHotWater
  DESCRIPTION
    "This is the boolean for yes(1) all SHW fluid systems are existing
     or no (0), not all of the SHW fluid systems are existing."
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    NotInput
  DEFAULT
    if( SumAll(FluidSys:IsExistingSHW) = SumAll(FluidSys:InBldgSHW) )
    then 1
    else 0
    endif
ENDRULE



// ---------- All Water Heaters in the building are New --------------
RULE NEW Proj:IsNewWtrHtrSHW
  DATATYPE
    Integer
  LONGFORM
    IsNewWaterHeaterServiceHotWater
  DESCRIPTION
    "This is the boolean for yes(1) all water heaters on the fluid system are new
     or no (0), not all of the water heaters on the fluid system are new."
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    NotInput
  DEFAULT
    if( SumAll(WtrHtr:IsNewSHW) = SumAll(WtrHtr:InBldgSHW) )
    then 1
    else 0
    endif
ENDRULE


// ---------- Any SHW Fluid Systems in the Building Are Existing --------------
RULE NEW Proj:IsNewSHWFluidSys
  DATATYPE
    Integer
  LONGFORM
    IsNewServiceHotWaterFluidSystem
  DESCRIPTION
    "This is the boolean for yes(1) one SHW Fluid Systems in the building is new
     or no (0), none of the SHW Fluid Systems in the building are new."
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    NotInput
  DEFAULT
    if( Proj:IsNewSHW > 0 .OR. Proj:IsNewWtrHtrSHW > 0 ) // Remove condition for IsNewWtrHtrSHW
    then 1
    else 0
    endif
ENDRULE

// ---------- Any SHW Fluid Systems in the Building Are Existing --------------
RULE NEW Proj:IsExistingSHWFluidSys
  DATATYPE
    Integer
  LONGFORM
    IsExistingServiceHotWaterFluidSystem
  DESCRIPTION
    "This is the boolean for yes(1) one SHW Fluid Systems in the building is existing
     or no (0), none of the SHW Fluid Systems in the building are existing."
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    NotInput
  DEFAULT
    if( Proj:IsExistingSHW > 0 .OR. Proj:IsNewWtrHtrSHW > 0 ) // Remove condition for IsNewWtrHtrSHW
    then 1
    else 0
    endif
  CHECKCODE
    if( Proj:IsNewSHWFluidSys < 1 .AND. Proj:IsExistingSHWFluidSys < 1) 
    then
      PostError("Project has a combination of new and existing Service Hot Water systems. 
                 This is currently not supported. Please model the Service Hot Water systems 
                 either as all new, or all existing or exclude them from performance analysis
                 to prescriptively comply with code.")
    else UNCHANGED
    endif
ENDRULE


// ---------- Count Fluid Systems of Type Service Hot Water --------------
RULE NEW FluidSys:SHWOnOff
  DATATYPE
    Integer
  LONGFORM
    ServiceHotWaterOnOff
  DESCRIPTION
    "This changes the Fluid System of Type - Service Hot Water 
     to an On(1) or Off(0)."
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    NotInput
  DEFAULT
    if( FluidSys:Type = "ServiceHotWater" )
    then 1
    else 0
    endif
ENDRULE

// ---------- Count Fluid Systems of Type Service Hot Water --------------
RULE NEW Proj:ResDHWSys:DHWOnOff
  DATATYPE
    Integer
  LONGFORM
    DomesticHotWaterOnOff
  DESCRIPTION
    "This changes the Fluid System of Type - Service Hot Water 
     to an On(1) or Off(0)."
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    NotInput
  DEFAULT
    if( Status = "New" .OR. Status = "Existing" )
    then 1
    else 0
    endif
ENDRULE

// ---------- Count Fluid Systems of Type Service Hot Water --------------
RULE NEW Proj:DHWFluidSysCnt
  DATATYPE
    Integer
  LONGFORM
    DomesticHotWaterFluidSystemCount
  DESCRIPTION
    "This is the count of the fluid systems of type Service Hot Water."
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    NotInput
  DEFAULT
    SumChildren(ResDHWSys:DHWOnOff)
ENDRULE

// ---------- Count Fluid Systems of Type Service Hot Water --------------
RULE NEW Proj:SHWFluidSysCnt
  DATATYPE
    Integer
  LONGFORM
    ServiceHotWaterFluidSystemCount
  DESCRIPTION
    "This is the count of the fluid systems of type Service Hot Water."
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    NotInput
  DEFAULT
    SumChildren(FluidSys:SHWOnOff)
ENDRULE

// ---------- Count Water Heaters in Project --------------
RULE NEW Proj:SHWWtrHtrCnt
  DATATYPE
    Integer
  LONGFORM
    ServiceHotWaterWaterHeaterCount
  DESCRIPTION
    "This is the count of the Water Heaters assigned to fluid system type Service Hot Water."
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    NotInput
  DEFAULT
    SumChildren(WtrHtr:FluidSysCnt)
ENDRULE


// -----------------------------------------------------------------------------
RULE WtrHtr:Name
  SIZING_PROPOSED
    Name
  SIZING_BASELINE
    Name
  ANNUAL_PROPOSED
    Name
  ANNUAL_BASELINE
    Name
ENDRULE

// -------------- Duplicate Water Heater Count --------------------
RULE WtrHtr:Cnt
  DESCRIPTION
    "This is the number of duplicate water heaters."
  HELP
    "This duplication number is only applicable for multiple water heaters
     that are identical in every way and in the same space or zone location."
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    Default
  MINIMUM
    1
  MAXIMUM
    1000
  REPORTPRECISION
    0
  DEFAULT
    1
  SIZING_PROPOSED
    if( Parent(Type) = "ServiceHotWater" )  
    then
      if( Proj:SHWUserAndBaseline .OR. Proj:SHWPropOnly )
      then
        u:Cnt
      else if( Proj:SHWBothBaseline )
      then
        1        
      else if( Proj:SHWNone )
      then 
        UNDEFINED
      else 
        UNDEFINED
      endif endif endif
    else UNDEFINED
    endif
  SIZING_BASELINE
    if( Parent(Type) = "ServiceHotWater" )  
    then
      if( Proj:SHWPropOnly )
      then
        u:Cnt
      else if( Proj:SHWUserAndBaseline .OR. Proj:SHWBothBaseline )
      then
        1               
      else if( Proj:SHWNone )
      then 
        UNDEFINED
      else 
        UNDEFINED
      endif endif endif
    else UNDEFINED
    endif
 ANNUAL_PROPOSED
    zp:Cnt
  ANNUAL_BASELINE
    zb:Cnt
ENDRULE


// -------------- Duplicate Water Heater Count at Water Heater --------------------
RULE WtrHtr:FluidSysCnt
  DESCRIPTION
    "This is the total number of water heaters including fluid system 
     multipliers."
  DEFAULT
    if( Parent(Type) = "ServiceHotWater" )
    then( Parent(Cnt) * WtrHtr:Cnt )
    else UNDEFINED
    endif
  SIZING_PROPOSED
    if( Parent(Type) = "ServiceHotWater" )  
    then
      if( Proj:SHWUserAndBaseline .OR. Proj:SHWPropOnly )
      then
        u:FluidSysCnt
      else if( Proj:SHWBothBaseline )
      then
        1        
      else if( Proj:SHWNone )
      then 
        UNDEFINED
      else 
        UNDEFINED
      endif endif endif
    else UNDEFINED
    endif
  SIZING_BASELINE
    if( Parent(Type) = "ServiceHotWater" )  
    then
      if( Proj:SHWPropOnly )
      then
        u:FluidSysCnt
      else if( Proj:SHWUserAndBaseline .OR. Proj:SHWBothBaseline )
      then
        1
      else if( Proj:SHWNone )
      then 
        UNDEFINED
      else 
        UNDEFINED
      endif endif endif
    else UNDEFINED
    endif
  ANNUAL_PROPOSED
    zp:FluidSysCnt
  ANNUAL_BASELINE
    zb:FluidSysCnt
ENDRULE


// -------------- Water Heater Hot Water Heating Schedule Reference -----------
RULE FluidSys:AvailSchRef
  DESCRIPTION
    "Availability of the Fluid System for Water Heaters is set to ON."
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    Default
  SIZING
    if( FluidSys:Type = "ServiceHotWater" ) 
    then RuleLibrary(Schedule, ("On"))
    else  UNCHANGED
    endif
  ANNUAL
    z:AvailSchRef
ENDRULE


// -------------- Service Hot Water System Count --------------------
RULE FluidSys:SHWSysCnt
  DESCRIPTION
    "This is the number of unique water heaters on one Fluid System."
  HELP
    "This number is used to distribute proposed loads from the Space level
     across multiple Water Heaters on the same Fluid System."
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    NotInput  IgnoreUserInput  "FluidSys:SHWSysCnt removed prior to release of 2016.3.0"
  MINIMUM
    0
  MAXIMUM
    100 
  REPORTPRECISION
    0
  DEFAULT
    if( Type = "ServiceHotWater" )
    then ChildCount(WtrHtr)
    else UNDEFINED
    endif
  CHECKSIM
    if( Type = "ServiceHotWater" .AND. IfValidAnd( SHWSysCnt > 0 )==0 ) then
      PostError("ServiceHotWater fluid system '%s' has no water heaters 
                 assigned.  Water heaters are required.", Name )
    else UNCHANGED
    endif
  SIZING_PROPOSED
    if( Type = "ServiceHotWater" )  
    then
      if( Proj:SHWUserAndBaseline .OR. Proj:SHWPropOnly )
      then
        ChildCount(WtrHtr)
      else if( Proj:SHWBothBaseline )
      then
        1        
      else if( Proj:SHWNone )
      then 
        UNDEFINED
      else 
        UNDEFINED
      endif endif endif
    else UNDEFINED
    endif
  SIZING_BASELINE
    if( Type = "ServiceHotWater" )  
    then
      if( Proj:SHWPropOnly )
      then
        ChildCount(WtrHtr)
      else if( Proj:SHWUserAndBaseline .OR. Proj:SHWBothBaseline )
      then
        1               
      else if( Proj:SHWNone )
      then 
        UNDEFINED
      else 
        UNDEFINED
      endif endif endif
    else UNDEFINED
    endif
  ANNUAL_PROPOSED
    zp:SHWSysCnt
  ANNUAL_BASELINE
    zb:SHWSysCnt
ENDRULE
    
// -------------- Water Heater Type --------------------
RULE WtrHtr:Type
  DESCRIPTION
    "Water heater type - conventional, packaged heat pump or split heat pump."
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    Default
;  OPTION      - SAC 2/14/17 - ported to BEMEnums to enable backward compat for 2016.2.0 -> 2016.2.2
;    Conventional
;    HeatPumpPackaged
;    HeatPumpSplit
  DEFAULT
    Conventional
  CHECKCODE
    if( FuelSrc != "Electricity" .AND. Type <> "Conventional" )
    then
      PostError("Heat pump water heaters must be electric, please revise
                 the fuel source or type for water heater '%s'.", Name)
    else UNCHANGED
    endif
  SIZING_PROPOSED
    if( Parent(Type) = "ServiceHotWater" )  
    then
      if( Proj:SHWUserAndBaseline .OR. Proj:SHWPropOnly )
      then
        u:Type
      else if( Proj:SHWBothBaseline )
      then
        "Conventional"        
      else if( Proj:SHWNone )
      then 
        UNDEFINED
      else 
        UNDEFINED
      endif endif endif
    else UNDEFINED
    endif
//  SIZING_BASELINE : T24N_2016
//    if( Parent(Type) = "ServiceHotWater" )  
//    then
//      if( Proj:SHWPropOnly )
//      then
//        u:Type
//      else if( Proj:SHWUserAndBaseline .OR. Proj:SHWBothBaseline )
//      then
//        "Conventional"
//      else if( Proj:SHWNone )
//      then 
//        UNDEFINED
//      else 
//        UNDEFINED
//      endif endif endif
//    else UNDEFINED
//    endif
  SIZING_BASELINE
    if( Parent(Type) = "ServiceHotWater" )  
    then
      if( Proj:SHWPropOnly )
      then
        u:Type
      else if( Proj:SHWUserAndBaseline .OR. Proj:SHWBothBaseline )
      then
        "Conventional"               
      else if( Proj:SHWNone )
      then 
        UNDEFINED
      else 
        UNDEFINED
      endif endif endif
    else UNDEFINED
    endif
  ANNUAL_PROPOSED
    zp:Type
  ANNUAL_BASELINE  
    zb:Type
ENDRULE




// -------------- Water Heater Fuel Source --------------------
RULE WtrHtr:FuelSrc
  DESCRIPTION
    "This is the selection of the Water Heater Fuel Source."
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    Required
  UNITS
  DEFAULT
    if( FluidSys:Type = "ServiceHotWater" )
    then "Gas"
    else UNDEFINED
    endif
  CHECKCODE
    if( Proj:GasType = "None" .AND. FuelSrc = "Gas" )
    then
      PostError("Water heater '%s' is gas fired but the project 
                 gas type is specified as none.  Change the fuel source 
                 for the water heater or the project gas type.", Name)
    else UNCHANGED
    endif
  SIZING_PROPOSED
    if( Parent(Type) = "ServiceHotWater" )  
    then
      if( Proj:SHWUserAndBaseline .OR. Proj:SHWPropOnly )
      then
        u:FuelSrc
      else if( Proj:SHWBothBaseline )
      then
        "Gas"        
      else if( Proj:SHWNone )
      then 
        UNDEFINED
      else 
        UNDEFINED
      endif endif endif
    else UNDEFINED
    endif
  SIZING_BASELINE
    if( Parent(Type) = "ServiceHotWater" )  
    then
      if( Proj:SHWPropOnly )
      then
        u:FuelSrc
      else if( Proj:SHWUserAndBaseline .OR. Proj:SHWBothBaseline )
      then
        "Gas"               
      else if( Proj:SHWNone )
      then 
        UNDEFINED
      else 
        UNDEFINED
      endif endif endif
    else UNDEFINED
    endif
  ANNUAL_PROPOSED
    zp:FuelSrc
  ANNUAL_BASELINE
    zb:FuelSrc
ENDRULE


// -------------- Water Heater Fuel Source Report --------------
RULE WtrHtr:FuelSrcRpt
  RULESETS
    T24N
  DESCRIPTION
    "Translates FuelSrc to FuelSrcRpt."
  INPUTCLASS
    NotInput
  OPTION
    Electricity
    Fuel Oil #1
    Natural Gas
    Propane Gas
  ANNUAL_PROPOSED
    if( Fuelsrc = "Electricity" )
    then 
      "Electricity"
    else if( Fuelsrc = "FuelOil#1" )
      then 
        "Fuel Oil #1"
    else if( Fuelsrc = "Gas" .AND. Proj:GasType = "NaturalGas" )
      then 
        "Natural Gas"
    else if( Fuelsrc = "Gas" .AND. Proj:GasType = "Propane"  )
      then 
        "Propane Gas"
    else 
      UNDEFINED
    endif endif endif endif
  ANNUAL_BASELINE
    UNDEFINED
ENDRULE


// -------------- Water Heater Ignition Type --------------------
RULE WtrHtr:ElecIgnit
  DESCRIPTION
    "Does the water heater have an electrical ignition?"
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  DEFAULT
    0
  SIZING_PROPOSED
    if( Parent(Type) = "ServiceHotWater" )  
    then
      if( Proj:SHWUserAndBaseline .OR. Proj:SHWPropOnly )
      then
        u:ElecIgnit
      else if( Proj:SHWBothBaseline )
      then
        0        
      else if( Proj:SHWNone )
      then 
        UNDEFINED
      else 
        UNDEFINED
      endif endif endif
    else UNDEFINED
    endif
  SIZING_BASELINE
    if( Parent(Type) = "ServiceHotWater" )  
    then
      if( Proj:SHWPropOnly )
      then
        u:ElecIgnit
      else if( Proj:SHWUserAndBaseline .OR. Proj:SHWBothBaseline )
      then
        0               
      else if( Proj:SHWNone )
      then 
        UNDEFINED
      else 
        UNDEFINED
      endif endif endif
    else UNDEFINED
    endif
  ANNUAL_PROPOSED
    zp:ElecIgnit
  ANNUAL_BASELINE
    zb:ElecIgnit
ENDRULE


// -------------- Water Heater Is UEF Rated --------------------
RULE WtrHtr:IsUEFRtd
  DESCRIPTION
    "A flag to indicate whether UEF is used to describe the water heater 
     efficiency."
  HELP
    "The water heater has a UEF efficiency rating.  The UEF input box only appears 
      if the input rating and volume fit into a standards classification that uses UEF."  
  REFERENCE 
    ACM-5.9.1 Water Heating
  DEFAULT
    0
  SIZING_PROPOSED
    if( Parent(Type) = "ServiceHotWater" )  
    then
      if( Proj:SHWUserAndBaseline .OR. Proj:SHWPropOnly )
      then
        u:IsUEFRtd
      else if( Proj:SHWBothBaseline )
      then
        0        
      else if( Proj:SHWNone )
      then 
        UNDEFINED
      else 
        UNDEFINED
      endif endif endif
    else UNDEFINED
    endif
  SIZING_BASELINE
    if( Parent(Type) = "ServiceHotWater" )  
    then
      if( Proj:SHWPropOnly )
      then
        u:IsUEFRtd
      else if( Proj:SHWUserAndBaseline .OR. Proj:SHWBothBaseline )
      then
        UNDEFINED               
      else if( Proj:SHWNone )
      then 
        UNDEFINED
      else 
        UNDEFINED
      endif endif endif
    else UNDEFINED
    endif
  ANNUAL_PROPOSED
    zp:IsUEFRtd
  ANNUAL_BASELINE
    zb:IsUEFRtd
ENDRULE


// -------------- Water Heater Rated Input - Heat Pump Water Heaters
RULE WtrHtr:InpPwr
  DESCRIPTION
    "This is a heat pump water heater's rated input capacity."
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    CondRequired
  MINIMUM
    0
  UNITS
    kW
  REPORTPRECISION
    1
  DEFAULT
    if( Proj:AutoHardSize = 1 )
    then 
       if( Parent(Type) = "ServiceHotWater" .AND. Type <> "Conventional" )
       then 
         Int(FluidSys:TotCapRtdBase) * 0.8 / 3.412 / 1000 / 3         // Convert capacity from Btuh to kW using efficiency of 80% and COP = 3
       else if( LocalStatus(CapRtd) > 0 )
       then 
          CapRtd / 3.412 / 1000
       else
         Int(FluidSys:TotCapRtdBase) / 3.412 / 1000 
       endif endif
    else 
      if( Parent(Type) = "ServiceHotWater" )
      then 
         if(FuelSrc = "Gas" )
         then
           UNDEFINED
         else if( FuelSrc = "Electricity" .AND. Type = "Conventional" .AND. LocalStatus(CapRtd) > 0  .AND. LocalStatus(InpPwr) < 6 )
         then
           CapRtd / 3.412 / 1000  
         else
           UNCHANGED
         endif endif
      else      
        UNDEFINED
      endif
    endif
  CHECKCODE
    if( Type = "Conventional" .AND. FuelSrc != "Electricity" )
    then UNCHANGED
    else if( (LocalStatus(InpPwr) < 1 ) .AND. FluidSys:Type = "ServiceHotWater" )
    then
      PostError("All electric water heaters require a rated input.
                 Check values for water heater '%s'.", Name)
    else if( InpPwr <= 0 )
    then
      PostError("All electric water heaters require a nonzero rated input.  
                 Check values for water heater '%s'.", Name)
    else UNCHANGED
    endif endif endif
  SIZING_PROPOSED
    if( Parent(Type) = "ServiceHotWater" ) 
    then
	    if( Proj:SHWUserAndBaseline .OR. Proj:SHWPropOnly )
	    then 
	      u:InpPwr       //PROPOSED
	    else if( Proj:SHWBothBaseline )
	    then 
	      UNDEFINED                                           // BASELINE
	    else if( Proj:SHWNone )
	    then 
	      UNDEFINED                                         // no DHW modeled
	    else 
	      UNDEFINED
	    endif endif endif
    else UNDEFINED
    endif
  SIZING_BASELINE
    if( IfValidAnd(u:Proj:ResWtrHtrNonCentralSys = 1) .AND. Name = "ResBaseWaterHeater" )
    then
      if( Parent(Type) = "ServiceHotWater" )
      then
		    if( Proj:SHWUserAndBaseline .OR. Proj:SHWBothBaseline )
        then 
		      UNDEFINED                                  // BASELINE
		    else if( Proj:SHWPropOnly )
        then 
		      u:InpPwr              //PROPOSED
		    else if( Proj:SHWNone )
		    then 
		      UNDEFINED                                   // no DHW modeled
		    else 
          UNDEFINED
        endif endif endif
      else UNDEFINED
      endif
    else
	   if( Parent(Type) = "ServiceHotWater" )
    then
		    if( Proj:SHWUserAndBaseline .AND. Proj:SHWBothBaseline )
		    then 
        UNDEFINED
		    else if( Proj:SHWPropOnly )
		    then 
		      u:InpPwr     //PROPOSED
		    else if( Proj:SHWNone )
		    then 
		      UNDEFINED                                   // no DHW modeled
		    else 
        UNDEFINED
		    endif endif endif 
     else UNDEFINED
        endif
    endif      
  ANNUAL_PROPOSED
    zp:InpPwr
  ANNUAL_BASELINE
    zb:InpPwr
ENDRULE


// -------------- Water Heater Capacity Rated --------------
RULE WtrHtr:CapRtd
  DESCRIPTION
    "This is the water heater's rated capacity."
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    CondRequired
  MINIMUM
    0
  UNITS
    Btu/hr
  REPORTPRECISION
    -3
  DEFAULT
    if( Proj:AutoHardSize = 1 )
    then 
       if( Parent(Type) = "ServiceHotWater" )
       then 
         if( Type = "Conventional" )
         then Int(FluidSys:TotCapRtdBase)
         else UNDEFINED                      //Heat Pump
         endif
       else UNDEFINED
       endif
    else if( FuelSrc = "Electricity" .AND. Type = "Conventional" .AND. 
              LocalStatus( InpPwr ) > 0 )
    then 
      InpPwr * 3412 
    else 
      UNDEFINED
    endif endif
  CHECKCODE
    if( (LocalStatus(CapRtd) < 1 .OR. CapRtd = 0) .AND. FluidSys:Type = "ServiceHotWater"  .AND.
         Type = "Conventional" .AND. FuelSrc = "Gas" )
    then
      PostError("All Water Heaters require a rated capacity.  Check input for 
                 water heater '%s'.", Name)
    else UNCHANGED
    endif

  SIZING_PROPOSED
    if( Parent(Type) = "ServiceHotWater" )  //( Type = "ServiceHotWater" )
    then
	    if( Proj:SHWUserAndBaseline .OR. Proj:SHWPropOnly )
	    then 
        if( Type = "Conventional" .AND. FuelSrc = "Gas")
        then u:CapRtd
        else if( Type = "Conventional" .AND. FuelSrc = "Electricity")
        then InpPwr * 3412
        else if( Type <> "Conventional" )    //Heat Pump
        then 
          if( IfValidAnd( UEFRtdVal < 10 ) )
          then
            ( InpPwr * EF * 3412 ) + ValidOr(TankLoss,0)
          else if( IfValidAnd( UEFRtdVal = 50 ) )
          then
            ( InpPwr * UEFMdlCalcEF * 3412 ) + ValidOr(TankLoss,0)   
          else UNDEFINED
          endif endif
        else UNDEFINED                   
        endif endif endif
	    else if( Proj:SHWBothBaseline )
	    then 
          if( Name = "ResBaseWaterHeater" )
          then Bldg:ResComboWtrHtrCapRtd
          else Bldg:NonResBaseWtrHtrCapRtd
          endif
	    else if( Proj:SHWNone )
	    then 
	      UNDEFINED                                         // no DHW modeled
	    else 
	      UNDEFINED
	    endif endif endif
    else UNDEFINED
        endif
  SIZING_BASELINE
    if( IfValidAnd(u:Proj:ResWtrHtrNonCentralSys = 1) .AND. Name = "ResBaseWaterHeater" )
    then
	    if( Parent(Type) = "ServiceHotWater" )
      then
		    if( Proj:SHWUserAndBaseline)
		    then 
          if( Name = "ResBaseWaterHeater" )
          then 200000 
          else ValidOr(NonResBaseFirstHrCap,0) * 0.60
          endif
		    else if( Proj:SHWBothBaseline)
		    then 		    
		      ( ((u:Bldg:ResBaseFirstHrCap - 1) * (8.25 * (135 - 55))) / 0.82 )  //BASELINE
		    else if( Proj:SHWPropOnly )
		    then 
	        if( Type = "Conventional" .AND. FuelSrc = "Gas")
	        then u:CapRtd
	        else if( Type = "Conventional" .AND. FuelSrc = "Electricity")
	        then InpPwr * 3412
          else if( Type <> "Conventional" )   //Heat Pump
          then ( InpPwr * EF * 3412 ) + ValidOr(TankLoss,0)
          else UNDEFINED                   
          endif endif endif
		    else if( Proj:SHWNone )
		    then 
		      UNDEFINED                                   // no DHW modeled
		    else 
		      UNDEFINED
		    endif endif endif endif
      else UNDEFINED
      endif
    else
      if( Parent(Type) = "ServiceHotWater" )
      then
		    if( Proj:SHWUserAndBaseline )
		    then 
          if( Name = "ResBaseWaterHeater" )
          then( (ResBaseFirstHrCap * 0.60) * 8.25 * (135 - 55) )
          else ValidOr(NonResBaseFirstHrCap,0) * 0.60
          endif		      
		    else if( Proj:SHWBothBaseline )
        then
          if( Name = "ResBaseWaterHeater" )
          then Bldg:ResComboWtrHtrCapRtd
          else Bldg:NonResBaseWtrHtrCapRtd //if( Name = "NonResBaseWaterHeater" )
          endif		      
		    else if( Proj:SHWPropOnly )
		    then 
	        if( Type = "Conventional" .AND. FuelSrc = "Gas")
	        then u:CapRtd
	        else if( Type = "Conventional" .AND. FuelSrc = "Electricity")
	        then InpPwr * 3412
          else if( Type <> "Conventional" )   //Heat Pump
          then ( InpPwr * EF * 3412 ) + ValidOr(TankLoss,0)
          else UNDEFINED                   
          endif endif endif
		    else if( Proj:SHWNone )
		    then 
		      UNDEFINED                                   // no DHW modeled
		    else 
		      UNDEFINED
		    endif endif endif endif
      else UNDEFINED
      endif
    endif    
  ANNUAL_PROPOSED
    zp:CapRtd
  ANNUAL_BASELINE
    zb:CapRtd
ENDRULE


// -------------- Water Heater Capacity Rated --------------
RULE WtrHtr:CapRtdSim
  DESCRIPTION
    "The simulates system type for SDD -> OS reverse translator."
  HELP
    "The 'Type' is an important description that is relevant to rules,
     reporting, and how it is represented in the simulation. To separate
     the reporting/rules from the simulatiuon, TypeSim is used to 
     describe how it shall be represented in the simulation."   
  DEFAULT
    if( Proj:AutoHardSize = 1 )
    then 
      if( FluidSys:Type = "ServiceHotWater" .AND. IfValidAnd( FluidSys:TotCapRtdBase > 0 ) .AND. IfValidAnd(CapRtd > 0) .AND. 
          IfValidAnd(FluidSysCnt > 0) )
      then 
        if( Type = "Conventional" )
        then 
          CapRtd * FluidSysCnt     //PROPOSED
        else if( Type <> "Conventional" )   //Heat Pump
        then 
          ( ( InpPwr * EF * 3412 ) + ValidOr(TankLoss,0) )* FluidSysCnt 
        else UNDEFINED                   
        endif endif        
      else UNDEFINED
      endif
    else
      if( FluidSys:Type = "ServiceHotWater" .AND. IfValidAnd( FluidSys:TotCapRtdBase > 0 ) .AND. IfValidAnd(CapRtd > 0) .AND. 
          IfValidAnd(FluidSysCnt > 0) )
      then
        if( Type = "Conventional" )
        then 
          CapRtd * FluidSysCnt     //PROPOSED
        else  if( Type <> "Conventional" )   //Heat Pump
        then
          if( IfValidAnd( UEFRtdVal < 10 ) )
          then
            ( ( InpPwr * EF * 3412 ) + ValidOr(TankLoss,0) )* FluidSysCnt 
          else if( IfValidAnd( UEFRtdVal = 50 ) )
          then
            ( ( InpPwr * UEFMdlCalcEF * 3412 ) + ValidOr(TankLoss,0) )* FluidSysCnt
          else UNDEFINED
          endif endif
        else UNDEFINED
        endif endif        
      else 
        UNDEFINED
      endif
    endif
  SIZING_PROPOSED
    if( Parent(Type) = "ServiceHotWater" )  //( Type = "ServiceHotWater" )
    then
	    if( Proj:SHWUserAndBaseline .OR. Proj:SHWPropOnly )
	    then 
        zp:CapRtd * u:FluidSysCnt     //PROPOSED
	    else if( Proj:SHWBothBaseline )
	    then 
        zp:CapRtd
	    else if( Proj:SHWNone )
	    then 
	      UNDEFINED                                         // no DHW modeled
	    else 
	      UNDEFINED
	    endif endif endif
      else UNDEFINED
      endif
  SIZING_BASELINE
    if( IfValidAnd(u:Proj:ResWtrHtrNonCentralSys = 1) .AND. Name = "ResBaseWaterHeater" )
    then
	    if( Parent(Type) = "ServiceHotWater" )
      then
		    if( Proj:SHWUserAndBaseline)
		    then 
            if( Name = "ResBaseWaterHeater" )
            then 
              zb:CapRtd * Bldg:LivingUnitCntRpt
            else 
              zb:CapRtd
            endif
		    else if( Proj:SHWBothBaseline)
		    then 		    
		      zb:CapRtd                              //BASELINE
		    else if( Proj:SHWPropOnly )
		    then 
          zp:CapRtd * u:FluidSysCnt              //PROPOSED
		    else if( Proj:SHWNone )
		    then 
		      UNDEFINED                                   // no DHW modeled
        else
	        UNDEFINED
	      endif endif endif endif 	  
		  else 
		    UNDEFINED
		  endif 
    else
     	if( Parent(Type) = "ServiceHotWater" )
      then
		    if( Proj:SHWUserAndBaseline )
		    then 
          zb:CapRtd
		    else if( Proj:SHWBothBaseline )
        then
          zb:CapRtd
		    else if( Proj:SHWPropOnly )
		    then 
          zp:CapRtd * u:FluidSysCnt  
		    else if( Proj:SHWNone )
		    then 
		      UNDEFINED                                   // no DHW modeled
		    else 
		      UNDEFINED
		    endif endif endif endif
      else UNDEFINED
      endif
    endif    
  ANNUAL_PROPOSED
    zp:CapRtdSim
  ANNUAL_BASELINE
    zb:CapRtdSim
ENDRULE

// ---------- Water Heater Outlet Fluid Segment Reference Check --------------
RULE WtrHtr:FluidSegOutRef
  DESCRIPTION
    "Checking that the water heater outlet fluid segment is referenced 
     correctly."
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    Required
  CHECKSIM
    if( LocalStatus( FluidSegOutRef ) < 1 )
    then
      PostError("The outlet fluid segment of water heater '%s' must be assigned to a 
                 Service Hot Water system", Name)
    else if( FluidSegOutRef:ParentFluidSysType != "ServiceHotWater" )
	  then
	    PostError("The outlet fluid segment of water heater '%s' must belong to a 
	               Service Hot Water system", Name)
	  else UNCHANGED
	  endif endif
ENDRULE

// ---------- Water Heater Makeup Fluid Segment Reference Check --------------
RULE WtrHtr:FluidSegMakeupRef
  DESCRIPTION
    "Checking that the water heater makeup fluid segment is referenced 
     correctly."
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    Required
  CHECKSIM
	  if( LocalStatus( FluidSegMakeupRef ) < 1 )
	  then
	    PostError("The makeup fluid segment of water heater '%s' must be assigned to a 
	               Service Hot Water system", Name)
	  else if( FluidSegMakeupRef:ParentFluidSysType != "ServiceHotWater" )
	  then
	    PostError("The makeup fluid segment of water heater '%s' must belong to a 
	               Service Hot Water system", Name)
	  else UNCHANGED
	  endif endif
ENDRULE



// -------------- Fluid Segment Water Heater Storage Capacity --------------------
RULE NEW FluidSeg:WtrHtrInstantChk
  DATATYPE
    Float
  LONGFORM
    WaterHeaterInstantaneousCheck
  DESCRIPTION
    "Checks the number of instantaneous water heaters on each fluid segment."
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    NotInput
  MINIMUM
    0
  DEFAULT
    SumRevRef( WtrHtr:FluidSegOutRef, WtrHtr:IsInstant)
ENDRULE


// -------------- Water Heater Storage Capacity --------------
RULE WtrHtr:StorCap
  DESCRIPTION
    "This is the water heater's storage capacity."
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    Required
  UNITS
    gal
  REPORTPRECISION
    2
  DEFAULT
    if( Proj:AutoHardSize = 1 )
    then 
      if( FluidSys:Type = "ServiceHotWater" )
      then 
         Int(FluidSys:TotStorCapBase)
      else
        UNDEFINED
      endif
    else UNDEFINED
    endif
  CHECKCODE
    if( LocalStatus(StorCap) < 1 
        .AND. FluidSys:Type = "ServiceHotWater"
        .AND. WtrHtr:SubType = "Storage" )
    then
      PostError("All Water Heaters require a storage capacity.  Check input for 
                 water heater '%s'.", Name)
    else
      if( (LocalStatus(StorCap) < 1 .OR. StorCap = 0 ) 
         .AND. FluidSys:Type = "ServiceHotWater"
         .AND. WtrHtr:SubType = "Instantaneous" )
      then
        PostError("Instantaneous water heater '%s' requires a non-zero storage 
                   capacity of 1 gallon.",Name)
      else 
	       if( (LocalStatus(StorCap) < 1 .OR. StorCap = 0 ) 
	         .AND. FluidSys:Type = "ServiceHotWater" )
	      then
	        PostError("All Water Heaters require a storage capacity.  Check input for 
                     water heater '%s'.", Name)     
        else UNCHANGED
        endif
      endif
    endif
  SIZING_PROPOSED
    if( Parent(Type) = "ServiceHotWater" )  
    then
      if( Proj:SHWUserAndBaseline .OR. Proj:SHWPropOnly )
      then
        u:StorCap
      else if( Proj:SHWBothBaseline )
      then
        if( Name = "ResBaseWaterHeater" )
        then 
          Bldg:ResBaseStorCap
        else 
          Bldg:NonResBaseStorCap    //Name = "NonResBaseWaterHeater" 
        endif
      else if( Proj:SHWNone )
      then 
        UNDEFINED
      else 
        UNDEFINED
      endif endif endif
    else UNDEFINED
    endif
  SIZING_BASELINE
    if( IfValidAnd(Parent(ResWtrHtrNonCentralSys) = 1) .AND. Name = "ResBaseWaterHeater" )
    then
		    if( Parent(Type) = "ServiceHotWater" )  
		    then
		      if( Proj:SHWPropOnly )
		      then
		        u:StorCap
		      else if( Proj:SHWUserAndBaseline .OR. Proj:SHWBothBaseline )
		      then
		        1               
		      else if( Proj:SHWNone )
		      then 
		        UNDEFINED
		      else 
		        UNDEFINED
		      endif endif endif
		    else UNDEFINED
		    endif
    else
        if( Parent(Type) = "ServiceHotWater" )  
		    then
		      if( Proj:SHWPropOnly )
		      then
		        u:StorCap
		      else if( Proj:SHWUserAndBaseline .OR. Proj:SHWBothBaseline )
		      then
              if( Name = "ResBaseWaterHeater" )
              then
                Bldg:ResBaseStorCap
              else
                Bldg:NonResBaseStorCap              
              endif
		      else if( Proj:SHWNone )
		      then 
		        UNDEFINED
		      else 
		        UNDEFINED
		      endif endif endif
		    else UNDEFINED
		    endif
    endif 
  ANNUAL
    z:StorCap
ENDRULE


// -------------- Water Heater --------------
RULE WtrHtr:StorCapSim
  DESCRIPTION
    "The simulates system type for SDD -> OS reverse translator."
  HELP
    ""
  DEFAULT
    if( Proj:AutoHardSize = 1 )
    then 
      if( FluidSys:Type = "ServiceHotWater" ) // .AND. WtrHtr:SubType = "Storage" )
      then Int( ValidOr( StorCap, 0 ) * FluidSysCnt ) // This conditioned look like it is a mistake for some conditions Int(FluidSys:TotStorCapBase)
      else UNDEFINED
      endif
    else
      if( FluidSys:Type = "ServiceHotWater" )
      then
        ( ValidOr( StorCap, 0 ) * FluidSysCnt )
      else UNDEFINED
      endif
    endif
  SIZING_PROPOSED
    if( Parent(Type) = "ServiceHotWater" )  
    then
      if( Proj:SHWUserAndBaseline .OR. Proj:SHWPropOnly )
      then
        zp:StorCap * u:FluidSysCnt
      else if( Proj:SHWBothBaseline )
      then
        zp:StorCap
      else if( Proj:SHWNone )
      then 
        UNDEFINED
      else 
        UNDEFINED
      endif endif endif
    else UNDEFINED
    endif
  SIZING_BASELINE
    if( IfValidAnd(Parent(ResWtrHtrNonCentralSys) = 1) .AND. Name = "ResBaseWaterHeater" )
    then
		    if( Parent(Type) = "ServiceHotWater" )  
		    then
		      if( Proj:SHWPropOnly )
		      then
		        zp:StorCap * u:FluidSysCnt
		      else if( Proj:SHWUserAndBaseline .OR. Proj:SHWBothBaseline )
		      then
		        1               
		      else if( Proj:SHWNone )
		      then 
		        UNDEFINED
		      else 
		        UNDEFINED
		      endif endif endif
		    else UNDEFINED
		    endif
    else
        if( Parent(Type) = "ServiceHotWater" )  
		    then
		      if( Proj:SHWPropOnly )
		      then
		        zb:StorCap * u:FluidSysCnt
		      else if( Proj:SHWUserAndBaseline .OR. Proj:SHWBothBaseline )
		      then
            zb:StorCap
		      else if( Proj:SHWNone )
		      then 
		        UNDEFINED
		      else 
		        UNDEFINED
		      endif endif endif
		    else UNDEFINED
		    endif
    endif 
  ANNUAL_PROPOSED
    zp:StorCapSim
  ANNUAL_BASELINE
    zb:StorCapSim
ENDRULE

// -------------- Water Heater Storage Capacity With Count --------------
RULE NEW WtrHtr:StorCapWithCnt
  DESCRIPTION
    "The Storage Capacity of a water heater multiplied byt the number of
     water heaters (count) entered."
  LONGFORM
    StorageCapacityWithCount
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    NotInput
  UNITS
    gal
  DEFAULT
    if( Proj:AutoHardSize = 1 )
    then 
      if( FluidSys:Type = "ServiceHotWater" ) // .AND. WtrHtr:SubType = "Storage" )
      then Int( ValidOr( StorCap, 0 ) * FluidSysCnt )
      else UNDEFINED
      endif
    else
      if( FluidSys:Type = "ServiceHotWater" )
      then
        ( ValidOr( StorCap, 0 ) * FluidSysCnt )
      else UNDEFINED
      endif
    endif
  SIZING_PROPOSED
    if( Parent(Type) = "ServiceHotWater" )  
    then
      if( Proj:SHWUserAndBaseline .OR. Proj:SHWPropOnly )
      then
        u:StorCap * u:FluidSysCnt
      else if( Proj:SHWBothBaseline )
      then
        if( Name = "ResBaseWaterHeater" )
        then 
          Bldg:ResBaseStorCap
        else 
          Bldg:NonResBaseStorCap    // Name = "NonResBaseWaterHeater" 
        endif
      else if( Proj:SHWNone )
      then 
        UNDEFINED
      else 
        UNDEFINED
      endif endif endif
    else UNDEFINED
    endif
  SIZING_BASELINE
    if( IfValidAnd(Parent(ResWtrHtrNonCentralSys) = 1) .AND. Name = "ResBaseWaterHeater" )
    then
		    if( Parent(Type) = "ServiceHotWater" )  
		    then
		      if( Proj:SHWPropOnly )
		      then
		        u:StorCap * u:FluidSysCnt
		      else if( Proj:SHWUserAndBaseline .OR. Proj:SHWBothBaseline )
		      then
		        1               
		      else if( Proj:SHWNone )
		      then 
		        UNDEFINED
		      else 
		        UNDEFINED
		      endif endif endif
		    else UNDEFINED
		    endif
    else
        if( Parent(Type) = "ServiceHotWater" )  
		    then
		      if( Proj:SHWPropOnly )
		      then
		        u:StorCap * u:FluidSysCnt
		      else if( Proj:SHWUserAndBaseline .OR. Proj:SHWBothBaseline )
		      then
		        if( Name = "ResBaseWaterHeater" )
		        then 
		          Bldg:ResBaseStorCap
		        else 
		          Bldg:NonResBaseStorCap    // Name = "NonResBaseWaterHeater" 
		        endif
		      else if( Proj:SHWNone )
		      then 
		        UNDEFINED
		      else 
		        UNDEFINED
		      endif endif endif
		    else UNDEFINED
		    endif
    endif 
  ANNUAL
    z:StorCapWithCnt
ENDRULE



// -----------------------------------------------------------------------------
RULE NEW WtrHtr:UEFRtdVal
  DATATYPE
    Integer
  LONGFORM
    UniformEnergyFactorRatedValue
  DESCRIPTION
    "A flag value to indicate that the user has indicated that the water heater
     has a UEF efficiency rating and that the characteristics of the water
     heater allow a code minimum UEF to be determined."
  INPUTCLASS
    NotInput
  DEFAULT
    if( IfValidAnd( IsUEFRtd = 0 ) )
    then 0
    else if( FuelSrc = "Gas" )
      then
        if( IfValidAnd( StorCap >= 20 ) .AND. IfValidAnd( StorCap <= 100 ) .AND. 
            IfValidAnd( CapRtd <= 75000 ) )
        then
          10  // Consumer Gas-Fired Storage Water Heater
        else if( IfValidAnd( StorCap >= 0 ) .AND. IfValidAnd( StorCap < 2 ) .AND.
                 IfValidAnd( CapRtd > 50000 ) .AND. IfValidAnd( CapRtd <= 200000 ) )
        then 
          20  // Consumer Intantaneous Gas-Fired Water Heater
        else if( IfValidAnd( StorCap >= 20 ) .AND. IfValidAnd( StorCap <= 120 ) .AND. 
                 IfValidAnd( CapRtd > 75000 ) .AND. IfValidAnd( CapRtd <= 105000 ) )
        then 
          30  // Residential-Duty Commercial Gas-Fired Storage
        else 0
        endif endif endif
    else if( FuelSrc = "Electricity" )
    then
        if( Type = "Conventional" .AND. IfValidAnd( StorCap >= 20 ) .AND. IfValidAnd( StorCap <= 120 ) .AND.
            IfValidAnd( InpPwr <= 12 ) )
        then
          40      // Consumer Electric Storage Water Heater
        else if(  Type <> "Conventional" .AND. IfValidAnd( StorCap >= 20 ) .AND. IfValidAnd( StorCap <= 120 ) .AND.
            IfValidAnd( InpPwr <= 12 ) )
        then
          50      // Consumer Electric Storage Heat-Pump Water Heater
        else if( Type = "Conventional" .AND. IfValidAnd( StorCap >= 0 ) .AND. IfValidAnd( StorCap < 2 ) .AND.
                 IfValidAnd( InpPwr <= 12 ) )
        then 
          60      // Consumer Instantaneous Electric Water Heater
        else if( Type = "Conventional" .AND. IfValidAnd( StorCap >= 0 ) .AND. IfValidAnd( StorCap < 2 ) .AND.
                 IfValidAnd( InpPwr > 12 ) .AND. IfValidAnd( InpPwr <= 58.6 ) )
        then 
          70     // Residential-Duty Commercial Electric Instantaneous Water Heater
        else 0
        endif endif endif endif
    else
      0
    endif endif endif
  CHECKCODE
    if( IfValidAnd( IsUEFRtd = 1 ) .AND. IfValidAnd( UEFRtdVal = 0) )
    then
      PostWarning("Water heater '%s' has the flag set to indicate that 
                   it is UEF rated, but the volume and input ratings do 
                   not fall into a classification which uses UEF ratings.
                   The flag should be unchecked, or the inputs should be 
                   verified to ensure accuracy.",Name)
    else UNCHANGED
    endif
  SIZING_PROPOSED
    if( Parent(Type) = "ServiceHotWater" )  
    then
      if( Proj:SHWUserAndBaseline .OR. Proj:SHWPropOnly )
      then
        u:UEFRtdVal
      else if( Proj:SHWBothBaseline )
      then
        0        
      else if( Proj:SHWNone )
      then 
        UNDEFINED
      else 
        UNDEFINED
      endif endif endif
    else UNDEFINED
    endif
  SIZING_BASELINE
    if( Parent(Type) = "ServiceHotWater" )  
    then
      if( Proj:SHWPropOnly )
      then
        u:UEFRtdVal
      else if( Proj:SHWUserAndBaseline .OR. Proj:SHWBothBaseline )
      then
        UNDEFINED               
      else if( Proj:SHWNone )
      then 
        UNDEFINED
      else 
        UNDEFINED
      endif endif endif
    else UNDEFINED
    endif
  ANNUAL_PROPOSED
    zp:UEFRtdVal
  ANNUAL_BASELINE
    zb:UEFRtdVal
ENDRULE

// -------------- Water Heater SubType --------------------
RULE WtrHtr:SubType
  DESCRIPTION
    "Conventional water heaters are instantaneous or storage."
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    NotInput
  OPTION
//    C-Instantaneous
//    C-Storage
//    C-StorageHP
    Instantaneous
    Storage
//    RDC-Storage
//    RDC-Instantaneous
  DEFAULT
    if( IfValidAnd( UEFRtdVal < 10 ) )
    then
		    if( IfValidAnd( Type <> "Conventional" ) )
		    then
		      "Storage"   // previously undefined
		    else if( IfValidAnd( CapRtd > 0 ) .AND. IfValidAnd( StorCap >= 0 ) )
		    then
		      if( StorCap = 0 )
		      then "Instantaneous"
		      else if( FuelSrc = "Gas" )
		      then
				      if( CapRtd / StorCap < 4000 )
				      then "Storage"
				      else "Instantaneous"
		          endif 
		      else if( FuelSrc = "Electricity" )
		      then
				      if( (InpPwr * 3412) / StorCap < 4000 )
				      then "Storage"
				      else "Instantaneous"
		          endif         
		      else
		        UNDEFINED
		      endif endif endif
		    else UNDEFINED
		    endif endif
   	else  if( IfValidAnd( UEFRtdVal >= 10 ) )
    then
	      switch ( UEFRtdVal  )
	        case 10:  // Consumer Gas-Fired Storage Water Heater
	          "Storage"
	        case 20:  // Consumer Intantaneous Gas-Fired Water Heater
	          "Instantaneous"
	        case 30:  // Residential-Duty Commercial Gas-Fired Storage
	          "Storage"
	        case 40:  // Consumer Electric Storage Water Heater
	          "Storage"
	        case 50:  // Consumer Electric Storage Heat-Pump Water Heater
	          "Storage"
	        case 60:  // Consumer Instantaneous Electric Water Heater
	          "Instantaneous"
	        case 70:  // Residential-Duty Commercial Electric Instantaneous Water Heater
	          "Instantaneous"	          
	        default:
	          UNDEFINED	  
	      endswitch        
    else 
      UNDEFINED
   endif endif
  CHECKSIM    // This really belongs somewhere else
    if( Parent(Type) = "ServiceHotWater" )
    then
      if( ChildCount(Pump) > 0 )
      then
      PostError("The water heater '%s' should not have a pump.  Currently, water main
                 pressure is used to deliver water to fixtures for both the standard
                 and proposed design.",Name)
      else UNCHANGED
      endif
    else UNCHANGED
    endif
  SIZING_PROPOSED
    if( IfValidAnd( Type <> "Conventional" ) )
    then
      UNDEFINED
    else if( Parent(Type) = "ServiceHotWater" )  
    then
      if( Proj:SHWUserAndBaseline .OR. Proj:SHWPropOnly )
      then
        SubType
      else if( Proj:SHWBothBaseline )
      then
        "Storage"        
      else if( Proj:SHWNone )
      then 
        UNDEFINED
      else 
        UNDEFINED
      endif endif endif
    else UNDEFINED
    endif endif
  SIZING_BASELINE
    if( IfValidAnd( Type <> "Conventional" ) )
    then
      UNDEFINED
    else if( Parent(Type) = "ServiceHotWater" )  
    then
      if( Proj:SHWPropOnly )
      then
        SubType
      else if( Proj:SHWUserAndBaseline .OR. Proj:SHWBothBaseline )
      then
//        if( Name = "ResBaseWaterHeater" ) 
        if( IfValidAnd(u:Proj:ResWtrHtrNonCentralSys = 1) .AND. Name = "ResBaseWaterHeater" ) //.AND. WtrHtr:Name = "ResBaseWaterHeater"  )
        then
          "Instantaneous"
        else
          "Storage"
        endif
      else if( Proj:SHWNone )
      then 
        UNDEFINED
      else 
        UNDEFINED
      endif endif endif
    else UNDEFINED
    endif endif
  ANNUAL_PROPOSED
    zp:SubType
  ANNUAL_BASELINE  
    zb:SubType
ENDRULE


// ---------- Water Heater Subtype is Instantaneous --------------
RULE NEW WtrHtr:IsInstant
  DATATYPE
    Integer
  LONGFORM
    IsInstantaneous
  DESCRIPTION
    "This is a boolean to check if a Water Heater is Instantaneous or Other."
  HELP
    ""
  REFERENCE
    ACM-5.9.1 Water Heating
  INPUTCLASS
    NotInput
  DEFAULT
    if( Parent(Type) = "ServiceHotWater" )
    then
      if( SubType = "Instantaneous" )
      then 1
      else 0
      endif
    else UNDEFINED
    endif
ENDRULE

// -------------- Water Heater Size --------------------
RULE WtrHtr:Size
  DESCRIPTION
    "This determines the size of the water heater, either Large or Small
     based on the rated capacity in BTU/h."
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    NotInput
  UNITS
  DEFAULT
    if( FluidSys:Type = "ServiceHotWater" )
    then
      if( Type <> "Conventional" )    // Heat pump
      then UNDEFINED
      else if( IfValidAnd(WtrHtr:InpPwr > 12)
          .AND. FuelSrc = "Electricity")
      then "Large"
      else if( IfValidAnd(WtrHtr:CapRtd > 75000)
              .AND. SubType = "Storage"
              .AND. FuelSrc = "Gas" )
      then "Large"
      else if( IfValidAnd(CapRtd > 200000)
              .AND. SubType = "Instantaneous"
              .AND. FuelSrc = "Gas" )
      then "Large"
      else if( IfValidAnd(CapRtd > 105000)
              .AND. SubType = "Storage"
              .AND. FuelSrc = "FuelOil#1" )
      then "Large"
      else if( IfValidAnd(CapRtd > 210000)
              .AND. SubType = "Instantaneous"
              .AND. FuelSrc = "FuelOil#1" )
      then "Large"
      else "Small"
      endif endif endif endif endif endif
    else UNDEFINED
    endif
  SIZING_PROPOSED
    if( Parent(Type) = "ServiceHotWater" )  
    then
	    if( Proj:SHWUserAndBaseline .OR. Proj:SHWPropOnly )
	    then // PROPOSED
          if( Type <> "Conventional" )
          then UNDEFINED
          else if( (CapRtdSim / FluidSysCnt) > 40944 .AND. u:FuelSrc = "Electricity" ) then "Large"
          else if( (CapRtdSim / FluidSysCnt) > 75000 .AND. u:SubType = "Storage" .AND. (u:FuelSrc = "Gas") ) then "Large"
          else if( (CapRtdSim / FluidSysCnt) > 200000 .AND. u:SubType = "Instantaneous" .AND. (u:FuelSrc = "Gas") ) then "Large"
          else if( (CapRtdSim / FluidSysCnt) > 105000 .AND. u:SubType = "Storage" .AND. u:FuelSrc = "FuelOil#1" ) then "Large"
          else if( (CapRtdSim / FluidSysCnt) > 210000 .AND. u:SubType = "Instantaneous" .AND. u:FuelSrc = "FuelOil#1" ) then "Large"
          else "Small"
          endif endif endif endif endif endif	    
	    else if( Proj:SHWBothBaseline )
	    then  // BASELINE
          if( Type <> "Conventional" )
          then UNDEFINED
          else if( (CapRtdSim / Cnt) > 75000 ) then "Large"
          else if( (CapRtdSim / Cnt) <= 75000 .AND. (CapRtdSim / Cnt) > 0 ) then "Small"
          else UNDEFINED
          endif endif endif	    
	    else if( Proj:SHWNone )
	    then 
	      UNDEFINED                                         // no DHW modeled
	    else 
	      UNDEFINED
          endif endif endif
              else UNDEFINED
            endif
  SIZING_BASELINE
    if( Parent(Type) = "ServiceHotWater" )  //( Type = "ServiceHotWater" )
    then
	    if( Proj:SHWUserAndBaseline .OR. Proj:SHWBothBaseline )
	    then                   //PROPOSED TANK BURNER -> BASELINE SYSTEM
            if( Type <> "Conventional" )
            then UNDEFINED
      else
          if( IfValidAnd(u:Proj:ResWtrHtrNonCentralSys = 1) .AND. Name = "ResBaseWaterHeater" )
          then "Small"         
          else
            if( (CapRtdSim / Cnt) > 75000 ) 
            then "Large"
            else if( (CapRtdSim / Cnt) <= 75000 .AND. (CapRtdSim / Cnt) > 0 ) 
            then "Small"
              else UNDEFINED
            endif endif
          endif         
        endif     
	    else if( Proj:SHWPropOnly )
            then   //PROPOSED
              if( Type <> "Conventional" )
              then UNDEFINED
        else if( (CapRtdSim / FluidSysCnt) > 40944 .AND. u:FuelSrc = "Electricity" ) then "Large"
        else if( (CapRtdSim / FluidSysCnt) > 75000 .AND. u:SubType = "Storage" .AND. (u:FuelSrc = "Gas") ) then "Large"
        else if( (CapRtdSim / FluidSysCnt) > 200000 .AND. u:SubType = "Instantaneous" .AND. (u:FuelSrc = "Gas") ) then "Large"
        else if( (CapRtdSim / FluidSysCnt) > 105000 .AND. u:SubType = "Storage"  .AND. u:FuelSrc = "FuelOil#1" ) then "Large"
        else if( (CapRtdSim / FluidSysCnt) > 210000 .AND. u:SubType = "Instantaneous" .AND. u:FuelSrc = "FuelOil#1" ) then "Large"
              else "Small"
              endif endif endif endif endif endif
	    else if( Proj:SHWNone )
	    then 
	      UNDEFINED                                   // no DHW modeled
	    else 
	      UNDEFINED
              endif endif endif
          else UNDEFINED
   endif    
  ANNUAL_PROPOSED
    zp:Size
  ANNUAL_BASELINE
    zb:Size
ENDRULE



// -----------------------------------------------------------------------------
RULE NEW WtrHtr:SizeFuelType
  DATATYPE
    String
  LONGFORM
    SizeFuelType
  DESCRIPTION
    "A label describing the size (large or small), fuel (gas or electric), and
     subtype (storage or instantaneous)."
  HELP
    ""
  REFERENCE
    ACM-5.9.1 Water Heating
  INPUTCLASS
    NotInput
  DEFAULT
    if( Parent(Type) = "ServiceHotWater" )
    then
      if( Type <> "Conventional" )
      then UNDEFINED
      else if( FuelSrc = "Gas" .AND. SubType = "Instantaneous" )
      then
        if( Size = "Small" )
        then
          "SmallGasInstant"
        else
          "LargeGasInstant"
        endif
      else if( FuelSrc = "Gas" .AND. SubType = "Storage" )
      then
        if( Size = "Small" )
        then
          "SmallGasStorage"
        else
          "LargeGasStorage"
        endif
      else if( FuelSrc = "Electricity" .AND. SubType = "Instantaneous" )
      then
        if( Size = "Small" )
        then
          "SmallElectricInstant"
        else
          "LargeElectricInstant"
        endif
      else if( FuelSrc = "Electricity" .AND. SubType = "Storage" )
      then
        if( Size = "Small" )
        then
          "SmallElectricStorage"
        else
          "LargeElectricStorage"
        endif
      else "Other"
      endif endif endif endif endif
    else UNDEFINED
    endif
ENDRULE


RULE WtrHtr:UEF
  DESCRIPTION
    "Uniform Energy Factor (UEF) is the newest measure of water heater 
    overall efficiency. UEF is determined by the Department of Energys 
    test method outlined in 10 CFR Part 430, Subpart B, Appendix E"
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    CondRequired
  MINIMUM
    0.20
  MAXIMUM
    4
  REPORTPRECISION
    3
  INPUTCLASS
    CondRequired
  DEFAULT
    if( Proj:AutoEffInput = 1 )
    then 
	    if( FluidSys:Type = "ServiceHotWater" .AND. IfValidAnd( UEFRtdVal >=10 ) )
	    then
	  	  switch ( UEFRtdVal  )
	      case 10:          // Consumer Gas-Fired Storage Water Heater
          0.56
	      case 20:          // Consumer Intantaneous Gas-Fired Water Heater
          0.81
	      case 30:          // Residential-Duty Commercial Gas-Fired Storage
          0.61
	      case 40:          // Consumer Electric Storage Water Heater
          0.92
	      case 50:         // Consumer Electric Storage Heat-Pump Water Heater
          2
	      case 60:         // Consumer Instantaneous Electric Water Heater
          0.92
	      case 70:        // Residential-Duty Commercial Electric Instantaneous Water Heater
          0.8
	      default:
	        0.90
	      endswitch
	    else 
	      0.56
	    endif  
	  else 
	   UNDEFINED
	  endif   
  CHECKCODE
    if( Proj:ExcludeWtrHtg = 1 .OR. IfValidAnd( UEFRtdVal < 10 ) )
    then
      UNCHANGED
    else 
    		if( FluidSys:Type = "ServiceHotWater" .AND. LocalStatus(UEF) < 1 .AND. 
            IfValidAnd( UEFRtdVal >= 10 ) )
	  		then 
	    		PostError("A Uniform Energy Factor (UEF) is required for water heater '%s'.", Name)
	    	else if( FluidSys:Type = "ServiceHotWater" .AND. IfValidAnd( UEFRtdVal >= 10 ) )
	    	then 
		  	  switch ( UEFRtdVal  )
		      case 10:          // Consumer Gas-Fired Storage Water Heater
		        if( IfValidAnd( UEF < 0.24 ) .OR. IfValidAnd( UEF >= 1 ) )
		        then
		          PostError("The Uniform Energy Factor for consumer storage gas 
		                     water heater '%s' must be >=0.24 and < 1", Name)
		        else UNCHANGED
		        endif
		      case 20:          // Consumer Intantaneous Gas-Fired Water Heater
		        if( IfValidAnd( UEF < 0.81 ) .OR. IfValidAnd( UEF >= 1 ) )
		        then
		          PostError("The Uniform Energy Factor for consumer instantaneous gas 
		                     water heater '%s' must be > 0.8 and < 1", Name)
		        else UNCHANGED	
		        endif	        
		      case 30:          // Residential-Duty Commercial Gas-Fired Storage
		        if( IfValidAnd( UEF < 0.24 ) .OR. IfValidAnd( UEF >= 1 ) )
		        then
		          PostError("The Uniform Energy Factor for residential-duty commercial
		                     storage gas water heater '%s' must be >=0.24 and < 1", Name)
		        else UNCHANGED
		        endif
		      case 40:          // Consumer Electric Storage Water Heater
		        if( IfValidAnd( UEF < 0.92 ) .OR. IfValidAnd( UEF >= 1 ) )
		        then
		          PostError("The Uniform Energy Factor for consumer storage electric 
		                     water heater '%s' must be >=0.92 and < 1", Name)
		        else UNCHANGED
		        endif
		      case 50:         // Consumer Electric Storage Heat-Pump Water Heater
		        if( IfValidAnd( UEF < 2 ) .OR. IfValidAnd( UEF > 4 ) )
		        then
		          PostError("The Uniform Energy Factor (UEF) for heat-pump  
		                     water heater '%s' must be >=2 and <= 4", Name)
		        else UNCHANGED
		        endif	       
		      case 60:         // Consumer Instantaneous Electric Water Heater
		        if( IfValidAnd( UEF < 0.92 ) .OR. IfValidAnd( UEF >= 1 ) )
		        then
		          PostError("The Uniform Energy Factor for consumer instantaneous electric 
		                     water heater '%s' must be >=0.92 and < 1", Name)
		        else UNCHANGED
		        endif
		      case 70:        // Residential-Duty Commercial Electric Instantaneous Water Heater
		        if( IfValidAnd( UEF < 0.8 ) .OR. IfValidAnd( UEF >= 1 ) )
		        then
		          PostError("The Uniform Energy Factor (UEF) for residential-duty commercial 
		                      instantaneous electric water heater '%s' must be >=0.8 and < 1", Name)
		        else UNCHANGED
		        endif           
		      default:
		        UNCHANGED
		      endswitch  
        else UNCHANGED
	      endif endif
    endif
  SIZING_PROPOSED
    if( Parent(Type) = "ServiceHotWater" )  
    then
      if( Proj:SHWUserAndBaseline .OR. Proj:SHWPropOnly )
      then
	      if( IfValidAnd( UEFRtdVal >= 10 ) )
	      then
	        UEF
	      else
	        UNDEFINED
	      endif
      else if( Proj:SHWBothBaseline )
      then
        UNDEFINED
      else if( Proj:SHWNone )
      then
        UNDEFINED
      else
        UNDEFINED
      endif endif endif
    else
      UNDEFINED
    endif
  SIZING_BASELINE
    if( Parent(Type) = "ServiceHotWater" )  
    then
      if( Proj:SHWPropOnly )
      then
	      if( IfValidAnd( UEFRtdVal >= 10 ) )
	      then
	        UEF
	      else
	        UNDEFINED
	      endif
      else if( Proj:SHWUserAndBaseline .OR. Proj:SHWBothBaseline )
      then
        UNDEFINED                    
      else if( Proj:SHWNone )
      then 
        UNDEFINED
      else 
        UNDEFINED
      endif endif endif
    else UNDEFINED
    endif
  ANNUAL
    z:UEF
ENDRULE



RULE WtrHtr:FlowRt
  DESCRIPTION
    "Flow rate for water heater"
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    CondRequired
  MINIMUM
    0
  MAXIMUM
    20
  REPORTPRECISION
    0
  INPUTCLASS
    CondRequired
  DEFAULT
    if( Proj:AutoEffInput = 1 )
    then 
	    if( FluidSys:Type = "ServiceHotWater" .AND. IfValidAnd( UEFRtdVal >=10 ) )
	    then
	  	  switch ( UEFRtdVal  )
	      case 10:          // Consumer Gas-Fired Storage Water Heater
          UNDEFINED
	      case 20:          // Consumer Intantaneous Gas-Fired Water Heater
          8
	      case 30:          // Residential-Duty Commercial Gas-Fired Storage
          UNDEFINED
	      case 40:          // Consumer Electric Storage Water Heater
          UNDEFINED
	      case 50:         // Consumer Electric Storage Heat-Pump Water Heater
          UNDEFINED
	      case 60:         // Consumer Instantaneous Electric Water Heater
          2
	      case 70:        // Residential-Duty Commercial Electric Instantaneous Water Heater
          5
	      default:
	        0
	      endswitch  
	    else 
	      0
	    endif  
	  else 
	   UNDEFINED
	  endif   
  CHECKCODE
    if( Proj:ExcludeWtrHtg = 1 .OR. IfValidAnd( UEFRtdVal < 10 ) )
    then
      UNCHANGED
    else
	    if( FluidSys:Type = "ServiceHotWater" .AND. WtrHtr:SubType = "Instantaneous" .AND.
	        LocalStatus(FlowRt) < 1 .AND. IfValidAnd( UEFRtdVal >= 10 ) )
	    then
	      PostError("Instantaneous water heaters require a flow rate. Check input for 
	                 water heater '%s'.", Name)
	    else UNCHANGED
	    endif
	  endif
  SIZING_PROPOSED
    if( Parent(Type) = "ServiceHotWater" )  
    then
      if( Proj:SHWUserAndBaseline .OR. Proj:SHWPropOnly )
      then
	      if( IfValidAnd( UEFRtdVal >= 10 ) )
	      then
	        FlowRt
	      else
	        UNDEFINED
	      endif
      else if( Proj:SHWBothBaseline )
      then
        UNDEFINED
      else if( Proj:SHWNone )
      then
        UNDEFINED
      else
        UNDEFINED
      endif endif endif
    else
      UNDEFINED
    endif
  SIZING_BASELINE
    if( Parent(Type) = "ServiceHotWater" )  
    then
      if( Proj:SHWPropOnly )
      then
	      if( IfValidAnd( UEFRtdVal >= 10 ) )
	      then
	        FlowRt
	      else
	        UNDEFINED
	      endif
      else if( Proj:SHWUserAndBaseline .OR. Proj:SHWBothBaseline )
      then
        UNDEFINED                    
      else if( Proj:SHWNone )
      then 
        UNDEFINED
      else 
        UNDEFINED
      endif endif endif
    else UNDEFINED
    endif
  ANNUAL
    z:FlowRt
ENDRULE


RULE WtrHtr:FirstHrRating
  DESCRIPTION
    "This is the water heater's first hour rating."
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    CondRequired
  UNITS
    gal
  MINIMUM
    0
  MAXIMUM
    250
  REPORTPRECISION
    0
  DEFAULT
    if( Proj:AutoEffInput = 1 )
    then 
	    if( FluidSys:Type = "ServiceHotWater" .AND. IfValidAnd( UEFRtdVal >=10 ) )
	    then
	  	  switch ( UEFRtdVal  )
	      case 10:          // Consumer Gas-Fired Storage Water Heater
          80
	      case 20:          // Consumer Intantaneous Gas-Fired Water Heater
          UNDEFINED
	      case 30:          // Residential-Duty Commercial Gas-Fired Storage
          120
	      case 40:          // Consumer Electric Storage Water Heater
          60
	      case 50:         // Consumer Electric Storage Heat-Pump Water Heater
          66
	      case 60:         // Consumer Instantaneous Electric Water Heater
          UNDEFINED
	      case 70:        // Residential-Duty Commercial Electric Instantaneous Water Heater
          UNDEFINED
	      default:
	        0
	      endswitch  
	    else 
	      0
	    endif  
	  else 
	   UNDEFINED
	  endif   
  CHECKCODE
    if( Proj:ExcludeWtrHtg = 1 .OR. IfValidAnd( UEFRtdVal < 10 ) )
    then
      UNCHANGED
    else
	    if( FluidSys:Type = "ServiceHotWater" .AND. WtrHtr:SubType = "Storage" .AND.
	        LocalStatus(FirstHrRating) < 1 .AND. IfValidAnd( UEFRtdVal >= 10 ) )
	    then
	      PostError("Storage water heater require a First Hour Rating. Check input for 
	                 water heater '%s'.", Name)
	    else
	      if( WtrHtr:SubType = "Storage" .AND. IfValidAnd( UEFRtdVal = 10 ) .AND. 
	          IfValidAnd( FirstHrRating >150 ) )
	      then
	        PostError("Consumer storage water heater '%s' should have a 
	                    first hour rating <= 150.",Name)
	      else if( WtrHtr:SubType = "Storage" .AND. IfValidAnd( UEFRtdVal = 30 ) .AND. 
	               IfValidAnd( FirstHrRating >250 ) )
	      then
	        PostError("Residential-duty commercial storage water heater '%s' 
	                   should have a first hour rating <= 250.",Name)
	      else if( WtrHtr:SubType = "Storage" .AND. IfValidAnd( UEFRtdVal = 40 ) .AND. 
	               IfValidAnd( FirstHrRating >100 ) )
	      then
	        PostError("Consumer storage water heater '%s' should have a 
	                   first hour rating <= 100.",Name)
	      else if( WtrHtr:SubType = "Storage" .AND. IfValidAnd( UEFRtdVal = 50 ) .AND. 
	               IfValidAnd( FirstHrRating >100 ) )
	      then
	        PostError("Heat-pump water heater '%s' should have a first hour rating <= 100.",Name)
	      else 
	        UNCHANGED
	      endif endif endif endif
	    endif
	  endif
  SIZING_PROPOSED
    if( Parent(Type) = "ServiceHotWater" )  
    then
      if( Proj:SHWUserAndBaseline .OR. Proj:SHWPropOnly )
      then
        u:FirstHrRating
      else if( Proj:SHWBothBaseline )
      then
       UNDEFINED
      else if( Proj:SHWNone )
      then 
        UNDEFINED
      else 
        UNDEFINED
      endif endif endif
    else UNDEFINED
    endif
  SIZING_BASELINE
    UNDEFINED
  ANNUAL_PROPOSED
    zp:FirstHrRating
  ANNUAL_BASELINE
    zb:FirstHrRating    
ENDRULE


TABLE UEFMdlDrawPatternFHRTbl
  FHRRng  UEFMdlDrawPattern 
  <18     "Very Small"
  <51     "Low"       
  <75     "Medium"    
  >=75    "High"      
ENDTABLE


TABLE UEFMdlDrawPatternFlowRtTbl
  FlowRtRng  UEFMdlDrawPattern   
  <1.7       "Very Small"
  <2.8       "Low"       
  <4         "Medium"    
  >=4        "High"      
ENDTABLE

TABLE UEFMdlCoefTbl
  UEFMdlDrawPatternRng   UEFMdlCoefa   UEFMdlCoefb   UEFMdlCoefc   UEFMdlCoefd   UEFMdlCoefF   UEFMdlCoefG   UEFMdlCoefDV   UEFMdlCoefAElec   UEFMdlCoefAGas
  "Very Small"           0.250266      57.5          0.039864      67.5          0.821429      0.0043520     10             0.003819          0.026915
  "Low"                  0.065860      57.5          0.039864      67.5          0.821429      0.0011450     38             0.001549          0.010917
  "Medium"               0.045503      57.5          0.039864      67.5          0.821429      0.0007914     55             0.001186          0.008362
  "High"                 0.029794      57.5          0.039864      67.5          0.821429      0.0005181     84             0.000785          0.005534
ENDTABLE


RULE WtrHtr:UEFMdlDrawPattern
  DESCRIPTION
    ""
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    NotInput  
  DEFAULT
    if( UEFRtdVal >= 10 )
    then 
      if( LocalStatus( FirstHrRating ) > 0 .AND. IfValidAnd(SubType = "Storage") )
	    then
	      UEFMdlDrawPatternFHRTbl:UEFMdlDrawPattern("FHRRng", FirstHrRating)
	    else if( LocalStatus( FlowRt ) > 0 .AND. IfValidAnd(SubType = "Instantaneous") )
	    then
	      UEFMdlDrawPatternFlowRtTbl:UEFMdlDrawPattern("FlowRtRng", FlowRt)
	    else
	      "Medium"
	    endif endif
    else 
      UNDEFINED
    endif
ENDRULE


RULE WtrHtr:UEFMdlCoefa
  DESCRIPTION
    "UEF Model Coefficient a"
  INPUTCLASS
    NotInput
  DEFAULT
    if( UEFRtdVal >= 10 )
    then 
      if( LocalStatus( FirstHrRating ) > 0 .AND. IfValidAnd(SubType = "Storage") .AND.
           ( UEFRtdVal = 10 .OR. UEFRtdVal = 40 )  )
	    then
	      UEFMdlCoefTbl:UEFMdlCoefa("UEFMdlDrawPatternRng", UEFMdlDrawPattern)
	    else
	      UNDEFINED
	    endif    
    else UNDEFINED
    endif
ENDRULE


RULE WtrHtr:UEFMdlCoefb
  DESCRIPTION
    "UEF Model Coefficient b"
  INPUTCLASS
    NotInput
  DEFAULT
    if( UEFRtdVal >= 10 )
    then 
       if( LocalStatus( FirstHrRating ) > 0 .AND. IfValidAnd(SubType = "Storage") .AND.
           ( UEFRtdVal = 10 .OR. UEFRtdVal = 40 )  )
	    then
	      UEFMdlCoefTbl:UEFMdlCoefb("UEFMdlDrawPatternRng", UEFMdlDrawPattern)
	    else
	      UNDEFINED
	    endif    
    else UNDEFINED
    endif
ENDRULE


RULE WtrHtr:UEFMdlCoefc
  DESCRIPTION
    "UEF Model Coefficient c"
  INPUTCLASS
    NotInput
  DEFAULT
    if( UEFRtdVal >= 10 )
    then 
      if( LocalStatus( FirstHrRating ) > 0 .AND. IfValidAnd(SubType = "Storage") .AND.
           ( UEFRtdVal = 10 .OR. UEFRtdVal = 40 )  )
	    then
	      UEFMdlCoefTbl:UEFMdlCoefc("UEFMdlDrawPatternRng", UEFMdlDrawPattern)
	    else
	      UNDEFINED
	    endif    
    else UNDEFINED
    endif
ENDRULE


RULE WtrHtr:UEFMdlCoefd
  DESCRIPTION
    "UEF Model Coefficient d"
  INPUTCLASS
    NotInput
  DEFAULT
    if( UEFRtdVal >= 10 )
    then 
      if( LocalStatus( FirstHrRating ) > 0 .AND. IfValidAnd(SubType = "Storage") .AND.
           ( UEFRtdVal = 10 .OR. UEFRtdVal = 40 )  )
	    then
	      UEFMdlCoefTbl:UEFMdlCoefd("UEFMdlDrawPatternRng", UEFMdlDrawPattern)
	    else
	      UNDEFINED
	    endif    
    else UNDEFINED
    endif
ENDRULE


RULE WtrHtr:UEFMdlCoefDV
  DESCRIPTION
    "UEF Model Coefficient DV"
  INPUTCLASS
    NotInput
  DEFAULT
    if( UEFRtdVal >= 10 )
    then 
      if( LocalStatus( FirstHrRating ) > 0 .AND. IfValidAnd(SubType = "Storage") .AND.
            UEFRtdVal = 50  )
	    then
	      UEFMdlCoefTbl:UEFMdlCoefDV("UEFMdlDrawPatternRng", UEFMdlDrawPattern)
	    else
	      UNDEFINED
	    endif    
    else UNDEFINED
    endif
ENDRULE


RULE WtrHtr:UEFMdlCoefF
  DESCRIPTION
    "UEF Model Coefficient F"
  INPUTCLASS
    NotInput
  DEFAULT
    if( UEFRtdVal >= 10 )
    then 
      if( LocalStatus( FirstHrRating ) > 0 .AND. IfValidAnd(SubType = "Storage") .AND.
           UEFRtdVal = 30 )
	    then
	      UEFMdlCoefTbl:UEFMdlCoefF("UEFMdlDrawPatternRng", UEFMdlDrawPattern)
	    else
	      UNDEFINED
	    endif    
    else UNDEFINED
    endif
ENDRULE


RULE WtrHtr:UEFMdlCoefG
  DESCRIPTION
    "UEF Model Coefficient G"
  INPUTCLASS
    NotInput
  DEFAULT
    if( UEFRtdVal >= 10 )
    then 
      if( LocalStatus( FirstHrRating ) > 0 .AND. IfValidAnd(SubType = "Storage") .AND.
           UEFRtdVal = 30 )
	    then
	      UEFMdlCoefTbl:UEFMdlCoefG("UEFMdlDrawPatternRng", UEFMdlDrawPattern)
	    else
	      UNDEFINED
	    endif    
    else UNDEFINED
    endif
ENDRULE

RULE WtrHtr:UEFMdlCoefAElec
  DESCRIPTION
    "UEF Model Coefficient A Electric"
  INPUTCLASS
    NotInput
  DEFAULT
    if( UEFRtdVal >= 10 )
    then 
      if( LocalStatus( FlowRt ) > 0 .AND. IfValidAnd(SubType = "Instantaneous") .AND.
           ( UEFRtdVal = 60 .OR. UEFRtdVal = 70 ) )
	    then
	      UEFMdlCoefTbl:UEFMdlCoefAElec("UEFMdlDrawPatternRng", UEFMdlDrawPattern)
	    else
	      UNDEFINED
	    endif    
    else UNDEFINED
    endif
ENDRULE


RULE WtrHtr:UEFMdlCoefAGas
  DESCRIPTION
    "UEF Model Coefficient A Gas"
  INPUTCLASS
    NotInput
  DEFAULT
    if( UEFRtdVal >= 10 )
    then 
      if( LocalStatus( FlowRt ) > 0 .AND. IfValidAnd(SubType = "Instantaneous") .AND.
           UEFRtdVal = 20 )
	    then
	      UEFMdlCoefTbl:UEFMdlCoefAGas("UEFMdlDrawPatternRng", UEFMdlDrawPattern)
	    else
	      UNDEFINED
	    endif    
    else UNDEFINED
    endif
ENDRULE

RULE WtrHtr:UEFMdl
  DESCRIPTION
    "Modeled UEF based on Water Heater type "
  INPUTCLASS
    NotInput
  DEFAULT
    if( Parent(Type) = "ServiceHotWater" .AND. IfValidAnd( UEFRtdVal >= 10 ) .AND.
        IfValidAnd( UEF >0 ) )
    then
  	  switch ( UEFRtdVal  )
      case 10:  // Consumer Gas-Fired Storage Water Heater
        ( UEF - 0.0746 ) / 0.8653
      case 20:  // Consumer Intantaneous Gas-Fired Water Heater
        ( UEF - 0.1006 ) / 0.8622
      case 30:  // Residential-Duty Commercial Gas-Fired Storage
        ( UEF + 0.0022 ) / 1.0002
      case 40:  // Consumer Electric Storage Water Heater
        ( UEF - 0.4774 ) / 0.474
      case 50:  // Consumer Electric Storage Heat-Pump Water Heater
        UEF
      case 60:   // Consumer Instantaneous Electric Water Heater
        UEF / 0.9847
      case 70:  // Residential-Duty Commercial Electric Instantaneous Water Heater
        UEF          
      default:
        UNDEFINED
      endswitch  
    else UNDEFINED
    endif
ENDRULE

RULE WtrHtr:UEFMdlCalcRE
  DESCRIPTION
    "UEF rated water heater calculated recovery efficiency"
  INPUTCLASS
    NotInput
  DEFAULT
    if( Parent(Type) = "ServiceHotWater" .AND. IfValidAnd( UEFRtdVal >= 10 ) .AND.
        IfValidAnd( UEFMdl >0 ) )
    then
  	  switch ( UEFRtdVal  )
      case 10:  // Consumer Gas-Fired Storage Water Heater
        UNDEFINED
      case 20:  // Consumer Intantaneous Gas-Fired Water Heater
        if( IfValidAnd( UEFMdlCoefAGas > 0 ) )
        then      
          -UEFMdl / ( ( UEFMdlCoefAGas * UEFMdl ) - 1 )
        else
          UNDEFINED
        endif
      case 30:  // Residential-Duty Commercial Gas-Fired Storage
        UNDEFINED
      case 40:  // Consumer Electric Storage Water Heater
        UNDEFINED
      case 50:  // Consumer Electric Storage Heat-Pump Water Heater
        UNDEFINED
      case 60:   // Consumer Instantaneous Electric Water Heater
        if( IfValidAnd( UEFMdlCoefAElec > 0 ) )
        then
          - UEFMdl / ( ( UEFMdlCoefAElec * UEFMdl ) - 1 )
        else 
          UNDEFINED
        endif
      case 70:  // Residential-Duty Commercial Electric Instantaneous Water Heater
        UNDEFINED
      default:
        UNDEFINED
      endswitch  
    else UNDEFINED
    endif
ENDRULE




RULE WtrHtr:UEFMdlCalcThrmlEff
  DESCRIPTION
    "UEF rated water heater calculated thermal effficiency"
  INPUTCLASS
    NotInput
  DEFAULT
    if( Parent(Type) = "ServiceHotWater" .AND. IfValidAnd( UEFRtdVal >= 10 ) .AND.
        IfValidAnd( UEFMdl >0 ) )
    then
  	  switch ( UEFRtdVal  )
      case 10:  // Consumer Gas-Fired Storage Water Heater
        UNDEFINED
      case 20:  // Consumer Intantaneous Gas-Fired Water Heater
        UNDEFINED
      case 30:  // Residential-Duty Commercial Gas-Fired Storage
        UNDEFINED
      case 40:  // Consumer Electric Storage Water Heater
        UNDEFINED
      case 50:  // Consumer Electric Storage Heat-Pump Water Heater
        UNDEFINED
      case 60:   // Consumer Instantaneous Electric Water Heater
        UNDEFINED
      case 70:  // Residential-Duty Commercial Electric Instantaneous Water Heater
        - UEFMdl / ( ( UEFMdlCoefAElec * UEFMdl ) - 1 )
      default:
        UNDEFINED
      endswitch  
    else UNDEFINED
    endif
ENDRULE



// ----------------- Recovery Efficiency Required Boolean ----------------------
RULE NEW WtrHtr:REReq
  LONGFORM
    RecoveryEfficiencyRequired
  DATATYPE
    Integer
  INPUTCLASS
    NotInput
  DEFAULT
    if( IfValidAnd( UEFRtdVal < 10 ) )
    then
	    if( (SubType = "Storage" .AND. FuelSrc = "Gas" .AND. Size = "Small") .OR.
	        (SubType = "Instantaneous" .AND. FuelSrc = "Gas" .AND. Size = "Small") )
	    then 1
	    else 0
	    endif
	  else if( IfValidAnd( UEFRtdVal >= 10 ) )
	  then
  	  switch ( UEFRtdVal  )
      case 10:  // Consumer Gas-Fired Storage Water Heater
        1
      case 20:  // Consumer Intantaneous Gas-Fired Water Heater
        0
      case 30:  // Residential-Duty Commercial Gas-Fired Storage
        0
      case 40:  // Consumer Electric Storage Water Heater
        1
      case 50:  // Consumer Electric Storage Heat-Pump Water Heater
        0
      case 60:   // Consumer Instantaneous Electric Water Heater
        1
      case 70:  // Residential-Duty Commercial Electric Instantaneous Water Heater
        0          
      default:
        0
      endswitch        		  
	  else 0
	  endif endif  
ENDRULE

// -------------- Water Heater Recovery Efficiency ----------------
RULE WtrHtr:RE
  DESCRIPTION
    "The water heater recovery efficiency."
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    CondRequired
  MINIMUM
    0
  MAXIMUM
    1
  REPORTPRECISION
    2
  DEFAULT
    if( Parent(Type) = "ServiceHotWater" .AND. IfValidAnd( UEFRtdVal < 10 ) )
    then
	    if( IfValidAnd( ThrmlEff > 0 ) )
	    then
	      ThrmlEff
	    else if( Proj:AutoEffInput = 1 )
	    then
	      if( FuelSrc = "Gas" )
	      then
	        if( SubType = "Storage" )
	        then
	          0.87
	        else
	          0.82
	        endif
	      else if( FuelSrc = "Electricity" .AND. Type = "Conventional" )
	      then
	        1.00
	      else UNDEFINED 
	      endif endif
	    else 
	      if( FuelSrc = "Electricity" .AND. Type = "Conventional" )
	      then 
	        1.00
	      else
	        UNDEFINED
	      endif  
	    endif endif
    else if( Parent(Type) = "ServiceHotWater" .AND. IfValidAnd( UEFRtdVal >= 10 ) )
    then
      UNDEFINED
    else UNDEFINED
    endif endif  
  CHECKCODE
    if( FluidSys:Type = "ServiceHotWater" .AND. Proj:ExcludeWtrHtg = 1 )
    then
      UNCHANGED
    else  if( FluidSys:Type = "ServiceHotWater" .AND. IfValidAnd( UEFRtdVal < 10 ) )
    then
		    if( FuelSrc = "Gas" .AND. Size = "Small" .AND. LocalStatus(RE) < 1 .AND.
		        IfValidAnd( REReq >0 ) )
		    then
		      PostError("A Recovery Efficiency is required for water heater '%s'.",
		                 Name)
		    else if( Size = "Small" .AND. IfValidAnd(RE < 0.65) .AND. 
		             IfValidAnd( REReq >0 ) )
		    then
		      PostError("The Recovery Efficiency for water heater '%s' is less 
		                 than 0.65.  Enter a valid Recovery Efficiency.", Name)
		    else UNCHANGED
		    endif endif
		else if( FluidSys:Type = "ServiceHotWater" .AND. IfValidAnd( UEFRtdVal >= 10 ) )
		then
		    if( ( IfValidAnd( UEFRtdVal = 10 ) .OR. IfValidAnd( UEFRtdVal = 40 ) .OR. IfValidAnd( UEFRtdVal = 60 ) ) .AND. 
		             LocalStatus(RE) < 1 .AND. IfValidAnd(REReq >0) )
		    then 
		      PostError("A recovery efficiency is required for water heater '%s'.",Name)
		    else if( ( IfValidAnd( UEFRtdVal = 10 ) .OR. IfValidAnd( UEFRtdVal = 40 ) .OR. IfValidAnd( UEFRtdVal = 60 ) ) .AND. 
		             RE = 0 .AND. IfValidAnd(REReq >0) )
		    then 
		      PostError("A non-zero recovery efficiency is required for water 
		                 heater '%s'.",Name)
		    else if( IfValidAnd( UEFRtdVal = 10 ) .AND. IfValidAnd(REReq >0) .AND.
		             ( IfValidAnd( RE < 0.70 ) .OR. IfValidAnd( RE > 0.99 ) ) )
		    then 
		      PostError("The Recovery Efficiency for water heater '%s' should be 
		                 >= 0.70 and <= 0.99.  Enter a valid Recovery Efficiency.", Name)
		    else if( IfValidAnd( UEFRtdVal = 40 ) .AND. IfValidAnd(REReq >0) .AND.
		             ( IfValidAnd( RE < 0.90 ) .OR. IfValidAnd( RE > 0.99 ) ) )
		    then 
		      PostError("The Recovery Efficiency for water heater '%s' should be 
		                 >= 0.90 and <= 0.99.  Enter a valid Recovery Efficiency.", Name)
		    else UNCHANGED
		    endif endif endif endif
	  else UNCHANGED
	  endif endif endif
  SIZING_PROPOSED
    if( Parent(Type) = "ServiceHotWater" )  
    then
      if( Proj:SHWUserAndBaseline .OR. Proj:SHWPropOnly )
      then
        if( IfValidAnd( UEFRtdVal < 10 ) )
        then
		      if( FuelSrc = "Electricity" .AND. Type = "Conventional" )
		      then 
		        1.00
		      else
		        RE
		      endif  
		    else if( IfValidAnd( UEFRtdVal >= 10 ) )
		    then
		      switch ( UEFRtdVal )
			      case 10:  // Consumer Gas-Fired Storage Water Heater
			        RE
			      case 20:  // Consumer Intantaneous Gas-Fired Water Heater
			        UNDEFINED
			      case 30:  // Residential-Duty Commercial Gas-Fired Storage
			        UNDEFINED
			      case 40:  // Consumer Electric Storage Water Heater
			        RE
			      case 50:  // Consumer Electric Storage Heat-Pump Water Heater
			        UNDEFINED
			      case 60:   // Consumer Instantaneous Electric Water Heater
			        RE
			      case 70:  // Residential-Duty Commercial Electric Instantaneous Water Heater
			        UNDEFINED
			      default:
			        UNDEFINED
		      endswitch
		    else UNDEFINED		      
		    endif endif
      else if( Proj:SHWBothBaseline )
      then
        if( FuelSrc = "Gas" )
        then
          if( SubType = "Storage" )
          then
            0.80   
          else
            0.82
          endif
        else if( FuelSrc = "Electricity" .AND. Type = "Conventional" )
        then
          1.00
        else UNDEFINED 
        endif endif
      else if( Proj:SHWNone )
      then
        UNDEFINED
      else
        UNDEFINED
      endif endif endif
    else
      UNDEFINED
    endif
  SIZING_BASELINE
    if( Parent(Type) = "ServiceHotWater" )  
    then
      if( Proj:SHWPropOnly )
      then
        RE
      else if( Proj:SHWUserAndBaseline .OR. Proj:SHWBothBaseline )
      then
        if( FuelSrc = "Gas" )
        then
//          0.78                                    // from old rule
          if( SubType = "Storage" )
          then
            0.80                                  // based on selection from CEC appliance database
          else
            0.82                                  // based on selection from CEC appliance database, approximately
          endif
        else if( FuelSrc = "Electricity" .AND. Type = "Conventional" )
        then
          1.00                                    // old rule used 0.93
        else UNDEFINED 
        endif endif
      else if( Proj:SHWNone )
      then UNDEFINED
      else UNDEFINED
      endif endif endif
    else UNDEFINED
    endif
  ANNUAL
    z:RE
ENDRULE

RULE WtrHtr:UEFMdlCalcEF
  DESCRIPTION
    "UEF rated water heater calculated energy factor"
  INPUTCLASS
    NotInput
  DEFAULT
    if( Parent(Type) = "ServiceHotWater" .AND. IfValidAnd( UEFRtdVal >= 10 ) .AND.
        IfValidAnd( UEFMdl >0 ) )
    then
  	  switch ( UEFRtdVal  )
      case 10:  // Consumer Gas-Fired Storage Water Heater
        if( IfValidAnd( RE > 0 ) )
        then
          -( ( RE * UEFMdl * UEFMdlCoefb ) - ( RE * RE * CapRtd * UEFMdl * UEFMdlCoefa ) ) / ( ( ( UEFMdl - RE )* UEFMdlCoefd ) + ( ( RE * RE * CapRtd - RE * CapRtd * UEFMdl )* UEFMdlCoefc ) - ( UEFMdl * UEFMdlCoefb ) + ( RE * CapRtd * UEFMdl * UEFMdlCoefa ) )
        else
          UNDEFINED
        endif
      case 20:  // Consumer Intantaneous Gas-Fired Water Heater
        ValidOr(UEFMdlCalcRE,0) * 0.9734 + 0.01835
      case 30:  // Residential-Duty Commercial Gas-Fired Storage
        UNDEFINED
      case 40:  // Consumer Electric Storage Water Heater
        if( IfValidAnd( RE > 0 ) )
        then        
          -( ( RE * UEFMdl * UEFMdlCoefb ) - ( RE * RE * CapRtd * UEFMdl * UEFMdlCoefa ) ) / ( ( ( UEFMdl - RE ) * UEFMdlCoefd ) + ( ( RE * RE * CapRtd - RE * CapRtd * UEFMdl ) * UEFMdlCoefc ) - ( UEFMdl * UEFMdlCoefb ) + ( RE * CapRtd * UEFMdl * UEFMdlCoefa ) )
//         -( ( RE * UEFMdl * UEFMdlCoefb ) - ( RE * RE * 3.412 * CapRtd * UEFMdl * UEFMdlCoefa ) ) / ( ( ( UEFMdl - RE ) * UEFMdlCoefd ) + ( ( RE * RE * 3.412 * CapRtd - RE * 3.412 * CapRtd * UEFMdl ) * UEFMdlCoefc ) - ( UEFMdl * UEFMdlCoefb ) + ( RE * 3.412 * CapRtd * UEFMdl * UEFMdlCoefa ) )
        else
          UNDEFINED
        endif
      case 50:  // Consumer Electric Storage Heat-Pump Water Heater
        ( UEFMdl - 0.1513 -( 0.0043 * UEFMdlCoefDV ) ) / 0.8407
      case 60:   // Consumer Instantaneous Electric Water Heater
        ValidOr(UEFMdlCalcRE,0)
      case 70:  // Residential-Duty Commercial Electric Instantaneous Water Heater
        UNDEFINED
      default:
        UNDEFINED
      endswitch  
    else UNDEFINED
    endif
  SIZING_PROPOSED
    if( Parent(Type) = "ServiceHotWater" )  
    then
      if( Proj:SHWUserAndBaseline .OR. Proj:SHWPropOnly )
      then
        u:UEFMdlCalcEF
      else if( Proj:SHWBothBaseline )
      then
        0        
      else if( Proj:SHWNone )
      then 
        UNDEFINED
      else 
        UNDEFINED
      endif endif endif
    else UNDEFINED
    endif
  SIZING_BASELINE
    if( Parent(Type) = "ServiceHotWater" )  
    then
      if( Proj:SHWPropOnly )
      then
        u:UEFMdlCalcEF
      else if( Proj:SHWUserAndBaseline .OR. Proj:SHWBothBaseline )
      then
        UNDEFINED               
      else if( Proj:SHWNone )
      then 
        UNDEFINED
      else 
        UNDEFINED
      endif endif endif
    else UNDEFINED
    endif
ENDRULE



// -------------- Code Minimum Water Heater Energy Factor --------------------
RULE WtrHtr:CodeMinEF
  DESCRIPTION
    "The code minimum energy factor (EF) is the ratio of the energy delivered by the water
     heater divided by the energy used, in the same units. EF is calculated
     according to the DOE 10 CFR Part 430 test procedure, which specifies a
     24-hour pattern of draws, a storage temperature, inlet water temperature,
     and other test conditions. These conditions result in the energy
     delivered for the test period. Energy inputs are measured for the same
     test period and the EF ratio is calculated."
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    NotInput  IgnoreUserInput  "Removed in transition from 2016.2.1 to 2016.2.2"
  MINIMUM
    0
  MAXIMUM
    10
  REPORTPRECISION
    3
  DEFAULT
    if( FluidSys:Type = "ServiceHotWater" .AND.
        LocalStatus( StorCap ) > 0 )
    then
      if( Type <> "Conventional" )
      then 
        0.97  - ( 0.00132 * StorCap )
      else if( SizeFuelType = "SmallGasStorage" )
      then 
        if( Proj:StdsVersionYr >=2015 )
        then
          if( StorCap <= 55 )
          then
            0.675  - ( 0.0015  * StorCap )
          else
            0.8012 - ( 0.00078 * StorCap )
          endif
        else
          0.67  - ( 0.0019  * StorCap )
        endif
      else if( SizeFuelType = "SmallGasInstant" )
      then
        if( Proj:StdsVersionYr >=2015 )
        then
          0.820 - ( 0.0019  * StorCap )
        else
          0.620 - ( 0.0019  * StorCap )
        endif
      else if( SizeFuelType = "SmallElectricStorage" )
      then 
        if( Proj:StdsVersionYr >=2015 )
        then 
          if( StorCap <= 55 )
          then
            0.960 - ( 0.0003  * StorCap )
          else
            2.057 - ( 0.00113 * StorCap )
          endif
        else
          0.97 - ( 0.00132 * StorCap )
        endif
      else if( SizeFuelType = "SmallElectricInstant" )
      then
        0.930 - ( 0.00132 * StorCap )
      else UNCHANGED
      endif endif endif endif endif
    else UNDEFINED
    endif
  SIZING
    UNDEFINED
  ANNUAL
    UNDEFINED
ENDRULE


// ---------- Energy Factor Formula --------------
RULE NEW WtrHtr:EFFormula
  DATATYPE
    Float
  LONGFORM
    EnergyFactorFormula
  INPUTCLASS
    NotInput
  SIZING_PROPOSED 
      if( FluidSys:Type = "ServiceHotWater" )
    then
      if( Type <> "Conventional" )
      then UNDEFINED
      else if( SubType = "Storage" .AND. FuelSrc = "Gas" .AND. ((CapRtdSim / FluidSysCnt) <= 75000) )
      then 
        if( Proj:StdsVersionYr >=2015 )
        then
          if( StorCap  / FluidSysCnt <= 55 )
          then
            0.675  - ( 0.0015  * StorCap / FluidSysCnt )
          else
            0.8012 - ( 0.00078 * StorCap / FluidSysCnt )
          endif
        else
          0.67  - ( 0.0019  * StorCap / FluidSysCnt )
        endif
      else if( SubType = "Instantaneous" .AND. FuelSrc = "Gas" .AND. ((CapRtdSim / FluidSysCnt) <= 200000) )
      then
        if( Proj:StdsVersionYr >=2015 )
        then
          0.820 - ( 0.0019  * StorCap / FluidSysCnt )
        else
          0.620 - ( 0.0019  * StorCap / FluidSysCnt )
        endif
      else if( SubType = "Storage" .AND. FuelSrc = "Electricity" .AND. ((CapRtdSim / FluidSysCnt) <= 40944) )
      then 
        if( Proj:StdsVersionYr >=2015 )
        then 
          if( StorCap / FluidSysCnt <= 55 )
          then
            0.960 - ( 0.0003  * StorCap / FluidSysCnt )
          else
            2.057 - ( 0.00113 * StorCap / FluidSysCnt )
          endif
        else
          0.97 - ( 0.00132 * StorCap / FluidSysCnt )
        endif
      else if( SubType = "Instantaneous" .AND. FuelSrc = "Electricity" .AND. ((CapRtdSim / FluidSysCnt) <= 40944) )
      then
        0.930 - ( 0.00132 * StorCap / FluidSysCnt )
      else UNCHANGED
      endif endif endif endif endif
    else UNDEFINED
    endif
  SIZING_BASELINE 
      if( FluidSys:Type = "ServiceHotWater" )
    then
      if( Type <> "Conventional" )
      then UNDEFINED
      else if( SubType = "Storage" .AND. FuelSrc = "Gas" .AND. ((CapRtdSim / Cnt) <= 75000) )
      then 
        if( Proj:StdsVersionYr >=2015 )
        then
          if( StorCap  / Cnt <= 55 )
          then
            0.675  - ( 0.0015  * StorCap / Cnt )
          else
            0.8012 - ( 0.00078 * StorCap / Cnt )
          endif
        else
          0.67  - ( 0.0019  * StorCap / Cnt )
        endif
      else if( SubType = "Instantaneous" .AND. FuelSrc = "Gas" .AND. (CapRtdSim / Cnt) <= 200000 )
      then
        if( Proj:StdsVersionYr >=2015 )
        then
          0.820 - ( 0.0019  * StorCap / Cnt )
        else
          0.620 - ( 0.0019  * StorCap / Cnt )
        endif
      else if( SubType = "Storage" .AND. FuelSrc = "Electricity" .AND. ((CapRtdSim / Cnt) <= 40944) )
      then 
        if( Proj:StdsVersionYr >=2015 )
        then 
          if( StorCap / Cnt <= 55 )
          then
            0.960 - ( 0.0003  * StorCap / Cnt )
          else
            2.057 - ( 0.00113 * StorCap / Cnt )
          endif
        else
          0.97 - ( 0.00132 * StorCap / Cnt )
        endif
      else if( SubType = "Instantaneous" .AND. FuelSrc = "Electricity" .AND. ((CapRtdSim / Cnt) <= 40944) )
      then
        0.930 - ( 0.00132 * StorCap / Cnt )
      else UNCHANGED
      endif endif endif endif endif
    else UNDEFINED
    endif    
  ANNUAL
    z:EFFormula
ENDRULE

// ----------------- Energy Factor Required Boolean --------------------------------------
RULE NEW WtrHtr:EFReq
  LONGFORM
    EnergyFactorRequired
  DATATYPE
    Integer
  INPUTCLASS
    NotInput
  DEFAULT
    if( IfValidAnd( UEFRtdVal < 10 ) )
    then
	    if( (Type <> "Conventional") .OR.
	        (SubType = "Storage" .AND. FuelSrc = "Gas" .AND. IfValidAnd(CapRtd <= 75000)) .OR.
	        (SubType = "Instantaneous" .AND. FuelSrc = "Gas" .AND. IfValidAnd(CapRtd <= 200000)) .OR.
	        (SubType = "Instantaneous" .AND. FuelSrc = "Electricity" .AND. IfValidAnd(InpPwr <= 12)) .OR.
	        (SubType = "Storage" .AND. FuelSrc = "Electricity" .AND. IfValidAnd(InpPwr <= 12)) )
	    then 1
	    else 0
	    endif
    else 0
    endif
ENDRULE

// -------------- Water Heater Energy Factor --------------------
RULE WtrHtr:EF
  DESCRIPTION
    "The energy factor (EF) is the ratio of the energy delivered by the water
     heater divided by the energy used, in the same units. EF is the efficiency 
     metric used for small water heaters."
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    CondRequired
  MINIMUM
    0.45
  MAXIMUM
    10
  REPORTPRECISION
    2
  DEFAULT
	    if( Proj:AutoEffInput = 1 )
	    then
	      if( FuelSrc = "Gas" )
	      then 0.71
	      else if( FuelSrc = "Electricity" )
	      then
	        if( Type <> "Conventional" )
	        then 3.0
	        else if( SubType = "Storage" )
	        then
	          0.95
	        else
	          0.99
	        endif endif
	      else UNDEFINED 
	      endif endif
	    else UNDEFINED
	    endif
   CHECKCODE
    if( Proj:ExcludeWtrHtg = 1 .OR. IfValidAnd( UEFRtdVal = 50 ))
    then
      UNCHANGED
    else   
	    if( Type <> "Conventional" .AND. LocalStatus(EF) < 1 .AND. IfValidAnd(EFReq >0) )
	    then 
	      PostError("An Energy Factor is required for water heater '%s'.", Name)
	    else if( Type = "Conventional" .AND. IfValidAnd(EF > 1 ) .AND. IfValidAnd(EFReq >0) )
	    then
	      PostError("The Energy Factor for water heater '%s' is greater than 
	                 1 and it is not a heat pump.  Enter a valid Energy Factor.", 
	                 Name)
	    else if( Type <> "Conventional" .AND. IfValidAnd(EF < 2 ) .AND. IfValidAnd(EFReq >0) )
	    then
	      PostError("The Energy Factor for heat pump water heater '%s' is less than 
	                 2.  Enter a valid Energy Factor.", Name)
	    else if( Size = "Small" .AND. LocalStatus(EF) < 1 .AND. IfValidAnd(EFReq >0) )
	    then
	      PostError("An Energy Factor is required for water heater '%s'.", Name)
	    else if( Size = "Small" .AND. IfValidAnd(EF < 0.45) .AND. IfValidAnd(EFReq >0) )
	    then
	      PostError("The Energy Factor for water heater '%s' is less than 0.45.  
	                 Enter a valid Energy Factor.", Name)
	    else UNCHANGED
	    endif endif endif endif endif
   endif
  SIZING_PROPOSED
    if( Parent(Type) = "ServiceHotWater" )  
    then
      if( Proj:SHWUserAndBaseline .OR. Proj:SHWPropOnly )
      then
	      if( Size = "Small" .OR. Type <> "Conventional" )
	      then
	        EF
	      else
	        UNDEFINED
	      endif
      else if( Proj:SHWBothBaseline )
      then
        zp:EFFormula
      else if( Proj:SHWNone )
      then
        UNDEFINED
      else
        UNDEFINED
      endif endif endif
    else
      UNDEFINED
    endif
  SIZING_BASELINE
    if( Parent(Type) = "ServiceHotWater" )  
    then
      if( Proj:SHWPropOnly )
      then
        if( Size = "Small" .OR. Type <> "Conventional" )
        then
          EF
        else
          UNDEFINED
        endif
      else if( Proj:SHWUserAndBaseline .OR. Proj:SHWBothBaseline )
      then
        if( Name = "ResBaseWaterHeater" .AND. StdsVersionYr >=2015 )
        then 0.82
        else zb:EFFormula
        endif                                            
      else if( Proj:SHWNone )
      then UNDEFINED
      else UNDEFINED
      endif endif endif
    else UNDEFINED
    endif
  ANNUAL
    z:EF
ENDRULE




// ----------------- Thermal Efficiency Required Boolean --------------------------------------
RULE NEW WtrHtr:ThrmlEffReq
  LONGFORM
    ThermalEfficiencyRequired
  DATATYPE
    Integer
  INPUTCLASS
    NotInput
  DEFAULT
    if( IfValidAnd( UEFRtdVal < 10 ) )
    then
		    if( (SubType = "Storage" .AND. FuelSrc = "Gas" .AND. IfValidAnd(CapRtd > 75000)) .OR.
		        (SubType = "Instantaneous" .AND. FuelSrc = "Gas" .AND. IfValidAnd(CapRtd > 200000)) .OR.
		        (SubType = "Instantaneous" .AND. FuelSrc = "Electricity" .AND. IfValidAnd(InpPwr > 12)) .OR.
		        (SubType = "Storage" .AND. FuelSrc = "Electricity" .AND. IfValidAnd(InpPwr > 12) .AND. Type = "Conventional") )
		    then 1
		    else 0
		    endif
	  else if( IfValidAnd( UEFRtdVal >= 10 ) )
	  then
  	  switch ( UEFRtdVal  )
      case 10:  // Consumer Gas-Fired Storage Water Heater
        0
      case 20:  // Consumer Intantaneous Gas-Fired Water Heater
        0
      case 30:  // Residential-Duty Commercial Gas-Fired Storage
        1
      case 40:  // Consumer Electric Storage Water Heater
        0
      case 50:  // Consumer Electric Storage Heat-Pump Water Heater
        0
      case 60:   // Consumer Instantaneous Electric Water Heater
        0
      case 70:  // Residential-Duty Commercial Electric Instantaneous Water Heater
        0          
      default:
        0
      endswitch        		  
	  else 0
	  endif endif  
ENDRULE


// -------------- Code Minimum Water Heater Thermal Efficiency --------------------
RULE WtrHtr:CodeMinThrmlEff
  DESCRIPTION
    "The code minimum full load efficiency of a water heater at rated conditions expressed
     as a dimensionless ratio of output over input."
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    NotInput
  MINIMUM
    0
  MAXIMUM
    0.99
  REPORTPRECISION
    3
  DEFAULT
    if( FluidSys:Type = "ServiceHotWater" )
    then
      if( Size = "Large" )
      then 
        if( FuelSrc = "Gas" )
        then 
          0.80
        else 
          UNDEFINED
        endif   
      else
        UNDEFINED
      endif
    else
      UNDEFINED
    endif
  SIZING
    UNDEFINED
  ANNUAL
    UNDEFINED
ENDRULE



// -------------- Water Heater Thermal Efficiency --------------------
RULE WtrHtr:ThrmlEff
  DESCRIPTION
    "The full load efficiency of a water heater at rated conditions expressed
     as a dimensionless ratio of output over input. This is also referred to as
     recovery efficiency."
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    CondRequired
  MINIMUM
    0
  MAXIMUM
    1.00
  REPORTPRECISION
    2
  DEFAULT
    if( Parent(Type) = "ServiceHotWater" .AND. IfValidAnd( UEFRtdVal < 10 ) )
    then
      if( Proj:AutoEffInput = 1 )
      then
        if( FuelSrc = "Gas" )
        then
          0.80
        else if( FuelSrc = "Electricity" .AND. Type = "Conventional" )
        then
          1.0
        else UNDEFINED
        endif endif
      else UNDEFINED
      endif
    else if( Parent(Type) = "ServiceHotWater" .AND. IfValidAnd( UEFRtdVal >= 10 ) )
    then
      switch ( UEFRtdVal )
	      case 10:  // Consumer Gas-Fired Storage Water Heater
	        RE
	      case 20:  // Consumer Intantaneous Gas-Fired Water Heater
	        if( IfValidAnd( UEFMdlCalcRE > 0 ) )
	        then
	          MIN(UEFMdlCalcRE,1)
	        else
            UNDEFINED
          endif
	      case 30:  // Residential-Duty Commercial Gas-Fired Storage
	        ThrmlEff
	      case 40:  // Consumer Electric Storage Water Heater
	        RE
	      case 50:  // Consumer Electric Storage Heat-Pump Water Heater
	        UNDEFINED
	      case 60:   // Consumer Instantaneous Electric Water Heater
	        if( IfValidAnd( UEFMdlCalcRE > 0 ) )
	        then
	          MIN(UEFMdlCalcRE,1)
	        else
            UNDEFINED
          endif
	      case 70:  // Residential-Duty Commercial Electric Instantaneous Water Heater
	        UEFMdlCalcThrmlEff
	      default:
	        UNDEFINED
      endswitch  
    else UNDEFINED
    endif endif
  CHECKCODE
    if( Proj:ExcludeWtrHtg = 1 )
    then
      UNCHANGED
    else   
	    if( FluidSys:Type = "ServiceHotWater" .AND. Size = "Large" .AND. 
	        LocalStatus(ThrmlEff) < 1 .AND. IfValidAnd( UEFRtdVal < 10 ) )
	    then 
	      PostError("A thermal efficiency is required for water heater '%s'.",Name)
	    else if( FluidSys:Type = "ServiceHotWater" .AND.
	             Size = "Large" .AND. ThrmlEff = 0 .AND. IfValidAnd( UEFRtdVal < 10 ) )
	    then 
	      PostError("A non-zero thermal efficiency is required for water 
	                 heater '%s'.",Name)
	    else if( FluidSys:Type = "ServiceHotWater" .AND. IfValidAnd( UEFRtdVal = 30 ) .AND. 
	        LocalStatus(ThrmlEff) < 1 )
	    then 
	      PostError("A thermal efficiency is required for water heater '%s'.",Name)
	    else if( FluidSys:Type = "ServiceHotWater" .AND. IfValidAnd( UEFRtdVal = 30 ) .AND. 
	             ThrmlEff = 0 )
	    then 
	      PostError("A non-zero thermal efficiency is required for water 
	                 heater '%s'.",Name)
	    else UNCHANGED
	    endif endif endif endif
    endif
  SIZING_PROPOSED
    if( Parent(Type) = "ServiceHotWater" .AND. Type = "Conventional" )  
    then
      if( Proj:SHWUserAndBaseline .OR. Proj:SHWPropOnly )
      then
        if( IfValidAnd( UEFRtdVal < 10 ) )
        then
	        if( Size = "Large" )
	        then ThrmlEff
	        else RE
	        endif
	      else if( IfValidAnd( UEFRtdVal >= 10 ) )
	      then
		      switch ( UEFRtdVal )
			      case 10:  // Consumer Gas-Fired Storage Water Heater
			        RE
			      case 20:  // Consumer Intantaneous Gas-Fired Water Heater
			        MIN(UEFMdlCalcRE,1)
			      case 30:  // Residential-Duty Commercial Gas-Fired Storage
			        ThrmlEff
			      case 40:  // Consumer Electric Storage Water Heater
			        RE
			      case 50:  // Consumer Electric Storage Heat-Pump Water Heater
			        UNDEFINED
			      case 60:   // Consumer Instantaneous Electric Water Heater
			        MIN(UEFMdlCalcRE,1)
			      case 70:  // Residential-Duty Commercial Electric Instantaneous Water Heater
			        UEFMdlCalcThrmlEff
			      default:
			        UNDEFINED
		      endswitch  	      
	      else UNDEFINED
	      endif endif
      else if( Proj:SHWBothBaseline )
      then
        if( Name = "ResBaseWaterHeater" .AND. StdsVersionYr >=2015 )
        then 0.82
        else 0.80
        endif                                            
      else if( Proj:SHWNone )
      then UNDEFINED
      else UNDEFINED
      endif endif endif
    else UNDEFINED
    endif
  SIZING_BASELINE
    if( Parent(Type) = "ServiceHotWater" )  
    then
      if( Proj:SHWPropOnly .AND. Type = "Conventional" )
      then
        if( IfValidAnd( UEFRtdVal < 10 ) )
        then
	        if( Size = "Large" )
	        then ThrmlEff
	        else RE
	        endif
	      else if( IfValidAnd( UEFRtdVal >= 10 ) )
	      then
		      switch ( UEFRtdVal )
			      case 10:  // Consumer Gas-Fired Storage Water Heater
			        RE
			      case 20:  // Consumer Intantaneous Gas-Fired Water Heater
			        MIN(UEFMdlCalcRE,1)
			      case 30:  // Residential-Duty Commercial Gas-Fired Storage
			        ThrmlEff
			      case 40:  // Consumer Electric Storage Water Heater
			        RE
			      case 50:  // Consumer Electric Storage Heat-Pump Water Heater
			        UNDEFINED
			      case 60:   // Consumer Instantaneous Electric Water Heater
			        MIN(UEFMdlCalcRE,1)
			      case 70:  // Residential-Duty Commercial Electric Instantaneous Water Heater
			        UEFMdlCalcThrmlEff
			      default:
			        UNDEFINED
		      endswitch  	      
	      else UNDEFINED
	      endif endif
      else if( Proj:SHWUserAndBaseline .OR. Proj:SHWBothBaseline )
      then
        if( Name = "ResBaseWaterHeater" .AND. StdsVersionYr >=2015 )
        then 0.82
        else 0.80
        endif                                            
      else if( Proj:SHWNone )
      then UNDEFINED
      else UNDEFINED
      endif endif endif
    else UNDEFINED
    endif
  ANNUAL
    z:ThrmlEff
ENDRULE

RULE WtrHtr:UEFMdlCalcStdbyLoss
  DESCRIPTION
    "UEF rated water heater calculated standby loss"
  INPUTCLASS
    NotInput
  DEFAULT
    if( Parent(Type) = "ServiceHotWater" .AND. IfValidAnd( UEFRtdVal >= 10 ) .AND.
        IfValidAnd( UEFMdl >0 ).AND. IfValidAnd( ThrmlEff > 0 ) )  
    then
  	  switch ( UEFRtdVal  )
      case 10:  // Consumer Gas-Fired Storage Water Heater
        UNDEFINED
      case 20:  // Consumer Intantaneous Gas-Fired Water Heater
        UNDEFINED
      case 30:  // Residential-Duty Commercial Gas-Fired Storage
        if( IfValidAnd ( UEFMdlCoefF > 0 ) .AND. IfValidAnd ( UEFMdlCoefF > 0 ) )
        then
          - ( ( CapRtd * UEFMdl - CapRtd * ThrmlEff) / ( ( UEFMdlCoefF * UEFMdlCoefG * CapRtd * ThrmlEff - UEFMdlCoefF ) * UEFMdl ) )
//        ( ( ( UEFMdlCoefF * ThrmlEff )- CapRtd )* UEFMdl ) / ( ( UEFMdlCoefF * UEFMdlCoefG * CapRtd * RE * UEFMdl )- CapRtd )
        else
          UNDEFINED
        endif
      case 40:  // Consumer Electric Storage Water Heater
        UNDEFINED
      case 50:  // Consumer Electric Storage Heat-Pump Water Heater
        UNDEFINED
      case 60:   // Consumer Instantaneous Electric Water Heater
        UNDEFINED
      case 70:  // Residential-Duty Commercial Electric Instantaneous Water Heater
        UNDEFINED
      default:
        UNDEFINED
      endswitch  
    else UNDEFINED
    endif
ENDRULE


// -------------- Water Heater Maximum Temperature Limit --------------------
RULE WtrHtr:MaxTempLimit
  DESCRIPTION
    "The temperature (F) at which the tank water becomes dangerously hot and
     is vented through boiling or an automatic safety. The tank temperature
     will never exceed the maximum. Any extra heat added to the tank is
     immediately vented. Note: The maximum temperature must be greater than
     the setpoint temperature at all times."
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    NotInput
  UNITS
    F
  REPORTPRECISION
    0
  DEFAULT
    if( FluidSys:Type = "ServiceHotWater" )
    then 180
    else UNDEFINED
    endif
  SIZING
    180
  ANNUAL
    z:MaxTempLimit
ENDRULE


// -------------- Water Heater Control Type --------------------
RULE WtrHtr:CtrlType
  DESCRIPTION
    "The control type can be Cycle or Modulate. Cycle is appropriate for most
     storage tank-type water heaters. Modulate is appropriate for most
     instantaneous/tankless water heaters."
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    NotInput
  UNITS
  DEFAULT
    if( FluidSys:Type = "ServiceHotWater" )
    then "Cycle"
    else UNDEFINED
    endif
  SIZING
    if( FluidSys:Type = "ServiceHotWater" )
    then
      if( SubType = "Instantaneous" 
         .OR. Type <> "Conventional" )
      then "Modulate"
      else "Cycle"
      endif
    else UNDEFINED
    endif
  ANNUAL
    z:CtrlType
ENDRULE


// -------------- Water Heater Minimum Capacity --------------------
RULE WtrHtr:MinCap
  DESCRIPTION
    "The minimum heat rate (BTU/F) that can be supplied to the water. This field
     is only used when the Heater Control Type is Modulate. If the total
     demand rate for heating is less than the minimum, even a modulating water
     heater will begin to cycle."
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    Default
  MINIMUM
    0
  MAXIMUM
    1000000
  UNITS
    Btu per F
  REPORTPRECISION
    -3
  DEFAULT
    if( FluidSys:Type = "ServiceHotWater" )
    then 0
    else UNDEFINED
    endif
  SIZING
    if( FluidSys:Type = "ServiceHotWater" 
       .AND. CtrlType = "Modulate" )
    then 0
    else UNDEFINED
    endif
  ANNUAL
    z:MinCap
ENDRULE


// -------------- Water Heater Draft Fan Power --------------------
RULE WtrHtr:DraftFanPwr
  DESCRIPTION
    "The power consumption of the draft fan."
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    CondRequired
  UNITS
    Watts
  REPORTPRECISION
    0
  DEFAULT 
    0
  SIZING_PROPOSED
    if( Parent(Type) = "ServiceHotWater" )  //( Type = "ServiceHotWater" )
    then
	    if( Proj:SHWUserAndBaseline .OR. Proj:SHWPropOnly )
	    then 
	      u:DraftFanPwr      //PROPOSED
	    else if( Proj:SHWBothBaseline )
	    then 
	      0                                           // BASELINE
	    else if( Proj:SHWNone )
	    then 
	      UNDEFINED                                         // no DHW modeled
	    else 
	      UNDEFINED
	    endif endif endif
          else UNDEFINED
          endif
  SIZING_BASELINE
    if( Parent(Type) = "ServiceHotWater" )  //( Type = "ServiceHotWater" )
    then
	    if( Proj:SHWUserAndBaseline .OR. Proj:SHWBothBaseline )
	    then 
	      0                                   // BASELINE
	    else if( Proj:SHWPropOnly )
	    then 
	      u:DraftFanPwr   //PROPOSED
	    else if( Proj:SHWNone )
	    then 
	      UNDEFINED                                   // no DHW modeled
	    else 
	      UNDEFINED
	    endif endif endif
          else UNDEFINED
   endif    
  ANNUAL
    z:DraftFanPwr
ENDRULE


// -------------- Water Heater Pilot Energy --------------------
RULE WtrHtr:PilotEnergy
  DESCRIPTION
    "The water heater's pilot energy with no multiplier."
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    NotInput  IgnoreUserInput  "WtrHtr:PilotEnergy removed in transition from 2013 version 3c to 3e and 2016.2.0 to 2016.2.1"
  MINIMUM
    0
  MAXIMUM
    10000
  REPORTPRECISION
    0
  SIZING
    if( Parent(Type) = "ServiceHotWater" )  
    then
      if( FuelSrc = "Gas" .AND. SubType = "Instantaneous" .AND. 
          ElecIgnit = 0 )
      then
        500
      else
        UNDEFINED
      endif
    else 
      UNDEFINED
    endif
  ANNUAL
    z:PilotEnergy  
ENDRULE


// -------------- Water Heater Off Cycle Parasitic Losses --------------------
RULE WtrHtr:OffCyclePrstcLoss
  DESCRIPTION
    "The rate of parasitic losses, such as a pilot light (with multiplier) or 
     controls, when the water heater is not heating."
  HELP
    ""
  REFERENCE
    ACM-5.9.1 Water Heating
  INPUTCLASS
    NotInput  IgnoreUserInput  "WtrHtr:OffCyclePrstcLoss removed in transition from 2013 version 3c to 3e and 2016.2.0 to 2016.2.1"
  MINIMUM
    0
  UNITS
    Watts
  REPORTPRECISION
    0
  SIZING
    if( FluidSys:Type = "ServiceHotWater" .AND. IfValidAnd( PilotEnergy > 0 ) )
     then 
       if( IfValidAnd(u:Proj:ResWtrHtrNonCentralSys = 1) .AND. Name = "ResBaseWaterHeater" )
       then 
         0
       else
         ( PilotEnergy / 3.412 ) * FluidSysCnt   //NK 2017.03.05
       endif
    else 
      0
    endif
  ANNUAL
    z:OffCyclePrstcLoss
ENDRULE

// -------------- Water Heater --------------
RULE WtrHtr:OffCyclePrstcLossSim
  DESCRIPTION
    "The simulates system type for SDD -> OS reverse translator."
  HELP
    ""
  ANNUAL_PROPOSED
    zp:OffCyclePrstcLoss
  ANNUAL_BASELINE
    zb:OffCyclePrstcLoss
ENDRULE


// -------------- Water Heater Off Cycle Fuel Source --------------------
RULE WtrHtr:OffCycleFuelSrc
  DESCRIPTION
    "The type of fuel that serves energy using parasitic equipment, such as a
     pilot light or controls, when the water heater is not heating."
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    NotInput  IgnoreUserInput  "WtrHtr:OffCycleFuelSrc removed in transition from 2013 version 3c to 3e and 2016.2.0 to 2016.2.1"
  SIZING
    if( Parent(Type) = "ServiceHotWater" .AND. IfValidAnd( PilotEnergy > 0 ) )  
    then "Gas"
    else UNDEFINED
    endif
  ANNUAL
    z:OffCycleFuelSrc
ENDRULE

// -------------- Water Heater On Cycle Parasitic Losses --------------------
RULE WtrHtr:OnCyclePrstcLoss
  DESCRIPTION
    "The rate of parasitic losses, such as controls, when the water heater is 
     heating."
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    NotInput  IgnoreUserInput  "WtrHtr:OnCyclePrstcLoss removed in transition from 2013 version 3c to 3e and 2016.2.0 to 2016.2.1"
  MINIMUM
    0
  UNITS
    Btu/hr
  REPORTPRECISION
    0
  SIZING
    if( Parent(Type) = "ServiceHotWater" )  
    then
      if( ElecIgnit = 1 .AND. IfValidAnd(DraftFanPwr > 0) .AND. FuelSrc != "Electricity" )
      then 
        DraftFanPwr * u:FluidSysCnt
      else
        0
      endif
    else 0
    endif
  ANNUAL
    z:OnCyclePrstcLoss
ENDRULE

// -------------- Water Heater --------------
RULE WtrHtr:OnCyclePrstcLossSim
  DESCRIPTION
    "The simulates system type for SDD -> OS reverse translator."
  HELP
    ""
  ANNUAL_PROPOSED
    zp:OnCyclePrstcLoss
  ANNUAL_BASELINE
    zb:OnCyclePrstcLoss
ENDRULE

// -------------- Water Heater On Cycle Fuel Source --------------------
RULE WtrHtr:OnCycleFuelSrc
  DESCRIPTION
    "The type of fuel consumed by parasitic loads, such as a
     pilot light or controls, when the water heater is heating."
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    NotInput  IgnoreUserInput  "WtrHtr:OnCycleFuelSrc removed in transition from 2013 version 3c to 3e and 2016.2.0 to 2016.2.1"
  SIZING
    if( FluidSys:Type = "ServiceHotWater" )
    then
      if( ElecIgnit = 1 .AND. IfValidAnd(DraftFanPwr > 0) .AND. FuelSrc != "Electricity" )
      then 
        "Electricity"
      else
        UNDEFINED
      endif
    else UNDEFINED
    endif
  ANNUAL
    z:OnCycleFuelSrc
ENDRULE



// ----------------- Standby Loss Fraction Required Boolean --------------------------------------
RULE NEW WtrHtr:StdbyLossFracReq
  LONGFORM
    StandbyLossFractionRequired
  DATATYPE
    Integer
  INPUTCLASS
    NotInput
  DEFAULT
    if( IfValidAnd( UEFRtdVal < 10 ) )
    then
		    if( (SubType = "Storage" .AND. FuelSrc = "Gas" .AND. IfValidAnd(CapRtd > 75000)) .OR.
		        (SubType = "Instantaneous" .AND. FuelSrc = "Gas" .AND. IfValidAnd(CapRtd > 200000)) .OR.
		        (SubType = "Storage" .AND. FuelSrc = "Electricity" .AND. IfValidAnd(InpPwr > 12) .AND. Type = "Conventional") )
		    then 1
		    else 0
		    endif
	  else if( IfValidAnd( UEFRtdVal >= 10 ) )
	  then
  	  switch ( UEFRtdVal  )
      case 10:  // Consumer Gas-Fired Storage Water Heater
        0
      case 20:  // Consumer Intantaneous Gas-Fired Water Heater
        0
      case 30:  // Residential-Duty Commercial Gas-Fired Storage
        0
      case 40:  // Consumer Electric Storage Water Heater
        0
      case 50:  // Consumer Electric Storage Heat-Pump Water Heater
        0
      case 60:   // Consumer Instantaneous Electric Water Heater
        0
      case 70:  // Residential-Duty Commercial Electric Instantaneous Water Heater
        0          
      default:
        0
      endswitch        		  
	  else 0
	  endif endif  
  ANNUAL_PROPOSED
    StdbyLossFracReq
  ANNUAL_BASELINE
    UNDEFINED
ENDRULE



// -------------- Water Heater Standby Loss Fraction --------------------
RULE WtrHtr:StdbyLossFrac
  DESCRIPTION
    "The tank standby loss fraction for storage tanks."
  HELP
    "Prescribed to the value listed in the Commissions Appliance Database of
     Certified Water Heaters"
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    Optional
  MINIMUM
    0.0
  MAXIMUM
    0.09 
  DEFAULT
    if( Proj:AutoEffInput = 1 )
    then
      if( FluidSys:Type = "ServiceHotWater" .AND. 
          Size = "Large" .AND. IfValidAnd( StorCap > 0 ) )
      then 
        if( SubType = "Storage" )
        then
          if( FuelSrc = "Gas" )
          then 
            (CapRtd/800 + 110*SQRT( StorCap )) / (8.25 * 70 * StorCap)
          else
            (0.3 + 27 / StorCap) / 100
          endif
        else if( FuelSrc = "Gas" .AND. StorCap >= 10 )
        then
          (CapRtd/800 + 110*SQRT( StorCap )) / (8.25 * 70 * StorCap)
        else UNDEFINED
        endif endif
      else UNDEFINED
      endif
    else UNDEFINED
    endif
  CHECKCODE
    if( FluidSys:Type = "ServiceHotWater" .AND. Proj:ExcludeWtrHtg = 0 .AND.
       IfValidAnd( UEFRtdVal < 10) )
    then    
      if( SubType = "Storage" .AND. Size = "Large" .AND.
          IfValidAnd(StdbyLossFrac > 0) = 0 )
      then 
        PostError("A Standby Loss Fraction is required for water 
                   heater '%s'.",Name)
      else if( FuelSrc = "Gas" .AND. 
               SubType = "Instantaneous" .AND. Size = "Large" .AND.
               StorCap >= 10 .AND. 
               IfValidAnd(StdbyLossFrac > 0) = 0 )
      then 
        PostWarning("A Standby Loss Fraction has not been provided for water 
                     heater '%s'.  A calculated standby loss will be used.",Name)
      else UNCHANGED
      endif endif
    else UNCHANGED
    endif
  SIZING_PROPOSED
    if( Parent(Type) = "ServiceHotWater" )  
    then
      if( Proj:SHWUserAndBaseline .OR. Proj:SHWPropOnly )
      then
        if( FuelSrc = "Gas" .AND. SubType = "Instantaneous" .AND. Size = "Large" 
            .AND. StorCap >= 10 .AND. IfValidAnd(StdbyLossFrac > 0) = 0 )   
        then
          (CapRtd/800 + 110*SQRT( StorCap )) / (8.25 * 70 * StorCap)               
        else
          StdbyLossFrac
        endif
      else if( Proj:SHWBothBaseline )
      then
        if( Size = "Large" .AND. SubType = "Storage" )
        then
          (CapRtd/800 + 110*SQRT( StorCap )) / (8.25 * 70 * StorCap)
        else
          UNDEFINED
        endif   
      else if( Proj:SHWNone )
      then
        UNDEFINED
      else
        UNDEFINED
      endif endif endif
    else UNDEFINED
    endif
  SIZING_BASELINE
    if( Parent(Type) = "ServiceHotWater" )  
    then
      if( Proj:SHWPropOnly )
      then
        StdbyLossFrac
      else if( Proj:SHWUserAndBaseline .OR. Proj:SHWBothBaseline )
      then
        if( Size = "Large" .AND. SubType = "Storage" )
        then
          (CapRtd/800 + 110*SQRT( StorCap )) / (8.25 * 70 * StorCap)
        else
          UNDEFINED
        endif   
      else if( Proj:SHWNone )
      then
        UNDEFINED
      else
        UNDEFINED
      endif endif endif
    else UNDEFINED
    endif
  ANNUAL
    z:StdbyLossFrac
ENDRULE


// -------------- Water Heater Standby Loss --------------------
RULE WtrHtr:StdbyLoss
  DESCRIPTION
    "The tank standby loss for storage tanks, which includes the effect of
     recovery efficiency."
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    NotInput 
  UNITS
    Btu/hr
  REPORTPRECISION
    0
  DEFAULT
    if( Parent(Type) = "ServiceHotWater" )
    then
      if( Size = "Large" .AND. SubType = "Storage" ) 
//          ( Size = "Large" .AND. SubType = "Instantaneous" .AND. FuelSrc = "Gas" ) )
      then
        577.5 * ValidOr( StdbyLossFrac, 0 ) * ValidOr( StorCap, 0 ) // * FluidSysCnt
      else if( Size = "Large" .AND. SubType = "Instantaneous" .AND. 
               FuelSrc = "Gas" .AND. StorCap >= 10 .AND. IfValidAnd(StdbyLossFrac > 0) = 0  ) 
      then         
        CapRtd/800 + 110*SQRT( StorCap )
      else if( Size = "Large" .AND. SubType = "Instantaneous" .AND. 
               FuelSrc = "Gas" .AND. StorCap >= 10 .AND. IfValidAnd(StdbyLossFrac > 0)  ) 
      then
        577.5 * ValidOr( StdbyLossFrac, 0 ) * ValidOr( StorCap, 0 ) 
      else
        UNDEFINED
      endif 
      endif endif
    else UNDEFINED
    endif
  SIZING_PROPOSED
    if( Parent(Type) = "ServiceHotWater" )  
    then
      if( Proj:SHWUserAndBaseline .OR. Proj:SHWPropOnly )
      then
        if( Size = "Large" .AND. SubType = "Storage" ) 
        then
          u:StdbyLoss
        else if( Size = "Large" .AND. SubType = "Instantaneous" .AND. FuelSrc = "Gas" .AND.
               StorCap >= 10 )
        then
           577.5 * ValidOr( StdbyLossFrac, 0 ) * ValidOr( StorCap, 0 )
        else
          UNDEFINED
        endif endif
      else if( Proj:SHWBothBaseline )
      then
        if( Size = "Large" .AND. SubType = "Storage" ) 
        then
          577.5 * ValidOr( StdbyLossFrac, 0 ) * ValidOr( StorCap, 0 )
        else
          UNDEFINED             
        endif   
      else if( Proj:SHWNone )
      then
        UNDEFINED
      else
        UNDEFINED
      endif endif endif
    else UNDEFINED
    endif
  SIZING_BASELINE
    if( Parent(Type) = "ServiceHotWater" )  
    then
      if( Proj:SHWPropOnly )
      then
//        if( Size = "Large" .AND. SubType = "Instantaneous" .AND. FuelSrc = "Gas" .AND.
//               StorCap >= 10 .AND. IfValidAnd(StdbyLossFrac > 0) = 0 )
//        then
//          zp:StdbyLoss
//        else         
          u:StdbyLoss
//        endif  
      else if( Proj:SHWUserAndBaseline .OR. Proj:SHWBothBaseline )
      then
        if( Size = "Large" .AND. SubType = "Storage" ) 
        then
          577.5 * ValidOr( StdbyLossFrac, 0 ) * ValidOr( StorCap, 0 )
        else
          UNDEFINED
        endif   
      else if( Proj:SHWNone )
      then
        UNDEFINED
      else
        UNDEFINED
      endif endif endif
    else UNDEFINED
    endif
  ANNUAL
    z:StdbyLoss
ENDRULE

// -------------- Heat Pump Water Heater Tank Height
RULE WtrHtr:TankHgt
  DESCRIPTION
    "The height of the tank of a heat pump water heater."
  INPUTCLASS
    NotInput
  UNITS
    ft
  DEFAULT
    5
//  CHECKCODE
//    if( FluidSys:Type = "ServiceHotWater" .AND.
//        Type <> "Conventional" )
//    then    
//      if( IfValidAnd(TankHgt > 0) = 0 )
//      then 
//        PostError("A nonzero TankHgt is required for water 
//                   heater '%s'.",Name)
//      else UNCHANGED
//      endif
//    else UNCHANGED
//    endif
  SIZING
    TankHgt
  ANNUAL
    TankHgt
ENDRULE

// The following tables are referenced for determing the Max and Min UA
// for calculation of UA for HeatPump
TABLE PrpHPWtrHtrUAEF
  StorCapRng  MinHPEF  MaxHPEF  MaxHPUA  MinHPUA    
  <=45        1.8      4.5      10       5
  <=57        1.8      4.5      11.5     5.8
  <=65        1.8      4.5      14       7
  <=79        1.8      4.5      16       8
  >79         1.8      4.5      20       10
ENDTABLE


// -------------- -------
RULE NEW WtrHtr:MinHPEF
  DATATYPE
    Float
  LONGFORM
    MinimumHeatPumpEnergyFactor
  DESCRIPTION
    "Minimum Heat Pump Energy Factor"
  INPUTCLASS
    NotInput
  DEFAULT
    if( Type <> "Conventional" )
    then 
      if( LocalStatus( StorCap ) > 0 )
	      then PrpHPWtrHtrUAEF:MinHPEF("StorCapRng", StorCap)
	    else
	      UNDEFINED
	    endif    
    else UNDEFINED
    endif
  SIZING
    if( Type <> "Conventional" )
    then
      u:MinHPEF
    else
      UNDEFINED
    endif
  ANNUAL
    if( Type <> "Conventional" )
    then
      z:MinHPEF
    else
      UNDEFINED
    endif
ENDRULE

// --------------  ---------
RULE NEW WtrHtr:MaxHPEF
  DATATYPE
    Float
  LONGFORM
    MaximumHeatPumpEnergyFactor
  DESCRIPTION
    "Minimum Heat Pump Energy Factor"
  INPUTCLASS
    NotInput
  DEFAULT
    if( Type <> "Conventional" )
    then 
      if( LocalStatus( StorCap ) > 0 )
      then 
        PrpHPWtrHtrUAEF:MaxHPEF("StorCapRng", StorCap)
      else
        UNDEFINED
      endif   
    else UNDEFINED
    endif  
  SIZING
    if( Type <> "Conventional" )
    then
      u:MaxHPEF
    else
      UNDEFINED
    endif
  ANNUAL
    if( Type <> "Conventional" )
    then
      z:MaxHPEF
    else
      UNDEFINED
    endif
ENDRULE

// --------------  ----------
RULE NEW WtrHtr:MinHPUA
  DATATYPE
    Float
  LONGFORM
    MinimumHeatPumpUA
  DESCRIPTION
    "Minimum Heat Pump Energy Factor"
  INPUTCLASS
    NotInput
  DEFAULT
    if( Type <> "Conventional" )
    then 
	    if( LocalStatus( StorCap ) > 0 )
	      then PrpHPWtrHtrUAEF:MinHPUA("StorCapRng", StorCap)
	    else
	      UNDEFINED
	    endif    
    else UNDEFINED
    endif
  SIZING
    if( Type <> "Conventional" )
    then
      u:MinHPUA
    else
      UNDEFINED
    endif
  ANNUAL
    if( Type <> "Conventional" )
    then
      z:MinHPUA
    else
      UNDEFINED
    endif
ENDRULE

// --------------  ----------
RULE NEW WtrHtr:MaxHPUA
  DATATYPE
    Float
  LONGFORM
    MaximumHeatPumpUA
  DESCRIPTION
    "Minimum Heat Pump Energy Factor"
  INPUTCLASS
    NotInput
  DEFAULT
    if( Type <> "Conventional" )
    then 
	    if( LocalStatus( StorCap ) > 0 )
	      then PrpHPWtrHtrUAEF:MaxHPUA("StorCapRng", StorCap)
	    else
	      UNDEFINED
	    endif    
    else UNDEFINED
    endif
  SIZING
    if( Type <> "Conventional" )
    then
      u:MaxHPUA
    else
      UNDEFINED
    endif
  ANNUAL
    if( Type <> "Conventional" )
    then
      z:MaxHPUA
    else
      UNDEFINED
    endif
ENDRULE

// -------------- ----------
RULE NEW WtrHtr:TankLoss
  DATATYPE
    Float
  LONGFORM
    TankLoss
  DESCRIPTION
    "The heat loss from the heat pump water heater storage tank surface."
  INPUTCLASS
    NotInput
  UNITS
    Btu/hr
  DEFAULT
    if( Type <> "Conventional" )
    then
      if( IfValidAnd( UEFRtdVal < 10 ) .AND. IfValidAnd( EF > 0) )
      then
        ( MaxHPUA - ( EF - MinHPEF) * ( (MaxHPUA - MinHPUA) / (MaxHPEF - MinHPEF) ) ) * 80   // Using look-up table derived from Appliance Database for Small Water Heaters
      else if( IfValidAnd( UEFRtdVal = 50 ) ) 
      then
        ( MaxHPUA - ( UEFMdlCalcEF - MinHPEF) * ( (MaxHPUA - MinHPUA) / (MaxHPEF - MinHPEF) ) ) * 80   // Using look-up table derived from Appliance Database for Small Water Heaters
      else UNDEFINED
      endif endif
    else UNDEFINED
    endif
  SIZING
    if( Type <> "Conventional" )
    then
     u:TankLoss
    else
     UNDEFINED
    endif
  ANNUAL
    if( Type <> "Conventional" )
    then
     z:TankLoss
    else
     UNDEFINED
    endif
ENDRULE


// -------------- Water Heater --------------
RULE WtrHtr:TankHgtSim
  DESCRIPTION
    "The simulates system type for SDD -> OS reverse translator."
  HELP
    ""
  ANNUAL_PROPOSED
    zp:TankHgt
  ANNUAL_BASELINE
    zb:TankHgt
ENDRULE

// -------------- Heat Pump Water Heater Compressor Power
RULE NEW WtrHtr:CprsrPwr
  DATATYPE
    Float
  LONGFORM
    CompressorPower
  DESCRIPTION
    "The power consumed by the compressor in a heat pump water heater."
  INPUTCLASS
    NotInput
  UNITS
    Watts
  SIZING
    if( Type <> "Conventional" )
    then 
      if( u:Type = "HeatPumpSplit" )
      then
        InpPwr * 0.85 * 1000
      else if( u:Type = "HeatPumpPackaged" )
      then
        InpPwr * 0.91 * 1000
      else UNDEFINED
      endif endif
   else UNDEFINED
   endif
  ANNUAL
    if( Type <> "Conventional" )
    then
     CprsrPwr
    else
     UNDEFINED
    endif
ENDRULE

// -------------- Heat Pump Water Heater Fan Power ----------------------
RULE NEW WtrHtr:FanPwr
  DATATYPE
    Float
  LONGFORM
    FanPower
  DESCRIPTION
    "The power consumed by the condenser fan on a heat pump water heater."
  INPUTCLASS
    NotInput
  UNITS
    Watts
  SIZING
    if( Type <> "Conventional" )
    then
      InpPwr * 0.09 * 1000
    else UNDEFINED
    endif
  ANNUAL
    if( Type <> "Conventional" )
    then
     FanPwr
    else
     UNDEFINED
    endif
ENDRULE

// -------------- Heat Pump Water Heater COP
RULE WtrHtr:COP
  DESCRIPTION
    "The COP of a heat pump water heater.  This is the heat input into the water
     divided by the input to the compressor."
  INPUTCLASS
    NotInput
  UNITS
    Btu/Btu
  SIZING
    if( Type <> "Conventional" )
    then 
      CapRtd / 3.412 / CprsrPwr    // This may differ from COP from Manufacturers specification because we are assuming the tank losses. 
    else UNDEFINED
    endif  
  ANNUAL
    if( Type <> "Conventional" )
    then     
     COP
    else UNDEFINED
    endif
ENDRULE


// -------------- Split Heat Pump Water Heater Condenser Pump Power
RULE WtrHtr:CndsrPumpPwr
  DESCRIPTION
    "The pump power of a split heat pump water heater."
  INPUTCLASS
    NotInput
  UNITS
    Watts
  SIZING
    if( Type <> "Conventional" )
    then 
      if( u:Type = "HeatPumpSplit" )
    then
        InpPwr * 0.06 * 1000
      else 0
      endif
    else UNDEFINED
    endif  
  ANNUAL
    if( Type <> "Conventional" )
    then
     CndsrPumpPwr
    else
     UNDEFINED
    endif
ENDRULE



// -------------- Water Heater --------------
RULE WtrHtr:CndsrPumpPwrSim
  DESCRIPTION
    "The simulates system type for SDD -> OS reverse translator."
  HELP
    ""
  ANNUAL_PROPOSED
    if( Type <> "Conventional" )
    then
     zp:CndsrPumpPwr * u:FluidSysCnt
    else
     UNDEFINED
    endif    
  ANNUAL_BASELINE
    if( Type <> "Conventional" )
    then
     zb:CndsrPumpPwr * FluidSysCnt
    else
     UNDEFINED
    endif    
ENDRULE




// -------------- Heat Pump Water Heater Condenser Fan Flow -----------------
RULE WtrHtr:FanFlowCap
  DESCRIPTION
    "The heat pump water heater condenser fan airflow rate."
  INPUTCLASS
    NotInput
  UNITS
    cfm
  SIZING
    if( Type <> "Conventional" )
    then
      CapRtd * 621.0178 * 0.00006042      // Calculated to be bwtween E+ error range (m3/s/watt) Min  0.00004027  - Max 0.00008056
    else UNDEFINED
    endif
  ANNUAL
    if( Type <> "Conventional" )
    then
     FanFlowCap
    else
     UNDEFINED
    endif        
ENDRULE

// -------------- Water Heater --------------
RULE WtrHtr:FanFlowCapSim
  DESCRIPTION
    "The simulates system type for SDD -> OS reverse translator."
  HELP
    ""
  ANNUAL_PROPOSED
    if( Type <> "Conventional" )
    then
     zp:FanFlowCap * u:FluidSysCnt
    else
     UNDEFINED
    endif    
  ANNUAL_BASELINE
    if( Type <> "Conventional" )
    then
     zb:FanFlowCap * FluidSysCnt
    else
     UNDEFINED
    endif    
ENDRULE


// -------------- Heat Pump Water Heater Rated Sensible Ratio
RULE WtrHtr:RtdSensHtRat
  DESCRIPTION
    ""
  INPUTCLASS
    NotInput
  SIZING
    if( Type <> "Conventional" )
    then UNDEFINED               // Set to default in EnergyPlus
    else UNDEFINED
    endif
  ANNUAL
    if( Type <> "Conventional" )
    then
     RtdSensHtRat
    else
     UNDEFINED
    endif    
ENDRULE

// -------------- Heat Pump Water Heater Condenser Fan Static Pressure
RULE WtrHtr:FanTotStaticPress
  DESCRIPTION
    "The heat pump water heater condenser fan static pressure."
  INPUTCLASS
    NotInput
  UNITS
    in. w.g.
  SIZING
    if( Type <> "Conventional" )
    then
      FanPwr * 0.5 * 0.85 / 0.1175 / FanFlowCap       // FanEff 0.5, MtrEff 0.85, Constant 0.1175
    else UNDEFINED
    endif
  ANNUAL
    if( Type <> "Conventional" )
    then
     FanTotStaticPress
    else
     UNDEFINED
    endif    
ENDRULE


// -------------- Water Heater --------------
RULE WtrHtr:FanTotStaticPressSim
  DESCRIPTION
    "The simulates system type for SDD -> OS reverse translator."
  HELP
    ""
  ANNUAL_PROPOSED
    if( Type <> "Conventional" )
    then
     zp:FanTotStaticPress 
    else
     UNDEFINED
    endif    
  ANNUAL_BASELINE
    if( Type <> "Conventional" )
    then
     zb:FanTotStaticPress 
    else
     UNDEFINED
    endif    
ENDRULE



// -------------- Heat Pump Water Heater Tank Diameter ------------------------
//RULE NEW WtrHtr:TankDiameter
//  DATATYPE
//    Float
//  LONGFORM
//    TankDiameter
//  DESCRIPTION
//    "The diameter of the water storage tank of a heat pump water heater, 
//     assuming a vertical cylinder."
//  INPUTCLASS
//    NotInput
//  UNITS
//    ft
//  SIZING
//    if( Type <> "Conventional" )
//    then
//      sqrt( StorCap * 0.13368 / TankHgt / 3.142 ) * 2 
//    else UNDEFINED
//    endif
//  ANNUAL
//    TankDiameter
//ENDRULE


// -------------- Heat Pump Water Heater Tank Surface Area
//RULE NEW WtrHtr:TankArea
//  DATATYPE
//    Float
//  LONGFORM
//    TankArea
//  DESCRIPTION
//    "The surface area of the water storage tank of a heat pump water heater, 
//     assuming a vertical cylinder."
//  INPUTCLASS
//    NotInput
//  UNITS
//    sq. ft.
//  SIZING
//    if( Type <> "Conventional" )
//    then
//      TankDiameter * 3.142 * TankHgt + TankDiameter**2 * 3.142 / 4 * 2
//    else UNDEFINED
//    endif
//  ANNUAL
//    TankArea
//ENDRULE

// -------------- Heat Pump Water Heater Storage Tank U-Factor
//RULE WtrHtr:TankUFactor
//  DESCRIPTION
//    "The U-factor of a heat pump water heater storage tank."
//  INPUTCLASS
//    NotInput
//  UNITS
//    Btu/hr-sq.ft.-F 
//  SIZING
//    if( Type <> "Conventional" )
//    then
//      TankLoss / TankArea / 80        // Delta T = 80F = 135 - 55
//    else UNDEFINED
//    endif
//  ANNUAL
//    TankUFactor
//ENDRULE


// -------------- Heat Pump Water Heater Location of Compressor Flag 
RULE WtrHtr:StorLoc
  DESCRIPTION
    "A flag set when the heat pump water heater storage tank is located
     outdoors."
  INPUTCLASS
    CondRequired
  MINIMUM
    0
  MAXIMUM
    1
  DEFAULT
    if( Type <> "Conventional" )
    then 0
    else UNDEFINED
    endif
  SIZING
    if( Type <> "Conventional" )
    then
    StorLoc
    else
     UNDEFINED
    endif    
  ANNUAL
    if( Type <> "Conventional" )
    then
    StorLoc
    else
     UNDEFINED
    endif    
ENDRULE

RULE NEW WtrHtr:UEFMdlTankOffCycleLossCoef
  DATATYPE
    Float
  LONGFORM
    UniformEnergyFactorModelTankOffCycleLossCoefficient
  DESCRIPTION
    ""
  INPUTCLASS
    NotInput
  UNITS
    Btu/hr-F
  DEFAULT
    if( IfValidAnd( UEFRtdVal >= 10 ) )
    then
	    switch ( UEFRtdVal )
		    case 10:  // Consumer Gas-Fired Storage Water Heater
	        if( IfValidAnd( RE > 0 ) )
	        then
			      ((1/UEFMdlCalcEF) - (1/RE)) / ( 67.5 * ( (24/41094) - (1/(RE * (CapRtdSim / u:FluidSysCnt) )) ) )
			    else
			      UNDEFINED
			    endif
		    case 20:  // Consumer Intantaneous Gas-Fired Water Heater
	        if( IfValidAnd( UEFMdlCalcEF > 0 ) .AND. IfValidAnd( UEFMdlCalcRE > 0 ) )
	        then		    
		        ((1/MIN(UEFMdlCalcEF,1)) - (1/MIN(UEFMdlCalcRE,1))) / ( 67.5 * ( (24/41094) - (1/(MIN(UEFMdlCalcRE,1) * (CapRtdSim / u:FluidSysCnt) )) ) )
		      else
		        UNDEFINED
		      endif
		    case 30:  // Residential-Duty Commercial Gas-Fired Storage
		      ValidOr(UEFMdlCalcStdbyLoss,0) / 70
		    case 40:  // Consumer Electric Storage Water Heater
	        if( IfValidAnd( RE > 0 ) )
	        then
  		      ((1/UEFMdlCalcEF) - (1/RE))  / ( 67.5 * ( (24/41094) - (1/(RE  * (CapRtdSim / u:FluidSysCnt) )) ) )
			    else
			      UNDEFINED
			    endif		    
		    case 50:  // Consumer Electric Storage Heat-Pump Water Heater
		      ValidOr ( TankLoss, 0 ) / 80
		    case 60:   // Consumer Instantaneous Electric Water Heater
		      0.001
		    case 70:  // Residential-Duty Commercial Electric Instantaneous Water Heater
		      0.001 
		    default:
		      UNDEFINED
	    endswitch  	
    else 0.001
    endif
  SIZING_PROPOSED
    if( Parent(Type) = "ServiceHotWater" )  
    then
      if( Proj:SHWUserAndBaseline .OR. Proj:SHWPropOnly )
      then
        u:UEFMdlTankOffCycleLossCoef
      else if( Proj:SHWBothBaseline )
      then
        0        
      else if( Proj:SHWNone )
      then 
        UNDEFINED
      else 
        UNDEFINED
      endif endif endif
    else UNDEFINED
    endif
  SIZING_BASELINE
    if( Parent(Type) = "ServiceHotWater" )  
    then
      if( Proj:SHWPropOnly )
      then
        u:UEFMdlTankOffCycleLossCoef
      else if( Proj:SHWUserAndBaseline .OR. Proj:SHWBothBaseline )
      then
        UNDEFINED               
      else if( Proj:SHWNone )
      then 
        UNDEFINED
      else 
        UNDEFINED
      endif endif endif
    else UNDEFINED
    endif
ENDRULE


// -------------- Water Heater Tank Off Cycle Loss Coefficient (UA) ----------------
RULE WtrHtr:TankOffCycleLossCoef
  DESCRIPTION
    "The tank standby loss coefficient (UA) for the water heater. For small
     water heaters covered by NAECA, the loss coefficient is a derived
     parameter, a function of the Energy Factor and recovery efficiency."
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    NotInput  IgnoreUserInput  "WtrHtr:TankOffCycleLossCoef removed in transition from 2013 version 3c to 3e and 2016.2.0 to 2016.2.1"
  UNITS
    Btu/hr-F
  REPORTPRECISION
    0
  SIZING_PROPOSED
    if( Parent(Type) = "ServiceHotWater" )  
    then
      if( Proj:SHWUserAndBaseline .OR. Proj:SHWPropOnly )
      then
        if( IfValidAnd( UEFRtdVal < 10 ) )
        then
	        if( Type <> "Conventional" )
	        then ValidOr ( TankLoss, 0 ) / 80
	        else
		        if( Size = "Small" )
		        then
		          if( FuelSrc = "Electricity" )
		          then
		            ((1/EF) - (1/1))  / ( 67.5 * ( (24/41094) - (1/(1  * (CapRtdSim / u:FluidSysCnt) )) ) ) 
		          else
		            ((1/EF) - (1/RE)) / ( 67.5 * ( (24/41094) - (1/(RE * (CapRtdSim / u:FluidSysCnt) )) ) ) 
		          endif
		        else if( LocalStatus( StdbyLoss ) > 1 )
		        then
		         ValidOr( StdbyLoss, 0 ) / 70             // 70 is the delta T between indoor space temp and setpoint temp - from Fed Regs
		        else 0.001
		        endif endif
	        endif
        else 0.001
        endif
      else if( Proj:SHWBothBaseline )
      then
        if( Size = "Small" )
        then
          ((1/EF) - (1/RE)) / ( 67.5 * ( (24/41094) - (1/(RE * CapRtd )) ) )
        else
          ValidOr( StdbyLoss, 0 ) / 70             // 70 is the delta T between indoor space temp and setpoint temp - from Fed Regs
        endif   
      else if( Proj:SHWNone )
      then
        UNDEFINED
      else
        UNDEFINED
      endif endif endif
    else UNDEFINED
    endif
  SIZING_BASELINE
    if( Parent(Type) = "ServiceHotWater" )  
    then
      if( Proj:SHWPropOnly )
      then
        if( IfValidAnd( UEFRtdVal < 10 ) )
        then
	        if( Type <> "Conventional" )
	        then ValidOr ( TankLoss, 0 ) / 80
	        else
		        if( Size = "Small" )
		        then
		          if( FuelSrc = "Electricity" )
		          then
		            ((1/EF) - (1/1))  / ( 67.5 * ( (24/41094) - (1/(1  * (CapRtdSim / u:FluidSysCnt) )) ) ) 
		          else
		            ((1/EF) - (1/RE)) / ( 67.5 * ( (24/41094) - (1/(RE * (CapRtdSim / u:FluidSysCnt) )) ) ) 
		          endif
		        else if( LocalStatus( StdbyLoss ) > 1 )
		        then
		         ValidOr( StdbyLoss, 0 ) / 70             // 70 is the delta T between indoor space temp and setpoint temp - from Fed Regs
		        else 0.001
		        endif endif
	        endif
        else 0.001
        endif
      else if( Proj:SHWUserAndBaseline .OR. Proj:SHWBothBaseline )
      then
        if( Size = "Small" )
        then
          if( IfValidAnd(Proj:ResWtrHtrNonCentralSys = 1) .AND. Name = "ResBaseWaterHeater" )
            then
          ((1/EF) - (1/RE)) / ( 67.5 * ( (24/41094) - (1/(RE * CapRtd)) ) )
            else  
             ((1/EF) - (1/RE)) / ( 67.5 * ( (24/41094) - (1/(RE * CapRtd)) ) )
            endif
        else
           ValidOr( StdbyLoss, 0 ) / 70          // 70 is the delta T between indoor space temp and setpoint temp - from Fed Regs
        endif   
      else if( Proj:SHWNone )
      then
        UNDEFINED
      else
        UNDEFINED
      endif endif endif
    else UNDEFINED
    endif
  ANNUAL
    z:TankOffCycleLossCoef
ENDRULE

// -------------- Water Heater --------------
RULE WtrHtr:TankOffCycleLossCoefSim
  DESCRIPTION
    "The simulates system type for SDD -> OS reverse translator."
  HELP
    ""
  SIZING_PROPOSED
    if( Parent(Type) = "ServiceHotWater" )  
    then
      if( Proj:SHWUserAndBaseline .OR. Proj:SHWPropOnly )
      then
        if( IfValidAnd( UEFRtdVal < 10 ) )
        then
	        if( Type <> "Conventional" )
	        then MAX ( zp:TankOffCycleLossCoef * u:FluidSysCnt, 0.001 )
	        else
		        if( Size = "Small" )
		        then
		          if( FuelSrc = "Electricity" )
		          then
		            MAX( TankOffCycleLossCoef * u:FluidSysCnt, 0.001 )
		          else
		            MAX( TankOffCycleLossCoef * u:FluidSysCnt, 0.001 )
		          endif
		        else if( LocalStatus( StdbyLoss ) > 1 )
		        then
		          MAX( TankOffCycleLossCoef * u:FluidSysCnt, 0.001 )               // 70 is the delta T between indoor space temp and setpoint temp - from Fed Regs
		        else 0.001
		        endif endif
	        endif
	      else if( IfValidAnd( UEFRtdVal >= 10 ) )
	      then
            MAX( zp:UEFMdlTankOffCycleLossCoef * u:FluidSysCnt, 0.001 )
	      else UNDEFINED
	      endif endif
      else if( Proj:SHWBothBaseline )
      then
        if( Size = "Small" )
        then
          MAX ( zp:TankOffCycleLossCoef, 0.001 )
        else
          MAX ( zp:TankOffCycleLossCoef, 0.001 )             // 70 is the delta T between indoor space temp and setpoint temp - from Fed Regs
        endif   
      else if( Proj:SHWNone )
      then
        UNDEFINED
      else
        UNDEFINED
      endif endif endif
    else UNDEFINED
    endif
  SIZING_BASELINE
    if( Parent(Type) = "ServiceHotWater" )  
    then
      if( Proj:SHWPropOnly )
      then
        if( IfValidAnd( UEFRtdVal < 10 ) )
        then
	        if( Type <> "Conventional" )
	        then zp:TankOffCycleLossCoef * u:FluidSysCnt
	        else
		        if( Size = "Small" )
		        then
		          if( FuelSrc = "Electricity" )
		          then
		            MAX( TankOffCycleLossCoef * u:FluidSysCnt, 0.001 )
		          else
		            MAX( TankOffCycleLossCoef * u:FluidSysCnt, 0.001 )
		          endif
		        else if( LocalStatus( StdbyLoss ) > 1 )
		        then
		          MAX( TankOffCycleLossCoef * u:FluidSysCnt, 0.001 )               // 70 is the delta T between indoor space temp and setpoint temp - from Fed Regs
		        else 0.001
		        endif endif
	        endif
	      else if( IfValidAnd( UEFRtdVal >= 10 ) )
	      then
            MAX( zp:UEFMdlTankOffCycleLossCoef * u:FluidSysCnt, 0.001 )
	      else UNDEFINED
	      endif endif
      else if( Proj:SHWUserAndBaseline .OR. Proj:SHWBothBaseline )
      then
        if( Size = "Small" )
        then
          if( IfValidAnd(Proj:ResWtrHtrNonCentralSys = 1) .AND. Name = "ResBaseWaterHeater" )
            then
              MAX( zb:TankOffCycleLossCoef * FluidSysCnt, 0.001 )  
            else  
             MAX( zb:TankOffCycleLossCoef * FluidSysCnt, 0.001 ) 
            endif
       else
          MAX ( zb:TankOffCycleLossCoef, 0.001 )               // 70 is the delta T between indoor space temp and setpoint temp - from Fed Regs
        endif   
      else if( Proj:SHWNone )
      then
        UNDEFINED
      else
        UNDEFINED
      endif endif endif
    else UNDEFINED
    endif
  ANNUAL
    z:TankOffCycleLossCoefSim
ENDRULE

// -------------- Water Heater Tank On Cycle Loss Coefficient (UA) ----------------
RULE WtrHtr:TankOnCycleLossCoef
  DESCRIPTION
    "The tank standby loss coefficient (UA) for the water heater. For small
     water heater covered by NAECA, the loss coefficient is a derived
     parameter, a function of the Energy Factor and recovery efficiency."
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    NotInput
  UNITS
    Btu/hr-F
  SIZING
    z:TankOffCycleLossCoef
  ANNUAL
    z:TankOffCycleLossCoef
ENDRULE


// -------------- Water Heater --------------
RULE WtrHtr:TankOnCycleLossCoefSim
  DESCRIPTION
    "The simulates system type for SDD -> OS reverse translator."
  HELP
    ""
  ANNUAL_PROPOSED
    zp:TankOffCycleLossCoefSim 
  ANNUAL_BASELINE
    zb:TankOffCycleLossCoefSim
ENDRULE


// -------------- Heat Pump Water Heater Location of Storage Tank Flag 
RULE WtrHtr:StorZn
  DESCRIPTION
    "A flag set when the heat pump water heater tank is located outdoors."
  INPUTCLASS
    NotInput
  OPTION
    Zone
    Outdoor
  DEFAULT
    if( Type <> "Conventional" .AND. StorLoc = 0 )
      then "Zone"
    else if( Type <> "Conventional" .AND. StorLoc = 1 )
      then "Outdoor"
    else UNDEFINED
    endif endif
  SIZING
    if( Type <> "Conventional" )
    then 
      StorZn
    else 
      UNDEFINED
    endif    
  ANNUAL
    if( Type <> "Conventional" )
    then
     z:StorZn
    else
     UNDEFINED
    endif    
ENDRULE


// -------------- Heat Pump Water Heater Location of Storage Tank
RULE WtrHtr:StorZnRef
  DESCRIPTION
    "The name of the zone where the heat pump water heater storage tank
     is located."
  INPUTCLASS
    CondRequired
  CHECKCODE
    if( Type <> "Conventional" )
    then
      if( StorLoc = 0 .AND. LocalStatus( StorZnRef ) < 1 )
      then
        if( Type = "HeatPumpSplit" )
        then
          PostError("A zone name must be provided for the location of the 
                     storage tank for heat pump water heater '%s'", Name)
        else if( Type = "HeatPumpPackaged" )
        then
          PostError("A zone name must be provided for the location of 
                     heat pump water heater '%s'", Name)
        else UNCHANGED
        endif endif
      else UNCHANGED
      endif
    else UNCHANGED
    endif
  SIZING
    if( Type <> "Conventional" .AND. IfValidAnd( StorLoc < 1 ) )
    then 
      StorZnRef
    else 
      UNDEFINED
    endif
  ANNUAL
    if( Type <> "Conventional" )
    then
      z:StorZnRef
    else
      UNDEFINED
    endif
ENDRULE


// -------------- Heat Pump Water Heater Location of Compressor Flag 
RULE WtrHtr:CprsrLoc
  DESCRIPTION
    "A flag set when the heat pump water heater compressor is located outdoors."
  INPUTCLASS
    CondRequired
  MINIMUM
    0
  MAXIMUM
    1
  DEFAULT
    if( Type <> "Conventional" )
    then 
      if( Type = "HeatPumpPackaged" .AND. IfValidAnd( StorLoc > 0 ) )
      then 1
      else 0
      endif
    else UNDEFINED
    endif
  SIZING
    if( Type <> "Conventional" )   
    then
      if( Type = "HeatPumpPackaged" .AND. IfValidAnd( StorLoc > 0 ) )
      then 1
      else CprsrLoc
      endif
    else
     UNDEFINED
    endif
  ANNUAL
    if( Type <> "Conventional" )   
    then
      z:CprsrLoc
    else 
     UNDEFINED
    endif
ENDRULE

// -------------- Heat Pump Water Heater Location of Compressor Flag 
RULE WtrHtr:CprsrZn
  DESCRIPTION
    "A flag set when the heat pump water heater compressor is located outdoors."
  INPUTCLASS
    NotInput
  OPTION
    Zone
    Outdoor
  DEFAULT
    if( Type <> "Conventional" )
    then 
      if( Type = "HeatPumpPackaged" )
      then
        StorZn
      else if( Type = "HeatPumpSplit" )
      then
        if( CprsrLoc = 0 )
        then "Zone"
        else "Outdoor"
        endif
      else UNDEFINED
      endif endif
    else UNDEFINED
    endif
  SIZING
    if( Type <> "Conventional" )   
    then
      if( Type = "HeatPumpPackaged" )
      then
        StorZn
      else if( Type = "HeatPumpSplit" )
      then
        if( CprsrLoc = 0 )
        then "Zone"
        else "Outdoor"
        endif
      else UNDEFINED
      endif endif
    else UNDEFINED
    endif
  ANNUAL
    if( Type <> "Conventional" )   
    then
      z:CprsrZn
    else 
     UNDEFINED
    endif
ENDRULE


// -------------- Heat Pump Water Heater Location of Compressor 
RULE WtrHtr:CprsrZnRef
  DESCRIPTION
    "The name of the zone where the heat pump water heater compressor is
     located."
  INPUTCLASS
    CondRequired
  DEFAULT
    if( Type <> "Conventional" )
    then
      if( Type = "HeatPumpPackaged" )
      then StorZnRef
      else UNDEFINED
      endif
    else UNDEFINED
    endif
  CHECKCODE
    if( Type <> "Conventional" )
    then
      if( CprsrLoc = 0 .AND. LocalStatus( CprsrZnRef ) < 1 )
      then
        if( Type = "HeatPumpSplit" )
        then
          PostError("A zone name must be provided for the location of the 
                     compressor for heat pump water heater '%s'", Name)
        else UNCHANGED
        endif 
      else UNCHANGED
      endif
    else UNCHANGED
    endif
  SIZING
    if( Type <> "Conventional" )
    then
      if( Type = "HeatPumpPackaged" )
      then StorZnRef
      else if( IfValidAnd( CprsrLoc < 1 ) )
      then CprsrZnRef
      else UNDEFINED
      endif endif
    else UNDEFINED
    endif
  ANNUAL
    if( Type <> "Conventional" )
    then
      z:CprsrZnRef
    else
     UNDEFINED
    endif
ENDRULE


// -------------- Heat Pump Water Heater Crankcase Heater Capacity 
RULE WtrHtr:CrankcaseHtrCap
  DESCRIPTION
    "The heating capacity of the heat pump water heater crankcase heater."
  INPUTCLASS
    NotInput
  UNITS
    Watts 
  SIZING
    if( Type <> "Conventional" ) 
    then 
      if( CprsrZnRef = "Outdoor" )
      then 33
      else 0
      endif
    else  UNDEFINED
    endif
  ANNUAL
    CrankcaseHtrCap
ENDRULE

// -------------- Water Heater --------------
RULE WtrHtr:CrankcaseHtrCapSim
  DESCRIPTION
    "The simulates system type for SDD -> OS reverse translator."
  HELP
    ""
  ANNUAL_PROPOSED
    zp:CrankcaseHtrCap
  ANNUAL_BASELINE
    zb:CrankcaseHtrCap
ENDRULE


// -------------- Heat Pump Water Heater 
RULE WtrHtr:MinInletAirTempCprsrOper
  DESCRIPTION
    "Minimum Inlet Air Temperature for Compressor Operation"
  INPUTCLASS
    NotInput
  UNITS
    F
  SIZING
    if( Type <> "Conventional" )
    then 
      23
    else UNDEFINED
    endif  
  ANNUAL
    if( Type <> "Conventional" )
    then
     MinInletAirTempCprsrOper
    else
     UNDEFINED
    endif
ENDRULE






// TO DO Fix part load curve
//
// NOT COMPLETE INFORMATION FROM DAVID ON CORRECT NAME
//    This naming convention is incorrect based on ACM Formula 68, Page 5-195
//    ACM says "Fuel Water Heater Part Load Efficiency Curve"
// -------------- Fuel Water Heater Part Load Efficiency Curve ----------------
//
RULE WtrHtr:HIR_fPLRCrvRef
  DESCRIPTION
    "A set of factors that adjust the full-load thermal efficiency for part 
     load conditions. The factor is set as a curve."
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    Prescribed
  SIZING
    UNDEFINED
  ANNUAL
    UNDEFINED
ENDRULE


// ********** Heat Pump Water Heating Capacity Adjustment Curve ********
RULE WtrHtr:Cap_fTempCrvRef
  DESCRIPTION
    "Normalized curve that varies full-load efficiency (EIR) as a function of 
     indoor coil and condenser conditions."
  REFERENCE 
    NACM Section 5.7.6.5
  INPUTCLASS
    Prescribed 
  SIZING
    if( Type <> "Conventional" )
    then
      RuleLibrary(CrvDblQuad, "WtrHtrHtPumpQRatio_fTdbTdbSI")
    else UNDEFINED
    endif
  ANNUAL 
    z:Cap_fTempCrvRef
ENDRULE


// ********** Heat Pump Water Heating Capacity Adjustment Curve ********
RULE WtrHtr:COP_fTempCrvRef
  DESCRIPTION
    "Normalized curve that varies full-load efficiency (EIR) as a function of 
     indoor coil and condenser conditions."
  REFERENCE 
    NACM Section 5.7.6.5
  INPUTCLASS
    Prescribed 
  SIZING
    if( Type <> "Conventional" )
    then
      RuleLibrary(CrvDblQuad, "WtrHtrHtPumpCOP_fTdbTdbSI")
    else UNDEFINED
    endif
  ANNUAL 
    z:COP_fTempCrvRef
ENDRULE

// ---------- New NonRes Water Heater Count in Building --------------
RULE NEW WtrHtr:NewComDHWHtr
  DATATYPE
    Integer
  LONGFORM
    NewCommercialDomesticHotWaterHeater
  DESCRIPTION
    "This is the count of new Water Heaters in the building."
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    NotInput
  DEFAULT
    if( Status = "New" )
    then( 1 * FluidSysCnt )
    else 0
    endif
  SIZING
    if( Status = "New" )
    then( 1 * FluidSysCnt )
    else 0
    endif
  ANNUAL
    if( Status = "New" )
    then( 1 * FluidSysCnt )
    else 0
    endif
ENDRULE



// ----------------- Pilot Energy Required Boolean --------------------------------------
RULE NEW WtrHtr:PilotEnergyReq
  LONGFORM
    PilotEnergyRequired
  DATATYPE
    Integer
  INPUTCLASS
    NotInput
  DEFAULT
    if( Size = "Large" .AND. IsInstant = 1 )
    then 1
    else 0
    endif
ENDRULE


// -------------- Water Heater Type Report --------------
RULE WtrHtr:WtrHtrTypeRpt
  RULESETS
    T24N
  INPUTCLASS
    NotInput
  ANNUAL_PROPOSED
    if( IfValidAnd( Type <> "Conventional" ) )
    then
      if ( Type = "HeatPumpPackaged" )
      then "Heat-Pump Packaged"
      else if (Type = "HeatPumpSplit" )
      then "Heat-Pump Split"
      else u:Type
      endif endif
    else
       if( LocalStatus(SubType) > 0 )
       then SubType
       else "NA"
       endif
     endif   
  ANNUAL_BASELINE
    UNDEFINED
ENDRULE

// ----------------- Efficiency for Report -------------------------------------
RULE WtrHtr:EffRpt
  RULESETS
    T24N
  INPUTCLASS
    NotInput
  ANNUAL_PROPOSED
    if( ifValidAnd( ThrmlEffReq = 1 ).AND. IfValidAnd(UEFRtdVal < 10) ) 
    then
      Format("Thrml. Eff.: %s", FltToStr( ThrmlEff, 2 ) )
    else if( IfValidAnd( EFReq = 1 ) .AND. IfValidAnd(UEFRtdVal < 10 )  ) 
    then
      Format("EF: %s", FltToStr( EF, 2 ) )
    else if( IfValidAnd(UEFRtdVal >= 10 ) )
    then
      Format("UEF: %s", FltToStr( UEF, 2 ) )
    else "NA"
    endif endif endif
  ANNUAL_BASELINE
    UNDEFINED
ENDRULE


// ----------------- Standby Loss for Report -----------------------------------
RULE WtrHtr:StdbyLossRpt
  RULESETS
    T24N
  INPUTCLASS
    NotInput
  ANNUAL_PROPOSED
    if( IfValidAnd( StdbyLossFracReq = 1 ) ) then
      Format("SBLF: %s", FltToStr( StdbyLossFrac, 3 ) )
    else
      "SBLF: NA"
    endif
  ANNUAL_BASELINE
    UNDEFINED
ENDRULE


// ----------------- RE for Report -----------------------------------
RULE WtrHtr:RERpt
  RULESETS
    T24N
  INPUTCLASS
    NotInput
  ANNUAL_PROPOSED
    if( IfValidAnd( REReq = 1 ) ) then
      Format("RE: %s", FltToStr( RE, 2 ) )
    else
      "RE: NA"
    endif
  ANNUAL_BASELINE
    UNDEFINED
ENDRULE

// -------------- Water Heater Rated Capacity for Report --------------
RULE WtrHtr:CapRtdRpt
  RULESETS
    T24N
  INPUTCLASS
    NotInput
  ANNUAL_PROPOSED
    if( IfValidAnd( Type <> "Conventional" ) )
    then
      Format("%s (kW)", FltToStr( u:InpPwr, 1 ) ) 
    else
      Format("%s", FltToStr( (zp:CapRtdSim / zp:FluidSysCnt / 1000), 0 ) )  //this div by 1000 is a conversion for reporting from Btu/h to kBtu/h
    endif   
  ANNUAL_BASELINE
    UNDEFINED
ENDRULE

// -------------- Water Heater Storage Capacity for Report  --------------
RULE WtrHtr:StorCapRpt
  DESCRIPTION
    "This is the water heater's storage capacity with no multiplier."
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    NotInput
  UNITS
    gal
  REPORTPRECISION
    2
  DEFAULT
    UNDEFINED
  SIZING_PROPOSED
    UNDEFINED
  SIZING_BASELINE
    UNDEFINED
  ANNUAL_PROPOSED
    zp:StorCap
  ANNUAL_BASELINE
    UNDEFINED
ENDRULE


// -------------- Water Heater Pilot Energy for Report --------------------
RULE WtrHtr:PilotEnergyRpt
  DESCRIPTION
    "The water heater's pilot energy with no multiplier."
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    NotInput  IgnoreUserInput  "WtrHtr:PilotEnergyRpt removed in transition from 2016.2.1 to 2016.2.2"
  MINIMUM
    0
  MAXIMUM
    10000
  REPORTPRECISION
    0
  DEFAULT
    UNDEFINED
  SIZING_PROPOSED
    UNDEFINED
  SIZING_BASELINE
    UNDEFINED
  ANNUAL_PROPOSED
    if( IfValidAnd(PilotEnergyReq >= 0) )
     then 
       u:PilotEnergy
     else 
       UNDEFINED
     endif
  ANNUAL_BASELINE
    UNDEFINED
ENDRULE

// -------------- Water Heater Product Category for Report --------------------
RULE WtrHtr:ProdType
  DESCRIPTION
    ""
  HELP
    ""
  REFERENCE 
    ACM-5.9.1 Water Heating
  INPUTCLASS
    NotInput
  DEFAULT
    if( IfValidAnd(UEFRtdVal >= 10) )
    then 
      switch ( UEFRtdVal )
        case 10:  // Consumer Gas-Fired Storage Water Heater
          "Consumer"
        case 20:  // Consumer Intantaneous Gas-Fired Water Heater
          "Consumer"
        case 30:  // Residential-Duty Commercial Gas-Fired Storage
          "Residential-Duty Commercial"
        case 40:  // Consumer Electric Storage Water Heater
          "Consumer"
        case 50:  // Consumer Electric Storage Heat-Pump Water Heater
          "Consumer"
        case 60:  // Consumer Instantaneous Electric Water Heater
          "Consumer"
        case 70:  // Residential-Duty Commercial Electric Instantaneous Water Heater
          "Residential-Duty Commercial"	          
        default:
          UNDEFINED	  
      endswitch        
    else if( IfValidAnd(UEFRtdVal < 10) )
    then
      if( FuelSrc = "Gas" .AND. IfValidAnd( CapRtd > 0) .AND. IfValidAnd( StorCap > 0) )
      then
        if( IfValidAnd( StorCap >= 1 ) .AND. IfValidAnd( CapRtd > 200000 ) .AND.
            ( CapRtd / StorCap ) >= 4000 )
        then
          "Commercial"
        else if( IfValidAnd( StorCap >= 20 ) .OR. IfValidAnd( StorCap > 120 ) .AND.
                 IfValidAnd( CapRtd > 75000 ) )
        then 
          "Commercial"
        else Size
        endif endif 
      else if( FuelSrc = "Electricity" .AND. IfValidAnd( InpPwr > 0) .AND. IfValidAnd( StorCap > 0))
      then
        if( Type = "Conventional" .AND. StorCap >= 1 .AND. InpPwr > 12 )
        then
          "Commercial"
        else if( Type = "Conventional" .AND. InpPwr > 12 .AND.
                 StorCap >= 20 .OR. StorCap > 120 )
        then
          "Commercial"
        else if( Type <> "Conventional" )
        then
          UNDEFINED        
        else Size
        endif endif endif
      else Size
      endif endif
    else UNDEFINED
    endif endif
  ANNUAL_PROPOSED
    if( Parent(Type) = "ServiceHotWater" )  
    then
      if( Proj:SHWUserAndBaseline .OR. Proj:SHWPropOnly )
      then
        ProdType
      else if( Proj:SHWBothBaseline )
      then
        UNDEFINED        
      else if( Proj:SHWNone )
      then 
        UNDEFINED
      else 
        UNDEFINED
      endif endif endif
    else UNDEFINED
    endif  
  ANNUAL_BASELINE
    UNDEFINED
ENDRULE


// -------------- Water Heater First Hour Rating for Report --------------
RULE WtrHtr:FirstHrRatingRpt
  RULESETS
    T24N
  INPUTCLASS
    NotInput
  ANNUAL_PROPOSED
    if( IfValidAnd( IsUEFRtd = 1 ) .AND. IfValidAnd( SubType = "Storage") )
    then
      Format("FHR: %s", FltToStr( u:FirstHrRating, 1 ) ) 
    else 
      "FHR: NA"
    endif   
  ANNUAL_BASELINE
    UNDEFINED
ENDRULE

// -------------- Water Heater Flow Rate for Report --------------
RULE WtrHtr:FlowRtRpt
  RULESETS
    T24N
  INPUTCLASS
    NotInput
  ANNUAL_PROPOSED
    if( IfValidAnd( IsUEFRtd = 1 ) .AND. IfValidAnd( SubType = "Instantaneous") )
    then
      Format("Flow Rt: %s", FltToStr( u:FlowRt, 1 ) ) 
    else 
      "Flow Rt: NA"
    endif   
  ANNUAL_BASELINE
    UNDEFINED
ENDRULE


// -------------- Heat Pump Water Heater Storage Tank Location for Report --------------
RULE WtrHtr:TankZnRpt
  RULESETS
    T24N
  INPUTCLASS
    NotInput
  ANNUAL_PROPOSED
    if( IfValidAnd( Type <> "Conventional" ) .AND. ( IfValidAnd( Type = "HeatPumpPackaged") .OR. IfValidAnd( Type = "HeatPumpSplit") ) )
    then
      Format("Tank Zn: %s", StorZn ) 
    else 
      "Tank Zn: NA"
    endif   
  ANNUAL_BASELINE
    UNDEFINED
ENDRULE


// -------------- Heat Pump Water Heater Storage Tank Location for Report --------------
RULE WtrHtr:CprsrZnRpt
  RULESETS
    T24N
  INPUTCLASS
    NotInput
  ANNUAL_PROPOSED
    if( IfValidAnd( Type <> "Conventional" ) .AND. IfValidAnd( Type = "HeatPumpSplit") )
    then
      Format("Cprsr Zn: %s", CprsrZn ) 
    else 
      "Cprsr Zn: NA"
    endif   
  ANNUAL_BASELINE
    UNDEFINED
ENDRULE