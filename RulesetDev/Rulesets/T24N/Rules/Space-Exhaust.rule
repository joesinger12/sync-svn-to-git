// Space - Exhaust
//
// -------------------------------------------------------------------------
//  Copyright (c) 2014-2017, California Energy Commission
//  All rights reserved.
//  Redistribution and use in source and binary forms, with or without
//  modification, are permitted provided that the following conditions are
//  met:
// 
//    * Redistributions of source code must retain the above copyright
//  notice, this list of conditions and the following disclaimer.
//    * Redistributions in binary form must reproduce the above copyright
//  notice, this list of conditions and the following disclaimer in
//  the documentation and/or other materials provided with the
//  distribution.
//    * Neither the name of the California Energy Commission nor the names of its
//  contributors may be used to endorse or promote products
//  derived from this software without specific prior written
//  permission.
//
//  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS
//  IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED
//  TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A
//  PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL CALIFORNIA ENERGY COMMISSION
//  BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
//  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
//  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR
//  BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
//  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR
//  OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
//  ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
// -------------------------------------------------------------------------
//  


// -------------- Laboratory --------------------
RULE Spc:LabExhRtType
  DESCRIPTION
    "The type of load that drives the design ventilation/exhaust rate for 
     Laboratory spaces."
//  This input is now only used for defaulting. See issue 2139
  HELP
    "For Labortory spaces with process exhaust, the this input defaults the value
     for ventilation and exhaust; 6 ACH for 'LoadDominated', and 10 ACH if 'HoodDominated'.


     This input is only used to default the design ventilation/exhaust ACH
     rate for Laboratory spaces if a SpaceFunctionDefault is NOT assigned.
     If a SpaceFunctionDefault is assigned, that ventilation value will override this
     default."
//HELP - Old
// "The user specified design ventilation/exhaust air flow rates must be at least
//  6 ACH for 'LoadDominated', and 15 ACH if 'HoodDominated'. Otherwise, the
//  ventilation/exhaust flow rates are as designed."
  INPUTCLASS : T24N_2016
    Default
  INPUTCLASS : T24N
    NotInput  IgnoreUserInput  "Removed in transition from 2019.0.2 to 0.3. Use new fume hood length inputs."
  OPTION
    HoodDominated
    LoadDominated
  DEFAULT : T24N_2016
    if( LabArea > 0 )
    then "LoadDominated"
    else UNDEFINED
    endif
  SIZING
    if( LabArea > 0 )
    then LabExhRtType
    else UNDEFINED
    endif
  ANNUAL
    z:LabExhRtType
ENDRULE

RULE Spc:LabFumeHoodLen
  DESCRIPTION
    "The total horizontal length of all laboratory fume hoods in the Space."
  HELP
    "This total includes hoods with both vertical and horizontal sashes."
  INPUTCLASS : T24N_2016
    NotInput
  INPUTCLASS
    Optional
  MINIMUM
    0
  UNITS
    ft
  DEFAULT : T24N_2016
    UNDEFINED
  DEFAULT
    if( Proj:AutoHardSize > 0 .AND. LabArea > 0 )
    then // Default assuming 250cfm/LF of hood length
      Int( ValidOr( ExhFlow, 0 ) / 250 )
    else 0
    endif
ENDRULE

RULE Spc:LabFumeHoodVertSashExhFlow
  DESCRIPTION
    "The total design exhaust air flow of all laboratory fume hoods with
     vertical sashes in the Space."
  INPUTCLASS
    Optional
  MINIMUM
    0
  UNITS
    cfm
  DEFAULT : T24N_2016
    UNDEFINED
  DEFAULT
    if( Proj:AutoHardSize > 0 .AND. LabArea > 0 )
    then // Default assuming 250cfm/LF of hood length
      ValidOr( LabFumeHoodLen, 0 ) * 250 
    else 0
    endif
ENDRULE

RULE Spc:LabFumeHoodVertAutoSashCtrlFrac
  DESCRIPTION
    "The fraction of laboratory fume hoods in the Space with vertical sashes 
     that have automatic sash controls."
  INPUTCLASS : T24N_2016
    NotInput
  INPUTCLASS
    Optional
  MINIMUM
    0
  MAXIMUM 
    1
  DEFAULT : T24N_2016
    UNDEFINED
  DEFAULT
    0
ENDRULE

RULE NEW Spc:LabFumeHoodVertAutoSashExhFlow
  DATATYPE
    Float
  LONGFORM
    LaboratoryFumeHoodVerticalAutomaticSashExhaustFlow
  DESCRIPTION
    "The design exhaust air flow rate of vertical sash fumehoods times the 
     fraction of flow that have automatic sash controls in the Space."
  INPUTCLASS
    NotInput
  UNITS
    cfm
  DEFAULT
    ValidOr( LabFumeHoodVertSashExhFlow, 0 ) * ValidOr( LabFumeHoodVertAutoSashCtrlFrac, 0 )
ENDRULE

RULE Spc:PropMinExhACH
  DESCRIPTION
    "The minimum exhaust air flow rate, in ACH, for the Space."  
  HELP
    "Currently only supported for VAV laboratory systems."
  INPUTCLASS : T24N_2016
    NotInput
  INPUTCLASS
    Default
  UNITS
    ACH
  MINIMUM
    0
  COMMONMAXIMUM
    20
  DEFAULT : T24N_2016
    UNDEFINED
  DEFAULT
    if( LabArea > 0 )
    then ValidOr( PropMinVentACH, 0 )
    else UNDEFINED
    endif
ENDRULE

;RULE NEW Spc:LabFumeHoodVertAutoSashExhFlowWithMult
;  DATATYPE
;    Float
;  LONGFORM
;    LaboratoryFumeHoodVerticalAutomaticSashExhaustFlowWithMultiplier
;  DESCRIPTION
;    "The design exhaust air flow rate of vertical sash fumehoods times the 
;     fraction of flow that have automatic sash controls, with the space multiplier."
;  INPUTCLASS
;    NotInput
;  UNITS
;    cfm
;  DEFAULT
;    LabFumeHoodVertAutoSashExhFlow * Mult
;ENDRULE

// -------------- Commerical Kitchen --------------------
// Kitchen hood style
RULE Spc:KitExhHoodStyle[1]
  DESCRIPTION
    "The commercial kitchen exhaust hood style, as defined in Table 140.9-A of
     the Standards."
  INPUTCLASS
    Optional
  OPTION
    None
    WallMountedCanopy
    SingleIsland
    DoubleIsland
    Eyebrow
    BackshelfOrPassover
  DEFAULT
    if( CommKitArea > 0 )
    then "None"
    else UNDEFINED
    endif
  SIZING
    if( CommKitArea > 0 )
    then KitExhHoodStyle[1]
    else UNDEFINED
    endif
  ANNUAL
    z:KitExhHoodStyle[1]
ENDRULE
RULE Spc:KitExhHoodStyle[2]
  DEFAULT
    if( CommKitArea > 0 .AND. IfValidAnd( KitExhHoodStyle[1] != "None" ) )
    then "None"
    else UNDEFINED
    endif
  SIZING
    if( CommKitArea > 0 .AND. IfValidAnd( KitExhHoodStyle[1] != "None" ) )
    then KitExhHoodStyle[2]
    else UNDEFINED
    endif
  ANNUAL
    z:KitExhHoodStyle[2]
ENDRULE
RULE Spc:KitExhHoodStyle[3]
  DEFAULT
    if( CommKitArea > 0 .AND. IfValidAnd( KitExhHoodStyle[2] != "None" ) )
    then "None"
    else UNDEFINED
    endif
  SIZING
    if( CommKitArea > 0 .AND. IfValidAnd( KitExhHoodStyle[2] != "None" ) )
    then KitExhHoodStyle[3]
    else UNDEFINED
    endif
  ANNUAL
    z:KitExhHoodStyle[3]
ENDRULE
RULE Spc:KitExhHoodStyle[4]
  DEFAULT
    if( CommKitArea > 0 .AND. IfValidAnd( KitExhHoodStyle[3] != "None" ) )
    then "None"
    else UNDEFINED
    endif
  SIZING
    if( CommKitArea > 0 .AND. IfValidAnd( KitExhHoodStyle[3] != "None" ) )
    then KitExhHoodStyle[4]
    else UNDEFINED
    endif
  ANNUAL
    z:KitExhHoodStyle[4]
ENDRULE
RULE Spc:KitExhHoodStyle[5]
  DEFAULT
    if( CommKitArea > 0 .AND. IfValidAnd( KitExhHoodStyle[4] != "None" ) )
    then "None"
    else UNDEFINED
    endif
  SIZING
    if( CommKitArea > 0 .AND. IfValidAnd( KitExhHoodStyle[4] != "None" ) )
    then KitExhHoodStyle[5]
    else UNDEFINED
    endif
  ANNUAL
    z:KitExhHoodStyle[5]
ENDRULE

// Kitchen hood duty
RULE Spc:KitExhHoodDuty[1]
  DESCRIPTION
    "The commercial kitchen exhaust hood cooking duty, as defined in Table
     140.9-A of the Standards."
  INPUTCLASS
    CondRequired
// Enums defined in BEMEnums.txt
//OPTION
//  Light
//  Medium
//  Heavy
//  ExtraHeavy
  SIZING
    if( IfValidAnd( KitExhHoodStyle[1] != "None" ) )
    then KitExhHoodDuty[1]
    else UNDEFINED
    endif
ENDRULE
RULE Spc:KitExhHoodDuty[2]
  SIZING
    if( IfValidAnd( KitExhHoodStyle[2] != "None" ) )
    then KitExhHoodDuty[2]
    else UNDEFINED
    endif
ENDRULE
RULE Spc:KitExhHoodDuty[3]
  SIZING
    if( IfValidAnd( KitExhHoodStyle[3] != "None" ) )
    then KitExhHoodDuty[3]
    else UNDEFINED
    endif
ENDRULE
RULE Spc:KitExhHoodDuty[4]
  SIZING
    if( IfValidAnd( KitExhHoodStyle[4] != "None" ) )
    then KitExhHoodDuty[4]
    else UNDEFINED
    endif
ENDRULE
RULE Spc:KitExhHoodDuty[5]
  SIZING
    if( IfValidAnd( KitExhHoodStyle[5] != "None" ) )
    then KitExhHoodDuty[5]
    else UNDEFINED
    endif
ENDRULE

// Kitchen hood length
RULE Spc:KitExhHoodLen[1]
  DESCRIPTION
    "The total linear length of commercial kitchen exhaust hoods located in the 
     space."  
  INPUTCLASS
    CondRequired
  UNITS
    ft
  MINIMUM
    0
  CHECKCODE
    if( CommKitArea > 0 .AND.
        IfValidAnd( KitExhHoodStyle[1] != "None" ) .AND.
        IfValidAnd( KitExhHoodLen[1] = 0 ) )
    then
      PostError("The kitchen exhaust hood length must be defined for Space '%s'.",
                 Name)
    else UNCHANGED
    endif     
  SIZING
    if( CommKitArea > 0 .AND. IfValidAnd( KitExhHoodStyle[1] != "None" ) )    
    then KitExhHoodLen[1]
    else UNDEFINED
    endif
ENDRULE
RULE Spc:KitExhHoodLen[2]
  CHECKCODE
    if( CommKitArea > 0 .AND.
        IfValidAnd( KitExhHoodStyle[2] != "None" ) .AND.
        IfValidAnd( KitExhHoodLen[2] = 0 ) )
    then
      PostError("The kitchen exhaust hood length must be defined for Space '%s'.",
                 Name)
    else UNCHANGED
    endif 
  SIZING
    if( CommKitArea > 0 .AND. IfValidAnd( KitExhHoodStyle[2] != "None" ) )    
    then KitExhHoodLen[2]
    else UNDEFINED
    endif
ENDRULE
RULE Spc:KitExhHoodLen[3]
  CHECKCODE
    if( CommKitArea > 0 .AND.
        IfValidAnd( KitExhHoodStyle[3] != "None" ) .AND.
        IfValidAnd( KitExhHoodLen[3] = 0 ) )
    then
      PostError("The kitchen exhaust hood length must be defined for Space '%s'.",
                 Name)
    else UNCHANGED
    endif 
  SIZING
    if( CommKitArea > 0 .AND. IfValidAnd( KitExhHoodStyle[3] != "None" ) )    
    then KitExhHoodLen[3]
    else UNDEFINED
    endif
ENDRULE
RULE Spc:KitExhHoodLen[4]
  CHECKCODE
    if( CommKitArea > 0 .AND.
        IfValidAnd( KitExhHoodStyle[4] != "None" ) .AND.
        IfValidAnd( KitExhHoodLen[4] = 0 ) )
    then
      PostError("The kitchen exhaust hood length must be defined for Space '%s'.",
                 Name)
    else UNCHANGED
    endif 
  SIZING
    if( CommKitArea > 0 .AND. IfValidAnd( KitExhHoodStyle[4] != "None" ) )    
    then KitExhHoodLen[4]
    else UNDEFINED
    endif
ENDRULE
RULE Spc:KitExhHoodLen[5]
  CHECKCODE
    if( CommKitArea > 0 .AND.
        IfValidAnd( KitExhHoodStyle[5] != "None" ) .AND.
        IfValidAnd( KitExhHoodLen[5] = 0 ) )
    then
      PostError("The kitchen exhaust hood length must be defined for Space '%s'.",
                 Name)
    else UNCHANGED
    endif 
  SIZING
    if( CommKitArea > 0 .AND. IfValidAnd( KitExhHoodStyle[5] != "None" ) )    
    then KitExhHoodLen[5]
    else UNDEFINED
    endif
ENDRULE

// Kitchen exhaust flow per length, based on standards table
RULE NEW Spc:KitExhHoodFlowPerFt1
  DATATYPE
    Float
  LONGFORM
    KitchenExhaustHoodFlowPerFoot1
  INPUTCLASS
    NotInput
  UNITS
    cfm/ft
  DEFAULT
    if( IfValidAnd( KitExhHoodStyle[1] != "None" ) .AND.
        LocalStatus( KitExhHoodDuty[1] ) > 0 )
    then 
      KitExhHoodMaxFlow:FlowPerLen( "Style", KitExhHoodStyle[1], 
                                    "Duty", KitExhHoodDuty[1] )
    else UNDEFINED  
    endif
ENDRULE 
RULE NEW Spc:KitExhHoodFlowPerFt2
  DATATYPE
    Float
  LONGFORM
    KitchenExhaustHoodFlowPerFoot2
  INPUTCLASS
    NotInput
  UNITS
    cfm/ft
  DEFAULT
    if( IfValidAnd( KitExhHoodStyle[2] != "None" ) .AND.
        LocalStatus( KitExhHoodDuty[2] ) > 0 )
    then 
      KitExhHoodMaxFlow:FlowPerLen( "Style", KitExhHoodStyle[2], 
                                    "Duty", KitExhHoodDuty[2] )
    else UNDEFINED  
    endif
ENDRULE 
RULE NEW Spc:KitExhHoodFlowPerFt3
  DATATYPE
    Float
  LONGFORM
    KitchenExhaustHoodFlowPerFoot3
  INPUTCLASS
    NotInput
  UNITS
    cfm/ft
  DEFAULT
    if( IfValidAnd( KitExhHoodStyle[3] != "None" ) .AND.
        LocalStatus( KitExhHoodDuty[3] ) > 0 )
    then 
      KitExhHoodMaxFlow:FlowPerLen( "Style", KitExhHoodStyle[3], 
                                    "Duty", KitExhHoodDuty[3] )
    else UNDEFINED  
    endif
ENDRULE 
RULE NEW Spc:KitExhHoodFlowPerFt4
  DATATYPE
    Float
  LONGFORM
    KitchenExhaustHoodFlowPerFoot4
  INPUTCLASS
    NotInput
  UNITS
    cfm/ft
  DEFAULT
    if( IfValidAnd( KitExhHoodStyle[4] != "None" ) .AND.
        LocalStatus( KitExhHoodDuty[4] ) > 0 )
    then 
      KitExhHoodMaxFlow:FlowPerLen( "Style", KitExhHoodStyle[4], 
                                    "Duty", KitExhHoodDuty[4] )
    else UNDEFINED  
    endif
ENDRULE 
RULE NEW Spc:KitExhHoodFlowPerFt5
  DATATYPE
    Float
  LONGFORM
    KitchenExhaustHoodFlowPerFoot5
  INPUTCLASS
    NotInput
  UNITS
    cfm/ft
  DEFAULT
    if( IfValidAnd( KitExhHoodStyle[5] != "None" ) .AND.
        LocalStatus( KitExhHoodDuty[5] ) > 0 )
    then 
      KitExhHoodMaxFlow:FlowPerLen( "Style", KitExhHoodStyle[5], 
                                    "Duty", KitExhHoodDuty[5] )
    else UNDEFINED  
    endif
ENDRULE 

// Kitchen exhaust flow per hood, based on length and 
RULE Spc:KitExhHoodFlow[1]
  INPUTCLASS
    Default
  UNITS
    cfm
  MINIMUM
    0
  DEFAULT
    if( IfValidAnd( KitExhHoodLen[1] > 0 ) .AND.
        IfValidAnd( KitExhHoodFlowPerFt1 > 0 ) )
    then KitExhHoodFlowPerFt1 * KitExhHoodLen[1]
    else UNDEFINED
    endif
  CHECKCODE
    if( CommKitArea > 0 .AND.
        IfValidAnd( KitExhHoodStyle[1] != "None" ) .AND.
        IfValidAnd( KitExhHoodFlow[1] != 0 ) = 0 )
    then
      PostError("The kitchen exhaust hood flow must be defined for Space '%s'.",
                 Name)
    else UNCHANGED
    endif
  SIZING
    if( CommKitArea > 0 .AND. IfValidAnd( KitExhHoodStyle[1] != "None" ) )    
    then KitExhHoodFlow[1]
    else UNDEFINED
    endif
ENDRULE 
RULE Spc:KitExhHoodFlow[2]
  DEFAULT
    if( IfValidAnd( KitExhHoodLen[2] > 0 ) .AND.
        IfValidAnd( KitExhHoodFlowPerFt2 > 0 ) )
    then KitExhHoodFlowPerFt2 * KitExhHoodLen[2]
    else UNDEFINED
    endif
  CHECKCODE
    if( CommKitArea > 0 .AND.
        IfValidAnd( KitExhHoodStyle[2] != "None" ) .AND.
        IfValidAnd( KitExhHoodFlow[2] != 0 ) = 0 )
    then
      PostError("The kitchen exhaust hood flow must be defined for Space '%s'.",
                 Name)
    else UNCHANGED
    endif 
  SIZING
    if( CommKitArea > 0 .AND. IfValidAnd( KitExhHoodStyle[2] != "None" ) )    
    then KitExhHoodFlow[2]
    else UNDEFINED
    endif
ENDRULE 
RULE Spc:KitExhHoodFlow[3]
  DEFAULT
    if( IfValidAnd( KitExhHoodLen[3] > 0 ) .AND.
        IfValidAnd( KitExhHoodFlowPerFt3 > 0 ) )
    then KitExhHoodFlowPerFt3 * KitExhHoodLen[3]
    else UNDEFINED
    endif
  CHECKCODE
    if( CommKitArea > 0 .AND.
        IfValidAnd( KitExhHoodStyle[3] != "None" ) .AND.
        IfValidAnd( KitExhHoodFlow[3] != 0 ) = 0 )
    then
      PostError("The kitchen exhaust hood flow must be defined for Space '%s'.",
                 Name)
    else UNCHANGED
    endif 
  SIZING
    if( CommKitArea > 0 .AND. IfValidAnd( KitExhHoodStyle[3] != "None" ) )    
    then KitExhHoodFlow[3]
    else UNDEFINED
    endif
ENDRULE 
RULE Spc:KitExhHoodFlow[4]
  DEFAULT
    if( IfValidAnd( KitExhHoodLen[4] > 0 ) .AND.
        IfValidAnd( KitExhHoodFlowPerFt4 > 0 ) )
    then KitExhHoodFlowPerFt4 * KitExhHoodLen[4]
    else UNDEFINED
    endif
  CHECKCODE
    if( CommKitArea > 0 .AND.
        IfValidAnd( KitExhHoodStyle[4] != "None" ) .AND.
        IfValidAnd( KitExhHoodFlow[4] != 0 ) = 0 )
    then
      PostError("The kitchen exhaust hood flow must be defined for Space '%s'.",
                 Name)
    else UNCHANGED
    endif
  SIZING
    if( CommKitArea > 0 .AND. IfValidAnd( KitExhHoodStyle[4] != "None" ) )    
    then KitExhHoodFlow[4]
    else UNDEFINED
    endif
ENDRULE 
RULE Spc:KitExhHoodFlow[5]
  DEFAULT
    if( IfValidAnd( KitExhHoodLen[5] > 0 ) .AND.
        IfValidAnd( KitExhHoodFlowPerFt5 > 0 ) )
    then KitExhHoodFlowPerFt5 * KitExhHoodLen[5]
    else UNDEFINED
    endif
  CHECKCODE
    if( CommKitArea > 0 .AND.
        IfValidAnd( KitExhHoodStyle[5] != "None" ) .AND.
        IfValidAnd( KitExhHoodFlow[5] != 0 ) = 0 )
    then
      PostError("The kitchen exhaust hood flow must be defined for Space '%s'.",
                 Name)
    else UNCHANGED
    endif 
  SIZING
    if( CommKitArea > 0 .AND. IfValidAnd( KitExhHoodStyle[5] != "None" ) )    
    then KitExhHoodFlow[5]
    else UNDEFINED
    endif
ENDRULE 

RULE NEW Spc:MaxKitExhHoodFlow1
  DATATYPE
    Float
  DESCRIPTION
    "The maximum kitchen exhaust hood air flow, per Table 140.9-A of
     the Standard"  
  INPUTCLASS
    NotInput
  UNITS
    cfm
  MINIMUM
    0
  DEFAULT
    if( IfValidAnd( KitExhHoodLen[1] > 0 ) .AND.
        IfValidAnd( KitExhHoodFlowPerFt1 > 0 ) )
    then KitExhHoodFlowPerFt1 * KitExhHoodLen[1]
    else 0
    endif
ENDRULE 
RULE NEW Spc:MaxKitExhHoodFlow2
  DATATYPE
    Float
  INPUTCLASS
    NotInput
  UNITS
    cfm
  MINIMUM
    0
  DEFAULT
    if( IfValidAnd( KitExhHoodLen[2] > 0 ) .AND.
        IfValidAnd( KitExhHoodFlowPerFt2 > 0 ) )
    then KitExhHoodFlowPerFt2 * KitExhHoodLen[2]
    else 0
    endif
ENDRULE
RULE NEW Spc:MaxKitExhHoodFlow3
  DATATYPE
    Float
  INPUTCLASS
    NotInput
  UNITS
    cfm
  MINIMUM
    0
  DEFAULT
    if( IfValidAnd( KitExhHoodLen[3] > 0 ) .AND.
        IfValidAnd( KitExhHoodFlowPerFt3 > 0 ) )
    then KitExhHoodFlowPerFt3 * KitExhHoodLen[3]
    else 0
    endif
ENDRULE 
RULE NEW Spc:MaxKitExhHoodFlow4
  DATATYPE
    Float
  INPUTCLASS
    NotInput
  UNITS
    cfm
  MINIMUM
    0
  DEFAULT
    if( IfValidAnd( KitExhHoodLen[4] > 0 ) .AND.
        IfValidAnd( KitExhHoodFlowPerFt4 > 0 ) )
    then KitExhHoodFlowPerFt4 * KitExhHoodLen[4]
    else 0
    endif
ENDRULE 
RULE NEW Spc:MaxKitExhHoodFlow5
  DATATYPE
    Float
  INPUTCLASS
    NotInput
  UNITS
    cfm
  MINIMUM
    0
  DEFAULT
    if( IfValidAnd( KitExhHoodLen[5] > 0 ) .AND.
        IfValidAnd( KitExhHoodFlowPerFt5 > 0 ) )
    then KitExhHoodFlowPerFt5 * KitExhHoodLen[5]
    else 0
    endif
ENDRULE 


TABLE KitExhHoodMaxFlow
   Style                FlowPerLen  FlowPerLen  FlowPerLen  FlowPerLen
   Duty=                "Light"     "Medium"    "Heavy"     "ExtraHeavy"
   WallMountedCanopy    140         210         280         385
   SingleIsland         280         350         420         490
   DoubleIsland         175         210         280         385
   Eyebrow              175         175         Error1      Error1
   BackshelfOrPassover  210         210         280         Error1
Error1     "Not allowed per Table 140.9-A of the Standard."
ENDTABLE


// Calculate the design exhaust flow for covered process spaces
RULE NEW Spc:TotKitExhHoodFlow
  DATATYPE
    Float
  LONGFORM
    TotalKitchenExhaustHoodFlow
  DESCRIPTION
    "The total kitchen exhaust hood air flow, in cfm, for the Space."  
  HELP
    "The sum of all KitchenExhaustHoodFlows."
  INPUTCLASS
    NotInput
  UNITS
    cfm
  DEFAULT
    if( CommKitArea > 0 )
    then 
      ValidOr( KitExhHoodFlow[1], 0 ) +
      ValidOr( KitExhHoodFlow[2], 0 ) +
      ValidOr( KitExhHoodFlow[3], 0 ) +
      ValidOr( KitExhHoodFlow[4], 0 ) +
      ValidOr( KitExhHoodFlow[5], 0 )
    else 0
    endif
  SIZING
    if( CommKitArea > 0 )
    then 
      ValidOr( KitExhHoodFlow[1], 0 ) +
      ValidOr( KitExhHoodFlow[2], 0 ) +
      ValidOr( KitExhHoodFlow[3], 0 ) +
      ValidOr( KitExhHoodFlow[4], 0 ) +
      ValidOr( KitExhHoodFlow[5], 0 )
    else 0
    endif
ENDRULE
// Total kitchen hood flow based on maximum allowed by Std
RULE NEW Spc:MaxTotKitExhHoodFlow
  DATATYPE
    Float
  LONGFORM
    MaximumTotalKitchenExhaustHoodFlow
  DESCRIPTION
    "The sum of maximum kitchen exhaust hood air flows, per Table 140.9-A of
     the Standard, for the Space."  
  INPUTCLASS
    NotInput
  UNITS
    cfm
  DEFAULT
    if( CommKitArea > 0 )
    then 
      MaxKitExhHoodFlow1 +
      MaxKitExhHoodFlow2 +
      MaxKitExhHoodFlow3 +
      MaxKitExhHoodFlow4 +
      MaxKitExhHoodFlow5
    else 0
    endif
  SIZING
    if( CommKitArea > 0 )
    then 
      MaxKitExhHoodFlow1 +
      MaxKitExhHoodFlow2 +
      MaxKitExhHoodFlow3 +
      MaxKitExhHoodFlow4 +
      MaxKitExhHoodFlow5
    else 0
    endif
ENDRULE

RULE NEW Spc:ExhSpecMthd
  DATATYPE
    Enumeration
  LONGFORM
    ExhaustSpecificationMethod
  DESCRIPTION
    "The method used to calculate the design exhaust flow for the ThermalZone.
     Rates are specified at the Space, and a weighted average is calculated for the
     ThermalZone, based on the selected specification method."
  HELP
    "The design exhaust air flow is calculated as follows:


     Maximum = The maximum of all the various input values. This method is used
     if the Ventilation Specification Method is 'Maximum' or 'NoVentilation'.


     Sum = The sum of all the various input values. This method is used if 
            Ventilation Specification Method is 'Sum'."
  INPUTCLASS
    NotInput
  OPTION
    NoExhaust
    Maximum
    Sum
  DEFAULT
    if( VentSpecMthd = "Sum" ) 
    then "Sum"
    else "Maximum"
    endif
ENDRULE

// ********** Code Minimum Exhaust Components ******************************
// Per Area basis
RULE NEW Spc:CodeExhPerArea
  DATATYPE
    Float
  LONGFORM
    CodeExhaustPerArea
  DESCRIPTION
     "The code mininum amount of exhaust flow per floor area."
  INPUTCLASS
    NotInput
  UNITS
    cfm/ft2 
  DEFAULT : T24N_2016
    if( HasProcExh > 0 .AND. PrkgGarArea > 0 )
    then ValidOr( CodeVentPerArea, 0 )
    else 0
    endif
  DEFAULT : T24N
    if( VentIsRequired = 0 )
    then 0
    else
    if( IsProcExhSpc > 0 .AND. HasProcExh = 0 )
    then // Process spaces that don't have ProcExh have 0 code required exhaust
      0 
    else
    if( LabArea > 0 )
    then // For labs use the max of the user input or code min
      Max( ValidOr( ExhPerArea, 0 ), VentilationSpaceFunctionData:CodeExhPerArea("VentFuncType", VentSpcFunc) )
    else VentilationSpaceFunctionData:CodeExhPerArea("VentFuncType", VentSpcFunc)
    endif endif endif
  DEFAULT : S901G ECBC
    0
ENDRULE

RULE NEW Spc:CodeOtherExhPerArea
  DATATYPE
    Float
  LONGFORM
    CodeOtherExhaustPerArea
  DESCRIPTION
     "The code mininum amount of exhaust flow per floor area for 'Other'
      ventilation standards." 
  INPUTCLASS : T24N
    NotInput  IgnoreUserInput  "Spc:CodeOtherExhPerArea removed prior to release of 2016.3.0"
  INPUTCLASS : S901G
    Default
  UNITS
    cfm/ft2
  DEFAULT
    ValidOr( ExhPerArea, 0 )
ENDRULE

RULE NEW Spc:CodeExhPerAreaFlow
  DATATYPE
    Float
  LONGFORM
    CodeExhaustPerAreaFlow
  DESCRIPTION
     "The code required exhaust air flow rate, in cfm, associated with the ExhPerArea input."  
  INPUTCLASS
    NotInput
  UNITS
    cfm
  DEFAULT
   if( VentStd = "Other" )
   then CodeOtherExhPerArea * FlrArea
   else CodeExhPerArea * FlrArea
   endif
  SIZING
   if( VentStd = "Other" )
   then CodeOtherExhPerArea * FlrArea
   else CodeExhPerArea * FlrArea
   endif
  ANNUAL
    z:CodeExhPerAreaFlow
ENDRULE

// ACH
RULE NEW Spc:CodeExhACH
  DATATYPE
    Float
  LONGFORM
    CodeExhaustAirChangesPerHour
  DESCRIPTION
     "The code mininum amount of exhaust, in cubic feet per hour,
      divided by the volume of the space."
  REFERENCE
    NACM Section 5.6.5.4
  INPUTCLASS
    NotInput
  UNITS
    ACH
  DEFAULT : T24N_2016
    if( HasProcExh > 0 .AND. LabArea > 0 )
    then ValidOr( CodeVentACH, 0 )
    else 0
    endif
  DEFAULT
    if( VentIsRequired = 0 )
    then 0
    else 0
    endif
  DEFAULT : S901G ECBC
    0
ENDRULE

RULE NEW Spc:CodeOtherExhACH
  DATATYPE
    Float
  LONGFORM
    CodeOtherExhaustAirChangesPerHour
  DESCRIPTION
     "The code mininum amount of exhaust flow, in cubic feet per hour,
      divided by the volume of the space for 'Other' ventilation standards."
  INPUTCLASS : T24N
    NotInput  IgnoreUserInput  "Spc:CodeOtherExhACH removed prior to release of 2016.3.0"
  INPUTCLASS : S901G
    Default
  UNITS
    ACH
  DEFAULT
    ValidOr( ExhACH, 0 )
ENDRULE

RULE NEW Spc:CodeExhACHFlow
  DATATYPE
    Float
  LONGFORM
    CodeExhaustAirChangesPerHourFlow
  DESCRIPTION
     "The code required exhaust air flow rate, in cfm, associated with the CodeExhACH input."  
  INPUTCLASS
    NotInput
  UNITS
    cfm
  DEFAULT
   if( VentStd = "Other" )
   then CodeOtherExhACH * ValidOr( Vol, 0 ) / 60
   else CodeExhACH * ValidOr( Vol, 0 ) / 60
   endif
  SIZING
   if( VentStd = "Other" )
   then CodeOtherExhACH * Vol / 60
   else CodeExhACH * Vol / 60
   endif
  ANNUAL
    z:CodeExhACHFlow
ENDRULE

RULE NEW Spc:CodeExhContPerFixture
  DATATYPE
    Float
  LONGFORM
    CodeExhaustContinuousPerFixture
  DESCRIPTION
    "The code required continuous exhaust air flow rate per fixture 
     (toilet, showerhead, etc)."
  INPUTCLASS
    NotInput
  UNITS
    cfm
  DEFAULT : T24N_2016
    0
  DEFAULT
    if( VentIsRequired > 0 )
    then VentilationSpaceFunctionData:CodeExhContPerFixture("VentFuncType", VentSpcFunc)    
    else 0
    endif
ENDRULE

RULE NEW Spc:CodeExhIntrmtPerFixture
  DATATYPE
    Float
  LONGFORM
    CodeExhaustIntermittentPerFixture
  DESCRIPTION
    "The code required intermittent exhaust air flow rate per fixture 
     (toilet, showerhead, etc)."
  INPUTCLASS
    NotInput
  UNITS
    cfm
  DEFAULT : T24N_2016
    0
  DEFAULT
    if( VentIsRequired > 0 )
    then VentilationSpaceFunctionData:CodeExhIntrmtPerFixture("VentFuncType", VentSpcFunc)    
    else 0
    endif
ENDRULE

// Not yet supported
;RULE Spc:ExhIntrmtPerFixture
;  DESCRIPTION
;    "The intermittent exhaust air flow rate per fixture 
;     (toilet, showerhead, etc)."
;  INPUTCLASS
;    Default
;  UNITS
;    cfm
;ENDRULE

// Per Spc
RULE NEW Spc:CodeExhPerSpc
  DATATYPE
    Float
  LONGFORM
    CodeExhaustPerSpace
  INPUTCLASS
    NotInput
  UNITS
    cfm
  DEFAULT : T24N_2016
    0
  DEFAULT
    if( VentIsRequired = 0 )
    then 0
    else
    if( LabArea > 0 )
    then // For labs use user input
      ValidOr( ExhPerSpc, 0 )
    else
    if( IfValidAnd( CodeExhContPerFixture > 0 ) )
    then 
      if( IfValidAnd( IsIntrmtExh > 0 ) .AND. IfValidAnd( CodeExhIntrmtPerFixture > 0 ) )
      then 0
      else ValidOr( ExhNumFixtures, 0 ) * CodeExhContPerFixture
      endif
    else 0
    endif endif endif
ENDRULE

RULE NEW Spc:CodeOtherExhPerSpc
  DATATYPE
    Float
  LONGFORM
    CodeOtherExhaustPerSpace
  INPUTCLASS
    NotInput
  UNITS
    cfm
  DEFAULT
    ValidOr( ExhPerSpc, 0 )
ENDRULE

RULE NEW Spc:CodeExhPerSpcFlow
  DATATYPE
    Float
  LONGFORM
    CodeExhaustPerSpaceFlow
  DESCRIPTION
     "The code required exhaust flow rate, in cfm, associated with the CodeExhPerSpc input."  
  INPUTCLASS
    NotInput   
  UNITS
    cfm
  DEFAULT
   if( VentStd = "Other" )
   then CodeOtherExhPerSpc
   else CodeExhPerSpc
   endif
  SIZING
   if( VentStd = "Other" )
   then CodeOtherExhPerSpc
   else CodeExhPerSpc
   endif
  ANNUAL
    z:CodeExhPerSpc
ENDRULE


// ********** Proposed Exhaust Components **************************************
// Per Area basis
RULE Spc:ExhPerArea
  DESCRIPTION
    "The design exhaust air flow rate, in cfm/ft2, for the Space."  
  INPUTCLASS
    Optional
  UNITS
    cfm/ft2
  MINIMUM
    0
  DEFAULT : T24N_2016
    if( PrkgGarArea > 0 .OR. LabArea > 0 )
    then VentPerArea
    else
    if( LocalCompAssigned( SpcFuncDefaultsRef ) .AND. LocalStatus( SpcFunc ) < 5 )
    then SpcFuncDefaultsRef:ExhPerArea
    else 0
    endif endif
  DEFAULT
    if( LocalCompAssigned( SpcFuncDefaultsRef ) .AND. LocalStatus( SpcFunc ) < 5 )
    then SpcFuncDefaultsRef:ExhPerArea
    else CodeExhPerArea
    endif
  SIZING_PROPOSED
    if( HasUnknownHVAC > 0 )
    then // Partial Envelope, use NACM exhaust rates
      CodeExhPerArea
    else ExhPerArea
    endif
  SIZING_BASELINE
    zp:ExhPerArea   
  ANNUAL
    z:ExhPerArea
ENDRULE

RULE NEW Spc:ExhPerAreaFlow
  DATATYPE
    Float
  LONGFORM
    ExhaustPerAreaFlow
  DESCRIPTION
     "The outside air flow rate, in cfm, associated with the ExhPerArea input."  
  INPUTCLASS
    NotInput
  UNITS
    cfm
  DEFAULT
    if( IfValidAnd( ExhPerArea > 0 ) )
    then ExhPerArea * FlrArea
    else 0
    endif
  SIZING
    if( IfValidAnd( ExhPerArea > 0 ) )
    then ExhPerArea * FlrArea
    else 0
    endif
  ANNUAL
    z:ExhPerAreaFlow
ENDRULE

// ACH basis
RULE Spc:ExhACH
  DESCRIPTION
    "The design exhaust air flow rate, in ACH, for the Space."  
  INPUTCLASS
    Optional
  UNITS
    ACH
  MINIMUM
    0
  DEFAULT : T24N_2016
    if( LabArea > 0 .AND. IfValidAnd( VentACH > 0 ) )
    then VentACH
    else
    if( LocalCompAssigned( SpcFuncDefaultsRef ) .AND. LocalStatus( SpcFunc ) < 5 )
    then SpcFuncDefaultsRef:ExhACH
    else 0
    endif endif
  DEFAULT
    if( LocalCompAssigned( SpcFuncDefaultsRef ) .AND. LocalStatus( SpcFunc ) < 5 )
    then SpcFuncDefaultsRef:ExhACH
    else CodeExhACH
    endif
  SIZING_PROPOSED
    if( HasUnknownHVAC > 0 )
    then // Partial Envelope, use NACM exhaust rates
      CodeExhACH
    else ExhACH
    endif
  SIZING_BASELINE
    zp:ExhACH
  ANNUAL
    z:ExhACH
ENDRULE

RULE NEW Spc:ExhACHFlow
  DATATYPE
    Float
  LONGFORM
    ExhaustAirChangesPerHourFlow
  DESCRIPTION
     "The exhaust flow rate, in cfm, associated with the ExhACH input."  
  INPUTCLASS
    NotInput
  UNITS
    cfm
  DEFAULT
    if( IfValidAnd( ExhACH > 0 ) )
    then ExhACH * Vol / 60
    else 0
    endif
  SIZING
    if( IfValidAnd( ExhACH > 0 ) )
    then ExhACH * Vol / 60
    else 0
    endif
  ANNUAL
    z:ExhACHFlow
ENDRULE

RULE Spc:ExhContPerFixture
  DESCRIPTION
    "The continuous exhaust air flow rate per fixture (toilet, showerhead, etc)."
  INPUTCLASS : T24N_2016
    NotInput
  INPUTCLASS
    Optional
  UNITS
    cfm
  DEFAULT : T24N_2016
    0
  DEFAULT
    if( IfValidAnd( IsIntrmtExh > 0 ) )
    then 0
    else
    if( LocalCompAssigned( SpcFuncDefaultsRef ) .AND. LocalStatus( SpcFunc ) < 5 )
    then SpcFuncDefaultsRef:ExhContPerFixture
    else CodeExhContPerFixture
    endif endif
ENDRULE

RULE Spc:ExhNumFixtures
  DESCRIPTION
    "The number of fixtures in the space for fixture-dependent exhaust
     (toilets, showerheads, etc)."
  INPUTCLASS : T24N_2016
    NotInput
  INPUTCLASS
    Optional
  DEFAULT
    if( LocalCompAssigned( SpcFuncDefaultsRef ) .AND. LocalStatus( SpcFunc ) < 5 )
    then SpcFuncDefaultsRef:ExhNumFixtures
    else 0
    endif
  CHECKCODE
    if( IfValidAnd( CodeExhContPerFixture > 0 ) .AND.
        IfValidAnd( IsIntrmtExh = 0 ) .AND.
        IfValidAnd( ExhNumFixtures = 0 ) )
    then
      PostError("Space '%s' has a VentilationSpaceFunction specified that has
                 exhaust flow requirement based on the number of fixtures, but 
                 0 fixtures has been specified.", Name)
    else UNCHANGED
    endif
ENDRULE

RULE Spc:IsIntrmtExh
  DESCRIPTION
    "A flag that indicates the exhaust system is intermittent. 
     (toilet, showerhead, etc)."
  HELP
    "If the space requires exhaust but it can be an intermittentantly operating system, 
     checking this flag zeros out the default calculated exhaust and removes the requirement 
     to model an exhaust system. 
     However, if the proposed model still has a user-specified non-zero TOTAL exhaust flow
     specified for the space, an exhaust system must be defined. Set the exhaust flow to 0 to
     to eliminate the requirement to modeling it."
  INPUTCLASS
    Optional
  DEFAULT
    0
ENDRULE

RULE Spc:ExhPerSpc
  DESCRIPTION
    "The design exhaust air flow rate, in cfm, for the Space."  
  INPUTCLASS
    Optional
  UNITS
    cfm
  MINIMUM
    0   
  DEFAULT : T24N_2016
    if( PrkgGarArea = 0 .AND. LabArea = 0 .AND. 
        IfValidAnd( PropVentSysIsExh > 0 ) )
    then VentFlow
    else
    if( LocalCompAssigned( SpcFuncDefaultsRef ) .AND. LocalStatus( SpcFunc ) < 5 )
    then SpcFuncDefaultsRef:ExhPerSpc
    else 0
    endif endif
  DEFAULT
    if( IfValidAnd( CodeExhContPerFixture > 0 ) )
    then ExhNumFixtures * ExhContPerFixture
    else
    if( LocalCompAssigned( SpcFuncDefaultsRef ) .AND. LocalStatus( SpcFunc ) < 5 )
    then SpcFuncDefaultsRef:ExhPerSpc
    else CodeExhPerSpc
    endif endif
  SIZING_PROPOSED
    if( HasUnknownHVAC > 0 )
    then // Partial Envelope, use NACM exhaust rates
      CodeExhPerSpc
    else ExhPerSpc
    endif
  SIZING_BASELINE
    zp:ExhPerSpc
  ANNUAL
    z:ExhPerSpc
ENDRULE

// Not yet supported
;RULE Spc:ExhIntrmtPerFixture
;  DESCRIPTION
;    "The design intermittant exhaust air flow rate per fixture 
;     (toilet, showerhead, etc)."
;  INPUTCLASS
;    Optional
;  UNITS
;    cfm
;  DEFAULT : T24N_2016
;    0
;  DEFAULT : T24N
;    // Used for toilet and shower rooms
;    if( LocalCompAssigned( SpcFuncDefaultsRef ) .AND. LocalStatus( SpcFunc ) < 5 )
;    then SpcFuncDefaultsRef:ExhIntrmtPerFixture
;    else CodeExhIntrmtPerFixture
;    endif
;ENDRULE


// ********** Design Exhaust Flow Rates ************************************
// User-input
RULE Spc:ExhFlow
  DESCRIPTION
    "The design exhaust air flow rate for the Space."  
  HELP
    "For general exhaust, the design exhasut air flow rate is the sum of all the 
     individual exhaust inputs (cfm/ft2, ACH, and cfm)."  
  INPUTCLASS : T24N_2016
    NotInput
  INPUTCLASS
    Default  
  UNITS
    cfm
  DEFAULT
    if( IsProcExhSpc > 0 .AND. 
        HasProcExh > 0 .AND. 
        TotKitExhHoodFlow > 0 )
    then // Use kitchen hood inputs
      TotKitExhHoodFlow
    else // Sum exhaust components using Maximum or Sum, depending on VentSpecMthd
    if( ExhSpecMthd = "Maximum" )
    then
      Max( Max( ExhPerAreaFlow, ExhACHFlow ) , ValidOr( ExhPerSpc, 0 ) )
    else // Sum of all user inputs
      ExhPerAreaFlow + ExhACHFlow + ValidOr( ExhPerSpc, 0 )
    endif endif
  CHECKCODE : T24N_2016
      if( CondgType = "Unconditioned" .AND. 
          HasExhSys .AND. ExhFlow > 0 .AND.
          PrkgGarArea = 0 )   
      then 
        PostWarning("Space '%s' is 'Unconditioned', but has exhaust flow
                     defined. The exhaust flow and system serving the space's zone
                     will be simulated the same in the proposed and standard
                     design.", Name) 
      else if( HasProcExh > 0 .AND. LabArea > 0 .AND. 
               ExhFlow < CodeExhFlow * ( 1 - Proj:ExhTolMinLimNonRes ))
      then 
        PostWarning("Space '%s' is Laboratory, but the user-specified exhaust flow rate
                   is less than the required amount for the specified 'Lab Exhaust Type'.",
                   Name)
      else UNCHANGED
      endif endif   
  CHECKCODE : T24N
      if( CondgType = "Unconditioned" .AND. 
          HasExhSys .AND. ExhFlow > 0 .AND.
          PrkgGarArea = 0 )   
      then 
        PostWarning("Space '%s' is 'Unconditioned', but has exhaust flow
                     defined. The exhaust flow and system serving the space's zone
                     will be simulated the same in the proposed and standard
                     design.", Name) 
      else 
      if( LabArea > 0 .AND. 
          ExhFlow < CodeExhFlow * ( 1 - Proj:ExhTolMinLimNonRes ))
      then 
        PostError("Space '%s' is Laboratory, but the user-specified exhaust flow rate
                   is less than required by code.",
                   Name)
      else UNCHANGED
      endif endif     
  SIZING_PROPOSED : T24N_2016
    if( HasUnknownHVAC > 0 )
    then // Is Partial compliance w/ no mechanical (complete or addition)
      if( PropVentSysIsExh = 1 .AND. IsCond > 0 )
      then 0 // Proposed exhaust is for ventilation of a conditioned space
             // Baseline ventilation provided by system, so set exhaust to 0.
             // See issue 1698
      else
      if( PropVentSysIsExh = 2 )
      then // Baseline residential exhaust is the code ventilation flow
        CodeVentFlowTarget
      else 
        CodeExhFlow 
      endif endif
// Issue 2139: remove minimum exhaust flow requirement.
;   else if( HasProcExh .AND. LabArea > 0 .AND. ExhFlow < CodeExhFlow )
;   then // ExhFlow must be at least the CodeExhFlow for Lab
;     Max( ExhFlow, CodeExhFlow )
    else if( PropVentSysIsExh > 0 )
    then Max( VentFlow, ExhFlow )
    else ExhFlow
    endif endif
  SIZING_PROPOSED : T24N
    if( HasUnknownHVAC > 0 )
    then // Is Partial compliance w/ no mechanical (complete or addition)
      if( PropVentSysIsExh = 2 .OR. PropVentSysIsExh = 3 )
      then // Baseline residential exhaust is the code ventilation flow
        CodeVentFlow
      else 
        CodeExhFlow 
      endif
    else
    if( PropVentSysIsExh > 0 )
    then // Prop vent is by exhaust, use the larger of the two inputs
       Max( VentFlow, ExhFlow )
    else 
    if( IsHighRiseRes > 0 .OR. IsHotelMotelGuestRm > 0 )
    then // Set to 0 since exhaust should not be modeled unless it meets criteria above
         // This was revised to use user value to model more complex systems
         // See ticket 3040 3233 3265
      ExhFlow
    else // Use user value
      ExhFlow
    endif endif endif
  SIZING_BASELINE : T24N
    if( HasUnknownHVAC > 0 .OR. IsExistingHVAC > 0 .OR. HlthCareArea > 0 )
    then // Baseline = proposed
      zp:ExhFlow 
    else 
    if( IfValidAnd( PrkgGarArea > 0 ) .OR. IfValidAnd( LabArea > 0 ) )
    then // Standard Design = Proposed for parking and labs
      zp:ExhFlow
    else 
    if( BaseVentSysIsExh = 2 )
    then // Baseline high-rise residential is exhaust for ventilation, limit Res limit
      Min( Max( VentFlow, ExhFlow ), 
           Max( CodeVentFlowTarget, CodeVentFlow * ( 1 + Proj:VentTolMaxLimRes ) ) )
    else
    if( BaseVentSysIsExh = 3 )
    then // Is an exhaust system that has direct outside air make-up
         // For baseline, this includes H/M guestrooms.
      Min( Max( VentFlow, ExhFlow ), 
           Max( CodeVentFlowTarget, CodeVentFlow * ( 1 + Proj:VentTolMaxLimNonRes ) ) )
    else
    if( CodeExhFlow > 0 )
    then // Use code value
      Min( ExhFlow, CodeExhFlow * ( 1 + Proj:ExhTolMaxLimNonRes ) )
    else
    if( zp:PropVentSysIsExh > 0 .AND. IsCond > 0 )
    then // Proposed exhaust is for ventilation of a conditioned space
         // Baseline ventilation provided by system, so set exhaust to 0.
         // See issue 1698, 3125
      0
    else // Same as user design for all other spaces
      zp:ExhFlow
    endif endif endif endif endif
    endif
  SIZING_PROPOSED : S901G ECBC
    if( HasProcExh > 0 .AND. LabArea > 0 .AND. ExhFlow < CodeExhFlow )
    then // ExhFlow must be at least the CodeExhFlow for Lab
      Max( ExhFlow, CodeExhFlow )
    else ExhFlow
    endif
  SIZING_BASELINE : S901G ECBC
    zp:ExhFlow
  ANNUAL
    z:ExhFlow
ENDRULE

RULE NEW Spc:ExhFlowWithMult
  DATATYPE
    Float
  LONGFORM
    ExhaustFlowWithMultiplier
  DESCRIPTION
    "The design exhaust air flow rate, with the space multiplier."
  INPUTCLASS
    NotInput
  UNITS
    cfm
  DEFAULT
    ExhFlow * Mult
ENDRULE

RULE Spc:PropMinExhFlow
  DESCRIPTION
    "The proposed minimum exhaust air flow rate for the Space." 
  HELP
    "Currently only supported for VAV laboratory systems." 
  INPUTCLASS : T24N_2016
    NotInput
  INPUTCLASS
    Default  
  UNITS
    cfm
  DEFAULT : T24N_2016
    UNDEFINED
  DEFAULT
    if( LabArea > 0 )
    then Min( ValidOr( PropMinExhACH, 0 ) * ValidOr( Vol, 0 ) / 60, ExhFlow )
    else UNDEFINED
    endif    
ENDRULE

RULE Spc:LabOtherExhFlow
  DESCRIPTION
    "The total design exhaust air flow of all other laboratory exhaust 
     devices, in the Space."
  HELP
    "This total includes the flow of all other devices, such as hoods with
     horizontal sashes, snorkels, cabinets etc, but excludes the flow of 
     fume hoods with vertical sashes."
  INPUTCLASS
    NotInput
  MINIMUM
    0
  UNITS
    cfm
  DEFAULT : T24N_2016
    UNDEFINED
  DEFAULT
    if( LabArea > 0 ) 
    then Max( ValidOr( ExhFlow, 0 ) - ValidOr( LabFumeHoodVertSashExhFlow, 0 ) , 0 )
    else 0
    endif
ENDRULE

// Code minimum
RULE NEW Spc:CodeExhFlow
  DATATYPE
    Float
  LONGFORM
    CodeExhaustFlow  
  DESCRIPTION
    "The code minimum exhaust air flow rate for the Space."  
  INPUTCLASS
    NotInput
  UNITS
    cfm
  DEFAULT
    if( HasProcExh > 0 .AND. IsProcExhSpc > 0 )
    then // Baseline = proposed for 'Other'
      if( CommKitArea > 0 .AND. IfValidAnd( TotKitExhHoodFlow > 0 ) )
      then 
        if( IfValidAnd( Bldg:TotKitExhHoodFlow > 5000 ) )
        then 
          // Total building kitchen hood exhaust flow is > 5000 cfm
          // Baseline hood exhaust flow is modeled using the maximum in Table 140.9
          MaxTotKitExhHoodFlow
        else // Baseline = proposed kitchen hood flow
          TotKitExhHoodFlow
        endif
      else // Baseline = proposed exh flow
        ExhFlow
      endif
    else
    if( ExhSpecMthd = "Maximum" )
    then 
      Max( Max( CodeExhPerAreaFlow, CodeExhACHFlow ), CodeExhPerSpc )
    else 
      CodeExhPerAreaFlow + CodeExhACHFlow + CodeExhPerSpc
    endif endif
ENDRULE

// 'Other' code minimum
RULE NEW Spc:CodeOtherExhFlow
  DATATYPE
    Float
  LONGFORM
    CodeOtherExhaustFlow  
  DESCRIPTION
    "The 'Other' design exhaust air flow rate for the Space."
  INPUTCLASS
    NotInput
  UNITS
    cfm
  DEFAULT
    if( VentSrc = "None" .OR. VentStd != "Other" )
    then 0
    else 
    if( HasProcExh > 0 .AND. IsProcExhSpc > 0 )
    then // Baseline = proposed for 'Other'
      if( CommKitArea > 0 .AND. IfValidAnd( TotKitExhHoodFlow > 0 ) )
      then // Baseline = proposed kitchen hood flow
        TotKitExhHoodFlow
      else // Baseline = proposed exh flow
        ExhFlow
      endif
    else
    if( ExhSpecMthd = "Maximum" )
    then 
      Max( Max( CodeExhPerAreaFlow, CodeExhACHFlow ), CodeExhPerSpcFlow )
    else 
      CodeExhPerAreaFlow + CodeExhACHFlow + CodeExhPerSpcFlow
    endif endif endif
ENDRULE

// Calculate exhaust flows for BuildingStory calculations
RULE NEW Spc:ExhFlowForBal
  DATATYPE
    Float
  LONGFORM 
    ExhaustFlowForBalance
  INPUTCLASS 
    NotInput
  UNITS
    cfm
  DEFAULT
    if( VentStd != "Other" )  
    then
      if( HasUnknownHVAC > 0 )
      then ExhFlow * IncludeInBal
      else ExhFlow * IncludeInBal * HasExhSys
      endif
    else 0
    endif
  ANNUAL
    if( VentStd != "Other" )
    then ExhFlow * IncludeInBal * HasExhSys
    else 0
    endif
ENDRULE

RULE NEW Spc:OtherExhFlowForBal
  DATATYPE
    Float
  LONGFORM 
    OtherExhaustFlowForBalance
  INPUTCLASS 
    NotInput
  UNITS
    cfm
  DEFAULT
    if( VentStd = "Other" )  
    then
      if( HasUnknownHVAC > 0 )
      then ExhFlow * IncludeInBal
      else ExhFlow * IncludeInBal * HasExhSys
      endif
    else 0
    endif
  ANNUAL
    if( VentStd = "Other" )
    then ExhFlow * IncludeInBal * HasExhSys
    else 0
    endif
ENDRULE

// Calculate code exhaust flows for BuildingStory calculations
RULE NEW Spc:CodeExhFlowForBal
  DATATYPE
    Float
  LONGFORM 
    CodeExhaustFlowForBalance
  INPUTCLASS 
    NotInput
  UNITS
    cfm
  DEFAULT
    if( VentStd != "Other" )  
    then
      if( HasUnknownHVAC > 0 )
      then CodeExhFlow * IncludeInBal
      else CodeExhFlow * IncludeInBal * HasExhSys
      endif
    else 0
    endif
  ANNUAL
    if( VentStd != "Other" )
    then CodeExhFlow * IncludeInBal * HasExhSys
    else 0
    endif
ENDRULE

RULE NEW Spc:CodeOtherExhFlowForBal
  DATATYPE
    Float
  LONGFORM 
    CodeOtherExhaustFlowForBalance
  INPUTCLASS 
    NotInput
  UNITS
    cfm
  DEFAULT
    if( VentStd = "Other" )  
    then
      if( HasUnknownHVAC > 0 )
      then CodeOtherExhFlow * IncludeInBal
      else CodeOtherExhFlow * IncludeInBal * HasExhSys
      endif
    else 0
    endif
  ANNUAL
    if( VentStd = "Other" )
    then CodeOtherExhFlow * IncludeInBal * HasExhSys
    else 0
    endif
ENDRULE

RULE NEW Spc:VentExhBalFlow
  DATATYPE
    Float
  LONGFORM 
    VentilationExhaustBalanceFlow
  INPUTCLASS 
    NotInput
  UNITS
    cfm
  DEFAULT
    if( LabArea > 0 .OR. PrkgGarArea > 0 )
    then 0
    else Max( ExhFlow - VentFlow, 0 )
    endif
  SIZING
    if( LabArea > 0 .OR. PrkgGarArea > 0 )
    then 0
    else Max( ExhFlow - VentFlow, 0 )
    endif
ENDRULE


// ----------------------------------------------------------------------------
// For Reporting
// Calculate ventilation flows in other units for reference
// Proposed design
RULE NEW Spc:DsgnExhPerArea
  DATATYPE
    Float
  LONGFORM
    DesignExhaustPerArea
  DESCRIPTION
    "The design exhaust air flow rate, in ACH, for the Space."  
  INPUTCLASS
    NotInput
  UNITS
    cfm/ft2
  DEFAULT
    if( IfValidAnd( FlrArea > 0 ) )
    then ExhFlow / FlrArea
    else 0
    endif
  SIZING
    if( IfValidAnd( FlrArea > 0 ) )
    then ExhFlow / FlrArea
    else 0
    endif
  ANNUAL
    z:DsgnExhPerArea
ENDRULE

RULE NEW Spc:DsgnExhACH
  DATATYPE
    Float
  LONGFORM
    DesignExhaustAirChangesPerHour
  DESCRIPTION
    "The design exhaust air flow rate, in ACH, for the Space."  
  INPUTCLASS
    NotInput
  UNITS
    ACH
  DEFAULT
    if( IfValidAnd( Vol > 0 ) )
    then ExhFlow * 60 / Vol
    else 0
    endif
  SIZING
    if( IfValidAnd( Vol > 0 ) )
    then ExhFlow * 60 / Vol
    else 0
    endif
  ANNUAL
    z:DsgnExhACH
ENDRULE

// Code baseline
RULE NEW Spc:CodeDsgnExhPerArea
  DATATYPE
    Float
  LONGFORM
    CodeDesignExhaustPerArea
  DESCRIPTION
    "The quantity of code minimum required exhaust air for the Space, 
     in cfm/ft2 (for reference only)."
  INPUTCLASS
    NotInput
  UNITS 
    cfm/ft2
  DEFAULT
    if( IfValidAnd( FlrArea > 0 ) )
    then
      if( VentStd = "Other" )
      then CodeOtherExhFlow / FlrArea
      else CodeExhFlow / FlrArea
      endif
    else 0
    endif
ENDRULE

RULE NEW Spc:CodeDsgnExhACH
  DATATYPE
    Float
  LONGFORM
    CodeDesignExhaustAirChangesPerHour
  DESCRIPTION
    "The quantity of code minimum required exhaust air for the Space, 
     in ACH (for reference only)."
  INPUTCLASS
    NotInput
  UNITS 
    cfm
  DEFAULT
    if( IfValidAnd( Vol > 0 ) )
    then
      if( VentStd = "Other" )
      then CodeOtherExhFlow * 60 / Vol 
      else CodeExhFlow * 60 / Vol 
      endif
    else 0
    endif   
ENDRULE


// -------------- Infiltration Method [2] --------------------------------------
// Used for exhaust-driven or natural ventilation
RULE Spc:InfMthd[2]
  DESCRIPTION
    "The method used to calculate an infiltration rate that represents the 
     outdoor air for spaces served by exhaust ventilation systems."
;  OPTION     Specified in BEMEnums
;    FlowSpace
;    FlowArea
;    FlowExteriorArea
;    FlowExteriorWallArea
;    AirChangesPerHour
  INPUTCLASS
    NotInput  IgnoreUserInput  "Spc:InfMthd[2] no longer an allowed input as of version 2016.1.0 / 2013 v3d"
  SIZING_PROPOSED : T24N_2016
    if( PropVentSysIsExh > 0 // Proposed has unconditioned or res exhaust
        .OR. 
        ( IsRes > 0 .AND. IsCond > 0 .AND. ThrmlZnRef:VentSrc = "Natural" ) ) // Proposed uses natural ventilation
    then "FlowSpace"
    else UNDEFINED
    endif
  SIZING_PROPOSED
    if( IsHotelMotelGuestRm > 0 .AND. IsCond > 0 .AND. ThrmlZnRef:VentSrc = "Natural" ) 
    then // Proposed uses natural ventilation
      "FlowSpace"
    else
    if( PropVentSysIsExh > 1 )
    then // HRR or Hotel/Motel or Parking Garage
      "FlowSpace"
    else
    if( PropVentSysIsExh = 1 .OR. Max( TotExhFlow - MechOAFlow, 0 ) > 0 )
    then // General exhaust-based ventilation system or has exhaust that requires direct makeup
      if( ThrmlZnRef:ExhSrc = "DirectOutsideAir" .OR.
          Story:OAExhBalRat < ( 1 - Proj:BalancedVentTolNonRes ) )
      then "FlowSpace"
      else UNDEFINED
      endif
    else UNDEFINED
    endif endif endif
  SIZING_BASELINE : T24N_2016
    if( HasUnknownHVAC > 0 .OR. IsExistingHVAC > 0 )
    then // Baseline = proposed
      zp:InfMthd[2]
    else
    if( PropVentSysIsExh > 0 .OR. 
        ( IsRes > 0 .AND. IsCond > 0 ) )
    then "FlowSpace" // Baseline residential ventilation system is exhaust
    else UNDEFINED
    endif endif
  SIZING_BASELINE
    if( CondgType = "Unconditioned" .OR. HasUnknownHVAC > 0 .OR. IsExistingHVAC > 0 )
    then // Baseline = proposed
      zp:InfMthd[2]
    else
    if( IsHotelMotelGuestRm > 0 .AND. IsCond > 0 .AND. ThrmlZnRef:VentSrc = "Natural" ) // Proposed uses natural ventilation
    then "FlowSpace"
    else
    if( BaseVentSysIsExh > 1 )
    then // All other options have 'DirectOutsideAir' w/ inf = vent
      "FlowSpace"
    else
    if( BaseVentSysIsExh = 1 .OR. Max( TotExhFlow - MechOAFlow, 0 ) > 0 )
    then // General exhaust-based ventilation system or has exhaust that requires direct makeup
      if( ThrmlZnRef:ExhSrc = "DirectOutsideAir" .OR.
          Story:OAExhBalRat < ( 1 - Proj:BalancedVentTolNonRes ) )
      then "FlowSpace"
      else UNDEFINED
      endif
    else UNDEFINED
    endif endif endif endif
  ANNUAL
    z:InfMthd[2]
ENDRULE

RULE Spc:DsgnInfRt[2]
  DESCRIPTION
    "The infiltration rate for the space."
  HELP
    "The units for this property depend on the Spc:InfMthd. 
    
    InfMthd = 'FlowSpace', unit is cfm.
    InfMthd = 'AirChangesPerHour', unit is ACH
    All others, unit is cfm/SF"
  INPUTCLASS
    NotInput  IgnoreUserInput  "Spc:DsgnInfRt[2] no longer an allowed input as of version 2016.1.0 / 2013 v3d"
  MINIMUM
    0
  SIZING_PROPOSED : T24N_2016
    if( LocalStatus( InfMthd[2] ) > 0 )
    then Max( ExhFlow, VentFlow )
    else UNDEFINED
    endif
  SIZING_PROPOSED
    if( LocalStatus( InfMthd[2] ) > 0 )
    then
      if( ThrmlZnRef:VentSrc = "Natural" )
      then // For hotel/motel only 
        VentFlow
// This adjustment to space infiltration no longer used after 2019 v2.0 since heat recovery is modeled explicitly
;      else
;      if( IfValidAnd( VentSysRef:ExhSysType = "HeatRecovery" ) )
;      then // Proposed is VentOnly w/ HtRcvry, simulate 1 - Eff of flow to approx impact
;        ExhFlow * ( 1 - ThrmlZnRef:VentSysRef:HtRcvryEffSim )
      else // Make-up for the exhaust air
        Max( TotExhFlow - MechOAFlow, 0 )
      endif
    else UNDEFINED
    endif
  SIZING_BASELINE : T24N_2016
    if( LocalStatus( InfMthd[2] ) > 0 )
    then ExhFlow
    else UNDEFINED
    endif
  SIZING_BASELINE
    if( LocalStatus( InfMthd[2] ) > 0 )
    then
      if( ThrmlZnRef:VentSrc = "Natural" )
      then // Natural only available for hotel/motel
        VentFlow
      else
      if( HasUnknownHVAC > 0 .OR. IsExistingHVAC > 0 .OR. HlthCareArea > 0 .OR.
          IfValidAnd( PrkgGarArea > 0 ) .OR. IfValidAnd( LabArea > 0 ) )
      then // Baseline = proposed
      zp:DsgnInfRt[2]         
      else // Exh&Vent should be the same, but use exh just to be consistent with inputs
        ExhFlow
      endif endif
    else UNDEFINED
    endif
  ANNUAL
    z:DsgnInfRt[2]
ENDRULE

RULE Spc:InfSchRef[2]
  DESCRIPTION
    "The schedule that defines the hourly multiplier on the infiltration flow."
  INPUTCLASS
    NotInput  IgnoreUserInput  "Spc:InfSchRef[2] no longer an allowed input as of version 2016.1.0 / 2013 v3d"
  SIZING : T24N_2016
    if( LocalStatus( InfMthd[2] ) > 0 )
    then
      RuleLibrary( Schedule, "On" )
    else UNDEFINED
    endif
  SIZING
    if( LocalStatus( InfMthd[2] ) > 0 )
    then 
      RuleLibrary( Schedule, 
                   SpaceFunctionGroups:AvailSchRef("FuncGroup", FuncSchGrpSim) )
    else UNDEFINED
    endif
  ANNUAL
    z:InfSchRef[2]
ENDRULE

RULE Spc:InfModelCoefA[2]
  DESCRIPTION
    "The constant coefficient in the infiltration rate calculation equation"
  INPUTCLASS
    NotInput  IgnoreUserInput  "Spc:InfModelCoefA[2] no longer an allowed input as of version 2016.1.0 / 2013 v3d"
  MINIMUM
    0
  SIZING
    if( LocalStatus( InfMthd[2] ) > 0 )
    then 1.0
    else UNDEFINED
    endif
  ANNUAL
    z:InfModelCoefA[2]
ENDRULE

RULE Spc:InfModelCoefB[2]
  DESCRIPTION
    "The temperature coefficient in the infiltration rate calculation equation."
  INPUTCLASS
    NotInput  IgnoreUserInput  "Spc:InfModelCoefB[2] no longer an allowed input as of version 2016.1.0 / 2013 v3d"
  MINIMUM
    0
  UNITS
    1/F
  SIZING
    if( LocalStatus( InfMthd[2] ) > 0 )
    then 0
    else UNDEFINED
    endif
  ANNUAL
    z:InfModelCoefB[2]
ENDRULE

RULE Spc:InfModelCoefC[2]
  DESCRIPTION
    "The windspeed coefficient in the infiltration rate calculation equation."
  INPUTCLASS
    NotInput  IgnoreUserInput  "Spc:InfModelCoefC[2] no longer an allowed input as of version 2016.1.0 / 2013 v3d"
  MINIMUM
    0
  UNITS
    1/mph
  SIZING
    if( LocalStatus( InfMthd[2] ) > 0 )
    then 0
    else UNDEFINED
    endif
  ANNUAL
    z:InfModelCoefC[2]
ENDRULE

RULE Spc:InfModelCoefD[2]
  DESCRIPTION
    "The windspeed squared coefficient in the infiltration rate calculation equation."
  INPUTCLASS
    NotInput  IgnoreUserInput  "Spc:InfModelCoefD[2] no longer an allowed input as of version 2016.1.0 / 2013 v3d"
  MINIMUM
    0
  UNITS
    1/mph2
  SIZING
    if( LocalStatus( InfMthd[2] ) > 0 )
    then 0
    else UNDEFINED
    endif
  ANNUAL
    z:InfModelCoefD[2]
ENDRULE
